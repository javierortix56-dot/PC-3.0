<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Finanzas J&M | V10 Final</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#0e757c", "primary-dark": "#085055", "surface": "#ffffff", "success": "#15803d", "danger": "#b91c1c", "warning": "#b45309" },
                    fontFamily: { "display": ["Manrope", "sans-serif"], "body": ["Manrope", "sans-serif"] }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Manrope', sans-serif; background-color: #f8fafc; }
        .glass-sidebar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-right: 1px solid #e2e8f0; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hidden-view { display: none !important; }
        .active-nav { background-color: rgba(14, 117, 124, 0.08); color: #0e757c; border-right: 3px solid #0e757c; }
        .d-picker { position: absolute; inset:0; opacity:0; cursor: pointer; width: 100%; }
        
        .compact-row { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
        .compact-row:last-child { border-bottom: none; }
        .compact-row:hover { background-color: #f8fafc; }
        .compact-row.selected { background-color: #f0f9ff; border-left: 3px solid #0e757c; }
        
        .chip { border: 1px solid #e2e8f0; background: white; color: #475569; font-size: 11px; font-weight: 600; transition: all 0.1s; border-radius: 20px; }
        .chip:hover { border-color: #0e757c; color: #0e757c; }
        .chip.active { background: #0e757c; color: white; border-color: #0e757c; box-shadow: 0 2px 4px rgba(14,117,124,0.3); }
        
        .cat-tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: #f1f5f9; color: #64748b; border: 1px solid transparent; }
        .cat-tag:hover { border-color: #cbd5e1; color: #334155; background: white; }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .tc-input { -moz-appearance: textfield; background: transparent; border: none; padding: 0 4px; margin: 0; font-weight: 700; color: #334155; text-align: right; width: 90px; font-size: 12px; height: 100%; }
        .tc-input:focus { outline: none; ring: 0; border-bottom: 1px solid #0e757c; }
        
        /* Checkbox Styles */
        .custom-chk { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #cbd5e1; display:flex; align-items:center; justify-content:center; transition:0.2s; cursor: pointer; }
        .custom-chk:hover { border-color: #0e757c; }
        .custom-chk.checked { background: #0e757c; border-color: #0e757c; }
        .custom-chk.checked i { display:block; }
        .custom-chk.exec { border-color: #15803d; background: transparent; }
        .custom-chk.exec i { display:block; color: #15803d; font-weight: 900; }
        .custom-chk i { color:white; font-size:10px; display:none; }

        /* Split & Bulk UI */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .split-row { border-left: 2px solid #e2e8f0; margin-left: 28px; padding-left: 8px; }
        .split-input-row { display: grid; grid-template-columns: 1.2fr 1.5fr 1fr auto; gap: 4px; align-items: center; margin-bottom: 4px; }
        
        #bulkBar { transition: transform 0.3s ease-out; transform: translate(-50%, 100px); }
        #bulkBar.show { transform: translate(-50%, 0); display: flex; }
        
        .alert-card { transition: all 0.2s; }
        .alert-card:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>

<body class="text-slate-900 h-screen flex overflow-hidden selection:bg-primary/20">

    <aside class="glass-sidebar w-16 hover:w-64 transition-all duration-300 group fixed h-screen z-40 flex flex-col justify-between py-4 shadow-xl">
        <div class="flex flex-col gap-6">
            <div class="flex items-center justify-center h-10 px-2 group-hover:justify-start group-hover:px-4 transition-all">
                <div class="bg-primary size-8 rounded-lg flex items-center justify-center text-white shrink-0 shadow-md">
                    <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                </div>
                <h1 class="font-bold text-sm text-primary ml-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap overflow-hidden delay-75 tracking-tight">Finanzas J&M</h1>
            </div>

            <nav class="flex flex-col gap-1 px-2" id="main-nav">
                <button onclick="nav('dashboard', this)" id="nav-dashboard" class="active-nav flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">dashboard</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Operaciones</span>
                </button>
                <button onclick="nav('networth', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">savings</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Patrimonio</span>
                </button>
                <button onclick="nav('analytics', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">query_stats</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Análisis</span>
                </button>
                <button onclick="nav('admin', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">settings</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Ajustes</span>
                </button>
                <button onclick="forceSync()" class="flex items-center h-10 rounded-lg px-2 text-primary hover:bg-slate-100 transition-colors w-full overflow-hidden mt-2 border-t border-slate-100 pt-2" title="Forzar Sincronización">
                    <span class="material-symbols-outlined text-xl shrink-0" id="syncIcon">cloud_sync</span>
                    <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Sincronizar</span>
                </button>
            </nav>
        </div>

        <div class="px-2" id="newBtnContainer">
            <button onclick="openModal()" class="flex items-center justify-center w-full h-10 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-lg transition-all mb-4 group-hover:justify-start group-hover:px-3">
                <span class="material-symbols-outlined text-xl">add</span>
                <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Nuevo</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 ml-16 p-4 lg:p-6 h-screen overflow-hidden relative flex flex-col">
        
        <header class="flex justify-between items-center mb-3 shrink-0 gap-4 h-header-el">
            <div class="flex items-center gap-4 h-full">
                <h2 class="text-xl font-extrabold tracking-tight text-slate-800 leading-none" id="pageTitle">Panel</h2>
                
                <div class="flex items-center gap-1 bg-white px-2 rounded-md border border-slate-200 shadow-sm transition-colors relative group h-full">
                    <button onclick="changeMonth(-1)" class="text-slate-400 hover:text-primary flex items-center px-1"><span class="material-symbols-outlined text-sm">chevron_left</span></button>
                    <div class="relative min-w-[100px] text-center flex items-center justify-center h-full gap-1">
                        <span class="material-symbols-outlined text-xs text-slate-400 hidden" id="lockIcon" title="Mes Cerrado">lock</span>
                        <span class="text-[11px] font-bold uppercase text-slate-600 tracking-wide" id="monthTxt">...</span>
                        <input type="month" id="datePicker" class="d-picker" onchange="manualDate()">
                    </div>
                    <button onclick="changeMonth(1)" class="text-slate-400 hover:text-primary flex items-center px-1"><span class="material-symbols-outlined text-sm">chevron_right</span></button>
                    <div class="w-px h-4 bg-slate-200 mx-1"></div>
                    <button onclick="undo()" id="btnUndo" class="text-slate-400 hover:text-primary flex items-center px-1 btn-disabled" title="Deshacer (Ctrl+Z)"><span class="material-symbols-outlined text-sm">undo</span></button>
                    <button onclick="redo()" id="btnRedo" class="text-slate-400 hover:text-primary flex items-center px-1 btn-disabled" title="Rehacer (Ctrl+Y)"><span class="material-symbols-outlined text-sm">redo</span></button>
                </div>
            </div>
            
            <div class="flex items-center gap-3 bg-white px-3 rounded-md border border-slate-200 shadow-sm h-full shrink-0">
                <span class="material-symbols-outlined text-slate-400 text-sm">currency_exchange</span>
                <div class="flex items-center gap-2 border-r border-slate-100 pr-3 h-full">
                    <span class="text-[10px] font-bold text-slate-400">USD</span>
                    <div class="flex items-center h-full">
                        <span class="text-[10px] text-slate-300 mr-1">$</span>
                        <input type="number" id="rate_ARS" onchange="pushHistory(); saveMonthlyRates(); renderNetWorthView()" class="tc-input" placeholder="0">
                    </div>
                </div>
                <div class="flex items-center gap-2 h-full">
                    <span class="text-[10px] font-bold text-slate-400">COP</span>
                    <div class="flex items-center h-full">
                        <span class="text-[10px] text-slate-300 mr-1">$</span>
                        <input type="number" id="rate_COP" step="0.01" onchange="pushHistory(); saveMonthlyRates(); renderNetWorthView()" class="tc-input" placeholder="0">
                    </div>
                </div>
            </div>
        </header>

        <div id="view-dashboard" class="view-container animate-fade-in flex flex-col flex-1 min-h-0 gap-3 relative">
             <div id="dashboardAlerts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 shrink-0 empty:hidden"></div>
            
            <section class="grid grid-cols-4 gap-3 shrink-0">
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Balance Neto</p>
                    <h3 class="text-xl font-black text-slate-800 tracking-tight" id="k-bal">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Estimado USD</p>
                    <h3 class="text-lg font-bold text-primary" id="k-usd">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-success">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Ingresos</p>
                    <h3 class="text-lg font-bold text-success" id="k-inc">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-danger">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Gastos</p>
                    <h3 class="text-lg font-bold text-danger" id="k-exp">$0</h3>
                </div>
            </section>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-3 flex-1 min-h-0">
                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5"><span class="material-symbols-outlined text-success text-sm">arrow_circle_up</span> Ingresos</h4>
                        <span class="bg-success/10 text-success text-[9px] font-bold px-1.5 py-0.5 rounded-full" id="c-inc">0</span>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-0" id="list-inc"></div>
                </section>
                
                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <div class="flex items-center gap-2 flex-1 mr-2">
                            <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5 shrink-0">
                                <span class="material-symbols-outlined text-danger text-sm">arrow_circle_down</span> Gastos
                            </h4>
                            <input type="text" id="searchExpInput" oninput="filterExpList()" placeholder="Buscar..." class="w-full max-w-[100px] bg-white border-none text-[10px] rounded-md px-2 py-0.5 focus:ring-1 focus:ring-primary shadow-sm placeholder:text-slate-300">
                        </div>
                        <div class="flex items-center gap-1">
                             <button onclick="toggleSelectionMode()" id="btnSelectMode" class="text-slate-400 hover:text-primary transition-colors p-1" title="Seleccionar múltiple">
                                <span class="material-symbols-outlined text-base">check_box</span>
                             </button>
                             <span class="bg-danger/10 text-danger text-[9px] font-bold px-1.5 py-0.5 rounded-full" id="c-exp">0</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-0" id="list-exp"></div>
                </section>

                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5"><span class="material-symbols-outlined text-primary text-sm">pie_chart</span> Asignación</h4>
                    </div>
                    <div class="px-3 py-2 flex justify-between gap-4 border-b border-slate-100 bg-white items-center" id="allocControls">
                        <button onclick="autoAssign()" class="text-[10px] font-bold text-slate-500 hover:text-primary transition-colors flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">auto_fix_high</span> Auto-Asignar
                        </button>
                        <button onclick="unassignAll()" class="text-[10px] font-bold text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">link_off</span> Desasignar Todo
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-2 flex flex-col gap-2" id="list-alloc"></div>
                </section>
            </div>

            <div id="bulkBar" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-6 z-50 animate-fade-in">
                <div class="flex flex-col">
                    <span class="text-xs font-bold" id="bulkCount">0 seleccionados</span>
                    <button onclick="selectAllVisible()" class="text-[10px] text-slate-400 hover:text-white underline text-left">Seleccionar todos</button>
                </div>
                <div class="h-8 w-px bg-slate-700"></div>
                <div class="flex items-center gap-3">
                    <button onclick="openBulkModal()" class="flex items-center gap-1 text-xs font-bold bg-primary/20 hover:bg-primary/40 px-3 py-1.5 rounded-lg transition-all">
                        <span class="material-symbols-outlined text-sm">edit_square</span> Acciones
                    </button>
                    <button onclick="bulkDelete()" class="flex items-center gap-1 text-xs font-bold bg-red-500/20 hover:bg-red-500/40 text-red-300 px-3 py-1.5 rounded-lg transition-all">
                        <span class="material-symbols-outlined text-sm">delete</span>
                    </button>
                </div>
                <button onclick="toggleSelectionMode()" class="text-slate-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
            </div>
        </div>

        <div id="view-networth" class="view-container animate-fade-in hidden-view flex flex-col flex-1 min-h-0 gap-3 relative">
            <section class="grid grid-cols-4 gap-3 shrink-0">
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-primary">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Patrimonio Neto (ARS)</p>
                    <h3 class="text-xl font-black text-slate-800 tracking-tight" id="nw-total">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">En Dólares</p>
                    <h3 class="text-lg font-bold text-primary" id="nw-usd">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Activos Totales</p>
                    <h3 class="text-lg font-bold text-success" id="nw-assets">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Pasivos Totales</p>
                    <h3 class="text-lg font-bold text-danger" id="nw-liabs">$0</h3>
                </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 flex-1 min-h-0">
                <div class="lg:col-span-2 glass-panel rounded-xl p-4 flex flex-col">
                    <h3 class="text-xs font-bold text-slate-700 mb-4">Evolución: Activos vs Pasivos</h3>
                    <div class="flex-1 min-h-0 relative">
                        <canvas id="chartNetWorth"></canvas>
                    </div>
                </div>
                <div class="flex flex-col gap-3 h-full overflow-hidden">
                    <div class="glass-panel rounded-xl p-4 flex flex-col h-1/3 min-h-[180px]">
                         <h3 class="text-xs font-bold text-slate-700 mb-2">Composición</h3>
                         <div class="flex-1 min-h-0 relative"><canvas id="chartNWComp"></canvas></div>
                    </div>
                    <div class="glass-panel rounded-xl flex flex-col overflow-hidden flex-1">
                        <div class="flex items-center justify-between px-3 py-3 border-b border-slate-100 bg-slate-50/50">
                            <h4 class="text-xs font-bold text-slate-700">Cuentas</h4>
                            <button onclick="openAccountModal()" class="text-[10px] font-bold text-primary hover:bg-primary/10 px-2 py-1 rounded transition-colors">+ CUENTA</button>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-0" id="list-accounts"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-analytics" class="view-container animate-fade-in hidden-view grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1 min-h-0">
             <div id="analyticsAlerts" class="col-span-1 lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-2 empty:hidden"></div>

            <div class="glass-panel rounded-xl p-4 flex flex-col h-[360px]">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-bold text-slate-700">Gastos por Categoría</h3><button onclick="resetCharts()" class="text-[10px] text-primary font-bold hover:underline hidden" id="resetBtn">VOLVER</button></div>
                <div class="flex items-center gap-4 flex-1 min-h-0 overflow-hidden"><div class="relative h-[200px] w-[200px] shrink-0"><canvas id="chartExp"></canvas></div><div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-1" id="legExp"></div></div>
            </div>
            <div class="glass-panel rounded-xl p-4 flex flex-col h-[360px]">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-bold text-slate-700">Ingresos por Concepto</h3></div>
                <div class="flex items-center gap-4 flex-1 min-h-0 overflow-hidden"><div class="relative h-[200px] w-[200px] shrink-0"><canvas id="chartInc"></canvas></div><div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-1" id="legInc"></div></div>
            </div>
        </div>

        <div id="view-admin" class="view-container animate-fade-in hidden-view grid grid-cols-1 lg:grid-cols-2 gap-2 flex-1 min-h-0 pt-1">
            <div class="glass-panel rounded-xl p-2 flex flex-col h-full overflow-hidden">
                <h3 class="text-xs font-bold text-slate-800 mb-2 flex items-center gap-2 px-1">
                    <span class="material-symbols-outlined text-base text-primary">folder_open</span> Gestión de Categorías
                </h3>
                <div class="flex gap-1 mb-2 bg-slate-50 p-1 rounded-lg border border-slate-100">
                    <input type="text" id="newCatName" placeholder="Nueva Categoría..." class="flex-1 bg-transparent border-none text-xs px-2 focus:ring-0 font-medium">
                    <select id="newCatType" class="bg-white border-none rounded-md text-[10px] px-2 py-1 text-slate-600 shadow-sm"><option value="exp">Gasto</option><option value="inc">Ingreso</option></select>
                    <button onclick="manualAddCat()" class="bg-slate-800 text-white size-6 rounded-md hover:bg-slate-700 flex items-center justify-center shadow-sm text-xs">+</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar pr-1" id="adminTreeContainer"></div>
            </div>
            <div class="glass-panel rounded-xl p-2 flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-center mb-2 px-1">
                    <h3 class="text-xs font-bold text-slate-800">Recurrentes</h3>
                    <div class="flex gap-2">
                        <button onclick="populateRecurringDefaults()" class="text-slate-400 text-[10px] font-bold hover:text-primary transition-colors">SUGERIR</button>
                        <button onclick="addRecurrenteRow()" class="bg-primary/10 text-primary px-2 py-0.5 rounded text-[10px] font-bold hover:bg-primary hover:text-white transition-colors">+ AGREGAR</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 rounded-lg border border-slate-100 p-1 mb-2" id="recurrente-table-body"></div>
                
                <div class="mt-auto border-t border-slate-100 pt-2">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="saveRecurrentesConfig()" class="py-1.5 rounded-lg bg-white border border-slate-200 text-slate-600 text-[10px] font-bold hover:bg-slate-50 shadow-sm">Guardar Recurrentes</button>
                        <button onclick="executeRecurrentes()" class="py-1.5 rounded-lg bg-slate-800 text-white text-[10px] font-bold hover:bg-slate-700 shadow-sm">Ejecutar Mes</button>
                    </div>

                    <div class="bg-slate-100 p-3 rounded-lg flex flex-col gap-2">
                        <div class="flex items-center justify-between">
                            <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Control Mensual</span>
                            <div id="monthStatusBadge" class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-slate-200 text-slate-500">ABIERTO</div>
                        </div>
                        <div class="flex items-center justify-between">
                             <div class="flex flex-col">
                                <span class="text-[9px] text-slate-500">Resultado</span>
                                <span class="text-xs font-bold text-slate-700" id="monthCloseBalance">...</span>
                             </div>
                             <div id="monthActionContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button id="fabNew" onclick="openModal()" class="fixed bottom-6 right-6 size-12 bg-slate-900 text-white rounded-xl shadow-xl shadow-slate-900/30 flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-50">
        <span class="material-symbols-outlined text-2xl">add</span>
    </button>

    <div id="modalOverlay" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[380px] max-h-[90vh] overflow-hidden flex flex-col mx-4 animate-fade-in">
            <div class="p-5 flex justify-between items-center border-b pb-2">
                <h1 class="text-lg font-bold text-slate-800" id="mTitle">Nuevo</h1>
                <button onclick="closeModal()" class="size-7 flex items-center justify-center rounded-full bg-slate-50 hover:bg-slate-100 text-slate-400 transition-colors">
                    <span class="material-symbols-outlined text-base">close</span>
                </button>
            </div>
            <form id="txForm" class="p-5 overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-3 p-1 bg-slate-100 rounded-xl mb-4 gap-1">
                    <button type="button" id="btnExp" onclick="setType('exp')" class="flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold transition-all shadow-sm bg-white text-danger border border-slate-100">Gasto</button>
                    <button type="button" id="btnInc" onclick="setType('inc')" class="flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold transition-all text-slate-400 hover:text-slate-600">Ingreso</button>
                    <button type="button" id="btnTrf" onclick="setType('transfer')" class="flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold transition-all text-slate-400 hover:text-slate-600">Transf.</button>
                </div>
                <input type="hidden" id="fType" value="exp">

                <div class="flex gap-3 mb-4">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-light text-lg">$</span>
                        <input type="number" id="fAmt" step="0.01" class="w-full pl-6 pr-3 py-2.5 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-primary rounded-xl text-lg font-bold text-slate-800 outline-none text-right transition-all" placeholder="0" required oninput="calcConversion();calcSplitDiff()">
                    </div>
                    <div class="w-20">
                        <select id="fCurr" onchange="calcConversion()" class="w-full h-full bg-slate-100 border-transparent rounded-xl text-[11px] font-bold focus:border-primary focus:ring-0 text-center pl-1 pr-6">
                            <option value="ARS">ARS</option><option value="USD">USD</option><option value="COP">COP</option>
                        </select>
                    </div>
                </div>
                <div id="convPreview" class="hidden text-right text-[10px] text-slate-500 font-medium -mt-2 mb-4 bg-slate-50 px-2 py-1 rounded inline-block float-right">
                    = <span id="convResult" class="text-slate-800 font-bold">$0 ARS</span>
                </div>
                <div class="clear-both"></div>

                <div class="mb-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Fecha</label>
                    <input type="date" id="fDate" class="w-full px-3 py-2.5 bg-slate-50 border-none rounded-xl text-xs font-medium focus:ring-2 focus:ring-primary/20" required>
                </div>
                
                <div class="mb-3 hidden" id="divFromAcc">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Desde (Origen)</label>
                    <select id="fFromAcc" class="w-full px-3 py-2.5 bg-slate-50 border-none rounded-xl text-xs focus:ring-2 focus:ring-primary/20 text-slate-700 font-medium"></select>
                </div>
                 <div class="mb-3 hidden" id="divToAcc">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Hacia (Destino)</label>
                    <select id="fToAcc" class="w-full px-3 py-2.5 bg-slate-50 border-none rounded-xl text-xs focus:ring-2 focus:ring-primary/20 text-slate-700 font-medium"></select>
                </div>

                <div class="mb-3 hidden" id="divSplitToggle">
                     <label class="flex items-center gap-2 cursor-pointer mb-2 bg-slate-50 p-2 rounded-lg">
                        <input type="checkbox" id="fIsSplit" onchange="toggleSplitUI()" class="rounded text-primary focus:ring-primary border-slate-300">
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Dividir en categorías (Split)</span>
                     </label>
                </div>

                <div id="normalTxFields">
                    <div class="mb-3" id="divCat">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Categoría</label>
                        <div class="flex flex-wrap gap-1.5" id="chipBox"></div>
                        <input type="hidden" id="fCat">
                    </div>
                    <div class="mb-3">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1" id="lblDesc">Concepto</label>
                        <div class="flex flex-wrap gap-1.5 mb-2" id="conceptBox"></div>
                        <input type="text" id="fDesc" class="w-full px-3 py-2.5 bg-slate-50 border-none rounded-xl text-xs focus:ring-2 focus:ring-primary/20 placeholder:text-slate-400" placeholder="Detalle...">
                    </div>
                </div>

                <div id="splitContainer" class="hidden mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div id="splitRows" class="space-y-2"></div>
                    <button type="button" onclick="addSplitRow()" class="mt-2 w-full py-2 border border-dashed border-primary/30 text-primary text-[10px] font-bold rounded-lg hover:bg-primary/5">+ Agregar Item</button>
                    <div class="flex justify-between mt-2 text-[10px] font-bold px-1">
                        <span class="text-slate-500">Diferencia:</span>
                        <span id="splitDiffVal" class="text-success">$0</span>
                    </div>
                </div>

                <div class="mb-4" id="linkRow">
                    <label class="block text-[10px] font-bold text-primary uppercase mb-1 ml-1">Pagar con (Fuente)</label>
                    <div id="linkChipsContainer" class="flex flex-wrap gap-1.5"></div>
                    <input type="hidden" id="fLink">
                </div>

                <div class="flex items-center gap-3 mb-5 p-2.5 border border-slate-100 rounded-xl bg-slate-50/50 hover:bg-slate-50 transition-colors cursor-pointer" onclick="document.getElementById('fExec').click()">
                    <input type="checkbox" id="fExec" class="size-4 text-primary rounded border-slate-300 focus:ring-primary bg-white">
                    <div>
                        <span class="block text-[11px] font-bold text-slate-700 select-none">Marcar como Ejecutado</span>
                        <span class="block text-[9px] text-slate-400">Congela el valor de la moneda</span>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <button type="submit" class="w-full py-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-xs font-bold shadow-lg shadow-slate-900/20 active:scale-95 transition-all">GUARDAR</button>
                    <button type="button" id="btnDel" onclick="delTx()" class="text-[10px] text-red-500 font-bold hover:bg-red-50 py-2 rounded-lg transition-colors hidden">Eliminar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <div id="accModal" class="fixed inset-0 z-[65] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div class="relative z-10 w-full max-w-[320px] bg-white rounded-2xl shadow-2xl p-5 animate-fade-in mx-4">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">Gestionar Cuenta</h3>
            <form id="accForm" onsubmit="saveAccount(event)">
                <input type="hidden" id="accId">
                <div class="mb-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nombre</label>
                    <input type="text" id="accName" class="w-full px-3 py-2 bg-slate-50 border-none rounded-lg text-xs font-bold focus:ring-1 focus:ring-primary" required>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tipo</label>
                        <select id="accKind" class="w-full bg-slate-50 border-none rounded-lg text-xs py-2">
                            <option value="asset">Activo (Caja/Inv)</option>
                            <option value="liability">Pasivo (Deuda/TC)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Moneda</label>
                        <select id="accCurr" class="w-full bg-slate-50 border-none rounded-lg text-xs py-2">
                            <option value="ARS">ARS</option>
                            <option value="USD">USD</option>
                            <option value="COP">COP</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                     <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Saldo Inicial</label>
                     <input type="number" id="accInit" step="0.01" class="w-full px-3 py-2 bg-slate-50 border-none rounded-lg text-xs font-bold focus:ring-1 focus:ring-primary" placeholder="0">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-slate-800 text-white py-2 rounded-lg text-xs font-bold hover:bg-slate-700">Guardar</button>
                    <button type="button" onclick="closeAccountModal()" class="flex-1 border border-slate-200 text-slate-500 py-2 rounded-lg text-xs font-bold hover:bg-slate-50">Cancelar</button>
                </div>
                 <button type="button" id="btnDelAcc" onclick="deleteAccount()" class="w-full mt-2 text-[10px] text-red-400 hover:text-red-600 font-bold hidden">Eliminar Cuenta</button>
            </form>
        </div>
    </div>

    <div id="bulkModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-[320px] shadow-2xl mx-4">
            <h3 class="text-sm font-bold text-slate-800 mb-4 border-b pb-2">Acciones Masivas</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Cambiar Categoría</label>
                    <select id="bulkCatSelect" class="w-full mt-1 border-slate-200 rounded-lg text-xs"></select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="bulkSetExec(true)" class="py-2 bg-emerald-50 text-emerald-700 text-[10px] font-bold rounded-lg border border-emerald-100 hover:bg-emerald-100">Marcar Pagado</button>
                    <button onclick="bulkSetExec(false)" class="py-2 bg-slate-50 text-slate-600 text-[10px] font-bold rounded-lg border border-slate-100 hover:bg-slate-100">Marcar Pendiente</button>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Vincular a Ingreso</label>
                    <select id="bulkLinkSelect" class="w-full mt-1 border-slate-200 rounded-lg text-xs"></select>
                </div>
                <button onclick="bulkApplyChanges()" class="w-full py-3 bg-primary text-white rounded-xl font-bold mt-4 shadow-md hover:bg-primary-dark">APLICAR CAMBIOS</button>
                <button onclick="closeBulkModal()" class="w-full text-[10px] font-bold text-slate-400 py-2 hover:text-slate-600">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN Y DATOS
        const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
        const MONTHS = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const PALETTE = ['#0e757c','#558055','#D4A373','#996A5C','#334155','#64748b','#94a3b8','#cbd5e1'];
        
        const defaultData = { 
            txs: [], 
            cats: { 
                exp:['Esenciales','Deudas','Fitness','Viaje Italia','Inversiones','Proyectos'], 
                inc:['Sueldo Famiq','Honorarios','Rentas','Otros'] 
            }, 
            concepts: {
                'Esenciales': ['Alquiler','Expensas','Supermercado','Luz','Gas','Internet'],
                'Deudas': ['Prestamo 11M','Visa','Mastercard'],
                'Fitness': ['Cuota Gym','Proteína','Creatina','Ropa Deportiva'],
                'Viaje Italia': ['Fondo Ahorro','Pasajes','Alojamiento'],
                'Inversiones': ['Plan 500 USD','CEDEARs','Crypto'],
                'Proyectos': ['ALEJEN Pediátrica','App Finance'],
                'Sueldo Famiq': ['Mensual','Bono'],
                'Honorarios': ['Consultas Dra','Particulares']
            }, 
            recurrentes: [], 
            monthlyRates: {},
            accounts: [
                { id: 'acc_cash', name: 'Efectivo ARS', kind: 'asset', currency: 'ARS', initBal: 0 }
            ],
            closedMonths: {}, 
            monthlySummary: {} 
        };

        let appData = JSON.parse(JSON.stringify(defaultData));
        let currentDate = new Date(); currentDate.setDate(1);
        let editId=null, editAccId=null, cExp=null, cInc=null, drillCat=null, cNWComp=null;
        
        // ESTADO DE SELECCIÓN Y EDICIÓN
        let isSelectionMode = false;
        let selectedTxIds = new Set();
        let historyStack = [];
        let netWorthChartInst = null;
        
        const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        window.onload = async () => {
            loadLocal();
            sanitizeData();
            updateDateUI();
            renderAdminTree();
            await forceSync();
            loadMonthData(); // Force load
            renderNetWorthView();
        };

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
        });

        function sanitizeData() {
            if (!appData.cats || !appData.cats.exp) appData.cats = JSON.parse(JSON.stringify(defaultData.cats));
            if (!appData.concepts) appData.concepts = JSON.parse(JSON.stringify(defaultData.concepts));
            if (!appData.txs) appData.txs = [];
            if (!appData.closedMonths) appData.closedMonths = {};
        }

        // --- CORE UTILS ---
        function getFilteredTxs() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            return appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
        }
        function getMonthKey(d) { return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2,'0')}`; }
        function isMonthClosed(d = currentDate) { return !!appData.closedMonths[getMonthKey(d)]; }

        // --- HISTORY ---
        function pushHistory() {
            historyStack.push(JSON.stringify(appData));
            if(historyStack.length > 20) historyStack.shift();
            document.getElementById('btnUndo').classList.remove('btn-disabled');
        }
        function undo() {
            if(historyStack.length === 0) return;
            appData = JSON.parse(historyStack.pop());
            saveData();
            if(historyStack.length === 0) document.getElementById('btnUndo').classList.add('btn-disabled');
        }

        // --- DATA SYNC ---
        function saveLocal() { localStorage.setItem('financeFlowData_Javi', JSON.stringify(appData)); }
        function loadLocal() { const stored = localStorage.getItem('financeFlowData_Javi'); if(stored) appData = JSON.parse(stored); }
        async function forceSync() {
            document.getElementById('syncIcon').classList.add('animate-spin');
            try { 
                const r = await fetch(API_URL); const cloudData = await r.json(); 
                if(cloudData) { appData = cloudData; saveLocal(); loadMonthData(); }
            } catch(e) { console.log("Offline mode"); }
            document.getElementById('syncIcon').classList.remove('animate-spin');
        }
        async function saveData() {
            saveLocal();
            try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(appData) }); } catch(e){}
            loadMonthData(); renderNetWorthView();
        }

        // --- MAIN RENDER LOOP ---
        function loadMonthData() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            const key = getMonthKey(currentDate);
            const closed = isMonthClosed();
            
            updateReadOnlyUI(closed);

            let rates = appData.monthlyRates[key] || { ARS: 1500, COP: 3700, USD: 1 };
            document.getElementById('rate_ARS').value = rates.ARS; 
            document.getElementById('rate_COP').value = rates.COP;
            
            const txs = getFilteredTxs();
            
            // Recalc foreign currency if not exec
            txs.forEach(t => {
                if (!t.exec && t.origCurr && t.origCurr !== 'ARS') {
                    if (t.origCurr === 'USD') t.amount = t.origAmt * rates.ARS;
                    else if (t.origCurr === 'COP') t.amount = (t.origAmt / rates.COP) * rates.ARS;
                }
            });

            txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
            
            updateKPIs(txs);
            
            // ALERTAS RECUPERADAS
            const alerts = computeAlerts(txs);
            renderAlerts(alerts);
            
            renderLists(txs);
            renderCharts(txs);
            renderRecurrentesAdmin();
            renderAdminTree();

            // Month Close Status
            const dashTxs = txs.filter(t => t.type !== 'transfer');
            const i = dashTxs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
            const e = dashTxs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
            document.getElementById('monthCloseBalance').innerText = `$${fmt(i-e)}`;
            const badge = document.getElementById('monthStatusBadge');
            const actionContainer = document.getElementById('monthActionContainer');
            
            if(closed) {
                badge.innerText = "CERRADO"; badge.className = "text-[9px] font-bold px-2 py-0.5 rounded-full bg-red-100 text-red-600 border border-red-200";
                actionContainer.innerHTML = `<button onclick="reopenMonth()" class="bg-white border border-slate-300 text-slate-600 text-[10px] px-3 py-1.5 rounded shadow-sm hover:bg-slate-50 font-bold">REABRIR</button>`;
            } else {
                badge.innerText = "ABIERTO"; badge.className = "text-[9px] font-bold px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-600 border border-emerald-200";
                actionContainer.innerHTML = `<button onclick="closeMonth()" class="bg-primary text-white text-[10px] px-3 py-1.5 rounded shadow hover:bg-primary-dark font-bold">CERRAR MES</button>`;
            }
        }

        function updateReadOnlyUI(closed) {
            document.getElementById('rate_ARS').disabled = closed;
            document.getElementById('rate_COP').disabled = closed;
            document.getElementById('lockIcon').classList.toggle('hidden', !closed);
            document.getElementById('monthTxt').classList.toggle('text-red-500', closed);
            
            const els = ['newBtnContainer', 'fabNew', 'allocControls', 'btnSelectMode'];
            els.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    if(closed) { el.classList.add('opacity-50', 'pointer-events-none'); if(id=='fabNew') el.classList.add('hidden'); }
                    else { el.classList.remove('opacity-50', 'pointer-events-none'); if(id=='fabNew') el.classList.remove('hidden'); }
                }
            });
            if(closed && isSelectionMode) toggleSelectionMode();
        }

        // --- ALERTAS (RESTORED) ---
        function computeAlerts(txs) {
            const alerts = []; const y = currentDate.getFullYear(); const m = currentDate.getMonth(); 
            const created = new Set();
            // Flat Txs for analysis
            const flatTxs = [];
            txs.filter(t=>t.type==='exp').forEach(t => { if(t.children && t.children.length > 0) t.children.forEach(c => flatTxs.push({cat:c.cat, amount:c.amount})); else flatTxs.push(t); });
            
            const catMap = {}; flatTxs.forEach(t => catMap[t.cat] = (catMap[t.cat] || 0) + t.amount);
            
            Object.entries(catMap).forEach(([cat, amount]) => {
                const avg = getPastAverage(cat, m, y);
                if (avg > 0) {
                    const diff = (amount - avg) / avg;
                    if (diff >= 0.20) {
                        const aid = `trend-${cat}`; if(!created.has(aid)){
                            alerts.push({ id:aid, severity: diff>0.5?'danger':'warning', title:`Suba en ${cat}`, desc:`+${Math.round(diff*100)}% vs prom. ($${fmt(avg)})`, action:`document.getElementById('searchExpInput').value='${cat}';filterExpList()` });
                            created.add(aid);
                        }
                    }
                }
            });
            const unassigned = txs.filter(t => t.type === 'exp' && !t.linkId).reduce((a,b)=>a+b.amount,0);
            if(unassigned > 0) alerts.push({id:'orphan', severity:'warning', title:'Sin Asignar', desc:`$${fmt(unassigned)} pendientes`, action:`document.getElementById('searchExpInput').value='sin asignar';filterExpList()`});
            return alerts;
        }

        function getPastAverage(cat, mIdx, year) {
            let sum=0, count=0;
            for(let i=1; i<=3; i++) {
                let tm = mIdx-i, ty = year; if(tm<0){ tm+=12; ty--; }
                const mTx = appData.txs.filter(t=>!t.deletedAt && t.type==='exp' && t.cat===cat && parseInt(t.date.split('-')[0])===ty && parseInt(t.date.split('-')[1])===(tm+1));
                if(mTx.length>0){ sum+=mTx.reduce((a,b)=>a+b.amount,0); count++; }
            }
            return count>0 ? sum/count : 0;
        }

        function renderAlerts(alerts) {
            const h = alerts.map(a => `<div class="alert-card border-l-4 rounded-r-lg p-3 shadow-sm flex items-start justify-between gap-3 ${a.severity==='danger'?'border-l-red-500 bg-red-50 text-red-900':'border-l-amber-500 bg-amber-50 text-amber-900'}"><div><h4 class="text-xs font-bold">${a.title}</h4><p class="text-[10px] opacity-80">${a.desc}</p></div><button onclick="${a.action}" class="text-[10px] font-bold underline">Ver</button></div>`).join('');
            document.getElementById('dashboardAlerts').innerHTML = h; document.getElementById('analyticsAlerts').innerHTML = h;
        }

        // --- LIST RENDERING ---
        function renderLists(txs) {
            const lI = document.getElementById('list-inc'), lE = document.getElementById('list-exp'), lA = document.getElementById('list-alloc');
            lI.innerHTML = ''; lE.innerHTML = ''; lA.innerHTML = '';
            
            const search = document.getElementById('searchExpInput').value.toLowerCase();
            const dashTxs = txs.filter(t => t.type !== 'transfer');

            dashTxs.forEach(t => {
                if(t.type === 'exp') {
                     const matchSelf = t.desc.toLowerCase().includes(search);
                     const matchChild = t.children && t.children.some(c => c.desc.toLowerCase().includes(search));
                     if(search && !matchSelf && !matchChild && search !== 'sin asignar') return;
                     if(search === 'sin asignar' && t.linkId) return;
                }

                const isSplit = t.children && t.children.length > 0;
                const isSelected = selectedTxIds.has(t.id);
                
                const el = document.createElement(isSplit ? 'details' : 'div');
                
                let baseClass = t.exec ? "opacity-60 bg-slate-50/50 line-through decoration-slate-400" : "bg-white";
                if(isSelectionMode && isSelected) baseClass = "bg-blue-50/50";
                
                el.className = `compact-row group flex flex-col cursor-pointer ${baseClass} ${isSelected ? 'selected' : ''}`;
                
                let iconHtml = '';
                if(isSelectionMode && t.type === 'exp') {
                    iconHtml = `<div onclick="toggleSelectTx(${t.id}, event)" class="custom-chk ${isSelected ? 'checked' : ''}"><i class="material-symbols-outlined">check</i></div>`;
                } else {
                    iconHtml = `<div onclick="toggleExec(${t.id}, event)" class="custom-chk ${t.exec ? 'exec' : ''}"><i class="material-symbols-outlined">check</i></div>`;
                }

                let currBadge = (t.origCurr && t.origCurr !== 'ARS') ? `<span class="bg-blue-50 text-blue-600 text-[9px] px-1.5 py-0.5 rounded ml-1 font-bold">${t.origAmt} ${t.origCurr}</span>` : '';
                let linkText = '';
                if(t.type=='exp' && t.linkId) { 
                    const source = appData.txs.find(x => x.id == t.linkId); 
                    if(source) linkText = `<span class="inline-flex items-center ml-2 bg-slate-100 text-slate-500 text-[9px] px-1.5 py-0.5 rounded-md"><span class="material-symbols-outlined text-[10px] mr-0.5">link</span>${source.desc.substring(0,8)}</span>`; 
                }

                const content = `
                    <div class="flex items-center gap-3 w-full">
                        <div class="shrink-0 flex items-center justify-center size-6">${iconHtml}</div>
                        <div class="min-w-0 flex-1" onclick="${isSelectionMode ? `toggleSelectTx(${t.id}, event)` : (isSplit ? '' : `editTx(${t.id})`)}">
                            <div class="flex items-center justify-between">
                                <p class="text-xs font-bold text-slate-800 truncate">${t.desc} ${currBadge} ${linkText}</p>
                                <p class="text-xs font-bold ${t.type === 'inc' ? 'text-success' : 'text-danger'}">$${fmt(t.amount)}</p>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[9px] px-1.5 bg-slate-100 rounded text-slate-500">${isSplit ? 'SPLIT' : (t.cat || 'Gral')}</span>
                                <span class="text-[9px] text-slate-400">${t.date.split('-')[2]}</span>
                            </div>
                        </div>
                    </div>
                `;

                if(isSplit) {
                    el.innerHTML = `<summary class="list-none outline-none select-none">${content}</summary>`;
                    let childHtml = `<div class="mt-2 space-y-1 pl-9 border-l-2 ml-3">`;
                    t.children.forEach(c => {
                        childHtml += `<div class="flex justify-between text-[10px] text-slate-500"><span>${c.desc} (${c.cat})</span><span class="font-bold">$${fmt(c.amount)}</span></div>`;
                    });
                    childHtml += `<button onclick="editTx(${t.id})" class="text-[9px] text-primary underline mt-1">Editar Split</button></div>`;
                    el.innerHTML += childHtml;
                } else {
                    el.innerHTML = content;
                }

                (t.type === 'inc' ? lI : lE).appendChild(el);
            });
            
            document.getElementById('c-inc').innerText = dashTxs.filter(t => t.type === 'inc').length;
            document.getElementById('c-exp').innerText = dashTxs.filter(t => t.type === 'exp').length;

            const incs = dashTxs.filter(t=>t.type=='inc');
            incs.forEach(inc => {
                const subs = dashTxs.filter(t=>t.type=='exp' && t.linkId==inc.id);
                const spent = subs.reduce((a,b)=>a+b.amount,0);
                const rem = inc.amount - spent;
                const pct = Math.min(100, (spent/inc.amount)*100);
                
                // CORRECCIÓN DE TACHADO EN ASIGNACIÓN
                let rows = ''; 
                if (subs.length > 0) { 
                    subs.forEach(s => { 
                        const style = s.exec ? 'line-through text-slate-400 opacity-70' : 'text-slate-600';
                        rows += `<div class="flex justify-between py-1.5 text-[10px] border-b border-dashed border-slate-100 cursor-pointer hover:bg-slate-50 px-2 rounded ${style}" onclick="editTx(${s.id})"><span class="truncate pr-2">${s.desc}</span><span class="font-bold shrink-0">$${fmt(s.amount)}</span></div>`; 
                    }); 
                } else { 
                    rows = '<span class="text-[10px] text-slate-300 italic px-2">Sin asignaciones</span>'; 
                }
                
                const card = document.createElement('div');
                card.innerHTML = `<div class="rounded-xl border border-slate-200 bg-white mb-2 shadow-sm overflow-hidden group"><div class="p-3 bg-slate-50/50 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors"><div onclick="this.closest('.rounded-xl').querySelector('.alloc-details').classList.toggle('hidden')" class="flex-1"><p class="text-[11px] font-bold text-slate-700">${inc.desc}</p><p class="text-[10px] font-extrabold mt-0.5 ${rem>=0?'text-success':'text-danger'}">$${fmt(rem)}</p></div><div class="flex items-center gap-3"><span class="text-[9px] font-bold text-slate-600">${Math.round(pct)}%</span><button onclick="unassignGroup(${inc.id})" class="text-slate-300 hover:text-red-500 transition-colors"><span class="material-symbols-outlined text-sm">link_off</span></button></div></div><div class="w-full h-1 bg-slate-100"><div class="h-full ${pct>90?'bg-danger':'bg-primary'}" style="width: ${pct}%;"></div></div><div class="alloc-details hidden bg-white py-1 border-t border-slate-100">${rows}</div></div>`;
                lA.appendChild(card);
            });
        }

        function filterExpList() { renderLists(getFilteredTxs()); }
        function updateKPIs(txs){ 
            const dashTxs = txs.filter(t => t.type !== 'transfer');
            const tc=parseFloat(document.getElementById('rate_ARS').value)||1200; 
            const i=dashTxs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0); 
            const e=dashTxs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0); 
            const bal = i-e;
            document.getElementById('k-inc').innerText='$'+fmt(i); 
            document.getElementById('k-exp').innerText='$'+fmt(e); 
            const balEl = document.getElementById('k-bal'); balEl.innerText = '$'+fmt(bal); balEl.className = `text-2xl font-black tracking-tight ${bal >= 0 ? 'text-emerald-700' : 'text-rose-700'}`;
            document.getElementById('k-usd').innerText='USD '+fmt(bal/tc); 
        }

        // --- SPLIT & FORM LOGIC ---
        function setType(t){
            document.getElementById('fType').value=t;
            const btnExp = document.getElementById('btnExp'); const btnInc = document.getElementById('btnInc'); const btnTrf = document.getElementById('btnTrf');
            const divFrom = document.getElementById('divFromAcc'); const divTo = document.getElementById('divToAcc');
            const divCat = document.getElementById('divCat'); const linkRow = document.getElementById('linkRow');
            const divSplit = document.getElementById('divSplitToggle');
            const normalTx = document.getElementById('normalTxFields');

            // Reset Styles
            btnExp.className = btnInc.className = btnTrf.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold transition-all text-slate-400 hover:text-slate-600";
            updateAccountSelects();
            
            divSplit.classList.add('hidden');
            normalTx.classList.remove('hidden');

            if(t === 'exp') {
                btnExp.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold transition-all shadow-sm bg-white text-danger border border-slate-100";
                divFrom.classList.remove('hidden'); divTo.classList.add('hidden');
                divCat.classList.remove('hidden'); linkRow.classList.remove('hidden');
                divSplit.classList.remove('hidden');
                renderChips('exp'); renderLinkChips();
                document.getElementById('lblDesc').innerText = "Concepto"; 
            } else if(t === 'inc') {
                btnInc.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold transition-all shadow-sm bg-white text-success border border-slate-100";
                divFrom.classList.add('hidden'); divTo.classList.remove('hidden');
                divCat.classList.remove('hidden'); linkRow.classList.add('hidden');
                renderChips('inc'); 
                document.getElementById('lblDesc').innerText = "Detalle";
            } else { // Transfer
                btnTrf.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold transition-all shadow-sm bg-white text-primary border border-slate-100";
                divFrom.classList.remove('hidden'); divTo.classList.remove('hidden');
                divCat.classList.add('hidden'); linkRow.classList.add('hidden'); 
                document.getElementById('lblDesc').innerText = "Descripción";
            }
            document.getElementById('fCat').value = ''; document.getElementById('conceptBox').innerHTML = '';
            document.getElementById('fIsSplit').checked = false; toggleSplitUI();
        }

        function toggleSplitUI() {
            const isSplit = document.getElementById('fIsSplit').checked;
            const container = document.getElementById('splitContainer');
            const normalFields = document.getElementById('normalTxFields');
            const rows = document.getElementById('splitRows');

            if(isSplit) {
                container.classList.remove('hidden');
                normalFields.classList.add('hidden');
                if(rows.innerHTML === '') addSplitRow(); 
                calcSplitDiff();
            } else {
                container.classList.add('hidden');
                normalFields.classList.remove('hidden');
            }
        }

        // --- NUEVA LÓGICA DE SPLIT CON CONCEPTOS ---
        function addSplitRow(data = {}) {
            const container = document.getElementById('splitRows');
            const div = document.createElement('div');
            const rowId = `split_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
            div.className = 'split-input-row';
            
            // Build Cat Select
            let catOpts = '';
            const cats = appData.cats.exp || [];
            cats.forEach(c => catOpts += `<option value="${c}" ${data.cat===c?'selected':''}>${c}</option>`);
            
            // Build Datalist for Concepts based on current selection
            const currentCat = data.cat || cats[0];
            const concepts = appData.concepts[currentCat] || [];
            let datalistOpts = '';
            concepts.forEach(c => datalistOpts += `<option value="${c}">`);

            div.innerHTML = `
                <select class="split-cat w-full text-[10px] border border-slate-200 rounded p-1 bg-white" onchange="updateSplitConcepts(this, '${rowId}')">${catOpts}</select>
                
                <input type="text" list="list_${rowId}" class="split-desc w-full text-[10px] border border-slate-200 rounded p-1" placeholder="Concepto" value="${data.desc||''}">
                <datalist id="list_${rowId}">${datalistOpts}</datalist>

                <input type="number" class="split-amt w-full text-[10px] border border-slate-200 rounded p-1 text-right font-bold" placeholder="0" value="${data.amount||''}" step="0.01" oninput="calcSplitDiff()">
                <button type="button" onclick="this.parentElement.remove();calcSplitDiff()" class="text-red-400 hover:text-red-600 font-bold px-1">x</button>
            `;
            container.appendChild(div);
            calcSplitDiff();
        }

        function updateSplitConcepts(selectEl, rowId) {
            const newCat = selectEl.value;
            const concepts = appData.concepts[newCat] || [];
            const datalist = document.getElementById(`list_${rowId}`);
            if(datalist) {
                datalist.innerHTML = '';
                concepts.forEach(c => datalist.innerHTML += `<option value="${c}">`);
            }
            // Optional: Clear input if cat changes? Let's keep it to avoid data loss
        }

        function calcSplitDiff() {
            const total = parseFloat(document.getElementById('fAmt').value) || 0;
            const rows = document.querySelectorAll('.split-input-row');
            let sum = 0;
            rows.forEach(r => sum += parseFloat(r.querySelector('.split-amt').value) || 0);
            
            const diff = total - sum;
            const el = document.getElementById('splitDiffVal');
            el.innerText = `$${fmt(diff)}`;
            if(Math.abs(diff) > 1) { el.classList.remove('text-success'); el.classList.add('text-danger'); }
            else { el.classList.remove('text-danger'); el.classList.add('text-success'); }
            return diff;
        }

        document.getElementById('txForm').onsubmit=e=>{
            e.preventDefault();
            const d = new Date(document.getElementById('fDate').value + 'T00:00:00');
            if(isMonthClosed(d)) return alert("El mes de esa fecha está cerrado.");

            const type = document.getElementById('fType').value;
            const isSplit = document.getElementById('fIsSplit').checked && type === 'exp';
            
            let cat = null;
            let desc = null;
            let children = [];

            if(isSplit) {
                const diff = calcSplitDiff();
                if(Math.abs(diff) > 1) return alert(`La suma no coincide. Diferencia: ${diff}`);
                const rows = document.querySelectorAll('.split-input-row');
                rows.forEach(r => {
                    const rAmt = parseFloat(r.querySelector('.split-amt').value) || 0;
                    const rCat = r.querySelector('.split-cat').value;
                    const rDesc = r.querySelector('.split-desc').value;
                    
                    if(rAmt > 0) {
                        children.push({id: Date.now()+Math.random(), cat: rCat, desc: rDesc, amount: rAmt});
                        // Learn new concepts from split
                        if(!appData.concepts[rCat]) appData.concepts[rCat] = [];
                        if(rDesc && !appData.concepts[rCat].includes(rDesc)) appData.concepts[rCat].push(rDesc);
                    }
                });
                cat = 'Múltiples'; desc = document.getElementById('fDesc').value || 'Gasto dividido';
            } else {
                cat=document.getElementById('fCat').value;
                if(type !== 'transfer' && !cat) return alert('Selecciona categoría');
                desc=document.getElementById('fDesc').value;
            }

            pushHistory();
            if(!isSplit && cat && type !== 'transfer') { 
                if(!appData.concepts[cat]) appData.concepts[cat] = []; 
                if(!appData.concepts[cat].includes(desc)) appData.concepts[cat].push(desc); 
            }

            const tx={
                id:editId||Date.now(), date:document.getElementById('fDate').value,
                amount: calcConversion(), 
                origAmt: parseFloat(document.getElementById('fAmt').value), 
                origCurr: document.getElementById('fCurr').value,
                type, cat: (type==='transfer' ? 'Transferencia' : cat), desc, 
                exec:document.getElementById('fExec').checked,
                linkId:type=='exp'?document.getElementById('fLink').value:null, 
                deletedAt:null,
                fromAccountId: (type === 'exp' || type === 'transfer') ? document.getElementById('fFromAcc').value : null,
                toAccountId: (type === 'inc' || type === 'transfer') ? document.getElementById('fToAcc').value : null,
                children: isSplit ? children : []
            };
            
            if(editId){ const i=appData.txs.findIndex(x=>x.id==editId); appData.txs[i]=tx; } else appData.txs.push(tx);
            saveData(); closeModal();
        }

        function toggleExec(id, event) {
            event.stopPropagation();
            if(isMonthClosed()) return alert("Mes cerrado.");
            pushHistory();
            const tx = appData.txs.find(t => t.id === id);
            if(tx) tx.exec = !tx.exec;
            saveData();
        }

        // --- NAVIGATION FIXED ---
        function nav(v, el) {
            document.querySelectorAll('.view-container').forEach(e => e.classList.add('hidden-view'));
            const target = document.getElementById(`view-${v}`);
            if(target) target.classList.remove('hidden-view');
            
            document.querySelectorAll('#main-nav button').forEach(e => {
                e.classList.remove('active-nav');
                e.classList.add('text-slate-500');
            });
            if(el) {
                el.classList.add('active-nav');
                el.classList.remove('text-slate-500');
            }
            if(v === 'networth') renderNetWorthView();
        }

        // --- BULK LOGIC ---
        function toggleSelectionMode() {
            if(isMonthClosed()) return alert("Mes cerrado.");
            isSelectionMode = !isSelectionMode;
            if(!isSelectionMode) selectedTxIds.clear(); 
            const btn = document.getElementById('btnSelectMode');
            btn.classList.toggle('text-primary', isSelectionMode);
            btn.classList.toggle('text-slate-400', !isSelectionMode);
            updateSelectionUI();
            renderLists(getFilteredTxs()); 
        }

        function toggleSelectTx(id, event) {
            if(event) event.stopPropagation();
            if(isMonthClosed()) return alert("Mes cerrado.");
            if(selectedTxIds.has(id)) selectedTxIds.delete(id); 
            else selectedTxIds.add(id); 
            updateSelectionUI();
            renderLists(getFilteredTxs()); 
        }

        function updateSelectionUI() {
            const bar = document.getElementById('bulkBar');
            const countEl = document.getElementById('bulkCount');
            if(selectedTxIds.size > 0) {
                bar.classList.add('show');
                countEl.innerText = `${selectedTxIds.size} seleccionados`;
            } else {
                bar.classList.remove('show');
                if(!isSelectionMode) bar.classList.add('hidden'); else bar.classList.remove('hidden');
            }
        }

        function selectAllVisible() {
            const visible = getFilteredTxs().filter(t => t.type === 'exp');
            visible.forEach(t => selectedTxIds.add(t.id));
            updateSelectionUI();
            renderLists(getFilteredTxs());
        }

        function openBulkModal() {
            const catSel = document.getElementById('bulkCatSelect');
            catSel.innerHTML = '<option value="">Sin cambios</option>';
            appData.cats.exp.forEach(c => catSel.innerHTML += `<option value="${c}">${c}</option>`);

            const linkSel = document.getElementById('bulkLinkSelect');
            linkSel.innerHTML = '<option value="">Sin cambios</option><option value="unassign">Desvincular</option>';
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            const incs = appData.txs.filter(t => !t.deletedAt && t.type === 'inc' && parseInt(t.date.split('-')[1]) === m);
            incs.forEach(i => linkSel.innerHTML += `<option value="${i.id}">${i.desc}</option>`);
            document.getElementById('bulkModal').classList.remove('hidden');
        }

        function closeBulkModal() { document.getElementById('bulkModal').classList.add('hidden'); }

        function bulkApplyChanges() {
            pushHistory();
            const newCat = document.getElementById('bulkCatSelect').value;
            const newLink = document.getElementById('bulkLinkSelect').value;
            
            appData.txs.forEach(t => {
                if(selectedTxIds.has(t.id)) {
                    if(newCat) t.cat = newCat;
                    if(newLink === 'unassign') t.linkId = null;
                    else if(newLink) t.linkId = newLink;
                }
            });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }

        function bulkSetExec(val) {
            pushHistory();
            appData.txs.forEach(t => { if(selectedTxIds.has(t.id)) t.exec = val; });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }

        function bulkDelete() {
            if(!confirm(`¿Eliminar ${selectedTxIds.size} registros?`)) return;
            pushHistory();
            appData.txs.forEach(t => { if(selectedTxIds.has(t.id)) t.deletedAt = Date.now(); });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }

        // --- CHARTS (Flattened for Split) ---
        function renderCharts(txs) {
            const dashboardTxs = txs.filter(t => t.type !== 'transfer');
            const expTxs = [];
            dashboardTxs.filter(t => t.type === 'exp').forEach(t => {
                if(t.children && t.children.length > 0) t.children.forEach(c => expTxs.push({cat: c.cat, amount: c.amount, desc: c.desc}));
                else expTxs.push(t);
            });
            renderDoughnut(document.getElementById('chartExp'), document.getElementById('legExp'), expTxs, 'cat', true, cExp, i=>cExp=i);
            renderDoughnut(document.getElementById('chartInc'), document.getElementById('legInc'), dashboardTxs.filter(t=>t.type=='inc'), 'desc', false, cInc, i=>cInc=i);
        }
        
        function renderDoughnut(cvs, leg, data, key, drill, inst, setInst) {
            if(inst) inst.destroy();
            let map={}; if(drill && drillCat) { document.getElementById('resetBtn').classList.remove('hidden'); data.filter(t=>t.cat==drillCat).forEach(t=>map[t.desc]=(map[t.desc]||0)+t.amount); } else { if(drill) document.getElementById('resetBtn').classList.add('hidden'); data.forEach(t=>{ const k = t[key] || 'General'; map[k]=(map[k]||0)+t.amount; }); }
            const ent = Object.entries(map).sort((a,b)=>b[1]-a[1]); const tot = ent.reduce((a,b)=>a+b[1],0);
            setInst(new Chart(cvs, { type:'doughnut', data:{ labels:ent.map(e=>e[0]), datasets:[{data:ent.map(e=>e[1]), backgroundColor:PALETTE, borderWidth:0, hoverOffset:2}] }, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{display:false}}, onClick:(e,el)=>{if(drill&&!drillCat&&el.length){drillCat=ent[el[0].index][0]; loadMonthData();}} } }));
            leg.innerHTML = ''; ent.forEach((e,i) => { const pct = Math.round((e[1]/tot)*100); leg.innerHTML += `<div class="flex items-center justify-between text-[10px] py-1.5 border-b border-dashed border-slate-100 cursor-pointer hover:bg-slate-50 px-1 rounded" onclick="${drill&&!drillCat?`drillCat='${e[0]}';loadMonthData()`:''}"><div class="flex items-center gap-1.5 min-w-0"><span class="size-2 rounded-full shrink-0" style="background:${PALETTE[i%PALETTE.length]}"></span><span class="text-slate-600 font-medium truncate">${e[0]}</span></div><div class="flex items-center gap-2 shrink-0"><span class="text-slate-400">${pct}%</span><span class="font-bold text-slate-800">$${fmt(e[1])}</span></div></div>`; });
        }
        function resetCharts() { drillCat=null; loadMonthData(); }

        // --- EXTRAS ---
        function renderChips(type) {
            const container = document.getElementById('chipBox'); container.innerHTML = '';
            const cats = type === 'inc' ? (appData.cats.inc || []) : (appData.cats.exp || []);
            cats.forEach(c => {
                const chip = document.createElement('div');
                chip.className = `chip px-3 py-1 cursor-pointer select-none ${document.getElementById('fCat').value === c ? 'active' : ''}`;
                chip.innerText = c;
                chip.onclick = () => { document.getElementById('fCat').value = c; document.querySelectorAll('#chipBox .chip').forEach(x => x.classList.remove('active')); chip.classList.add('active'); renderConcepts(c); };
                container.appendChild(chip);
            });
        }
        function renderConcepts(catKey) {
            const box = document.getElementById('conceptBox'); box.innerHTML = '';
            const list = appData.concepts[catKey] || [];
            list.forEach(c => { const el = document.createElement('div'); el.className = 'cat-tag px-2 py-1 text-xs cursor-pointer'; el.innerText = c; el.onclick = () => { document.getElementById('fDesc').value = c; }; box.appendChild(el); });
        }
        function renderLinkChips(selectedId){const container = document.getElementById('linkChipsContainer'); container.innerHTML = '';const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;const incs = appData.txs.filter(t=>!t.deletedAt && t.type=='inc' && parseInt(t.date.split('-')[1])==m);if(incs.length === 0) { container.innerHTML = '<span class="text-[10px] text-slate-400 italic">No hay ingresos este mes</span>'; return; }incs.forEach(i => {const sp=appData.txs.filter(x=>!x.deletedAt && x.type=='exp' && x.linkId==i.id && x.id!=editId).reduce((a,b)=>a+b.amount,0);const bal = i.amount - sp;if(bal < 1 && i.id != selectedId) return; const chip = document.createElement('div');chip.className = `chip px-2 py-1 rounded cursor-pointer select-none text-[10px] ${selectedId == i.id ? 'active' : ''}`;chip.innerHTML = `<b>${i.desc}</b> <span class="opacity-70">($${fmt(bal)})</span>`;chip.onclick = () => {document.getElementById('fLink').value = i.id;document.querySelectorAll('#linkChipsContainer .chip').forEach(x => x.classList.remove('active'));chip.classList.add('active');};container.appendChild(chip);});}
        function calcConversion() {
            const amt = parseFloat(document.getElementById('fAmt').value) || 0;
            const curr = document.getElementById('fCurr').value;
            const rateARS = parseFloat(document.getElementById('rate_ARS').value) || 1200;
            let final = amt;
            if (curr === 'USD') final = amt * rateARS;
            if (curr === 'COP') final = (amt / parseFloat(document.getElementById('rate_COP').value)) * rateARS;
            document.getElementById('convResult').innerText = `$${fmt(final)} ARS`;
            document.getElementById('convPreview').classList.toggle('hidden', curr === 'ARS');
            return final;
        }
        function editTx(id){
            if(isMonthClosed()) return alert("Mes cerrado. No se puede editar.");
            const t=appData.txs.find(x=>x.id==id); if(!t)return; editId=id;
            document.getElementById('mTitle').innerText='Editar'; document.getElementById('btnDel').classList.remove('hidden');
            document.getElementById('fDate').value=t.date; 
            document.getElementById('fExec').checked=t.exec;
            document.getElementById('fAmt').value = t.origAmt || t.amount; document.getElementById('fCurr').value = t.origCurr || 'ARS';
            setType(t.type); 
            
            if(t.children && t.children.length > 0) {
                document.getElementById('fIsSplit').checked = true; toggleSplitUI();
                document.getElementById('splitRows').innerHTML = ''; 
                t.children.forEach(c => addSplitRow(c));
                document.getElementById('fDesc').value = t.desc;
            } else {
                 if(t.type !== 'transfer') {
                    document.getElementById('fDesc').value=t.desc;
                    document.getElementById('fCat').value = t.cat; renderChips(t.type); 
                    if(t.type === 'exp') { document.getElementById('fLink').value = t.linkId || ""; renderLinkChips(t.linkId);}
                    renderConcepts(t.cat);
                }
            }
            if(t.fromAccountId) document.getElementById('fFromAcc').value = t.fromAccountId;
            if(t.toAccountId) document.getElementById('fToAcc').value = t.toAccountId;
            calcConversion(); document.getElementById('modalOverlay').classList.remove('hidden');
        }
        function delTx(){ if(confirm('Eliminar?')){ pushHistory(); appData.txs.find(x=>x.id==editId).deletedAt=Date.now(); saveData(); closeModal(); }}
        function updateDateUI(){ document.getElementById('monthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }
        function manualDate(){ const[y,m]=document.getElementById('datePicker').value.split('-'); currentDate.setFullYear(y); currentDate.setMonth(m-1); updateDateUI(); loadMonthData(); }
        function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); updateDateUI(); loadMonthData(); }
        function openModal(){ if(isMonthClosed()) return alert("Mes cerrado."); editId=null; document.getElementById('txForm').reset(); document.getElementById('mTitle').innerText='Nuevo'; document.getElementById('btnDel').classList.add('hidden'); document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; document.getElementById('splitRows').innerHTML=''; setType('exp'); document.getElementById('modalOverlay').classList.remove('hidden'); }
        function closeModal(){ document.getElementById('modalOverlay').classList.add('hidden'); }
        function updateAccountSelects() {
            const fAcc = document.getElementById('fFromAcc'); const tAcc = document.getElementById('fToAcc');
            fAcc.innerHTML = ''; tAcc.innerHTML = '';
            appData.accounts.forEach(a => { const opt = `<option value="${a.id}">${a.name} (${a.currency})</option>`; fAcc.innerHTML += opt; tAcc.innerHTML += opt; });
        }
        
        // ADMIN AND RECURRENTES FUNCTIONS
        function manualAddCat() { const n = document.getElementById('newCatName').value.trim(); const t = document.getElementById('newCatType').value; if(!n) return alert('Nombre?'); pushHistory(); if(t === 'exp') { if(!appData.cats.exp.includes(n)) appData.cats.exp.push(n); } else { if(!appData.cats.inc.includes(n)) appData.cats.inc.push(n); } if(!appData.concepts[n]) appData.concepts[n] = []; document.getElementById('newCatName').value = ''; saveData(); }
        function delCat(type, name) { if(confirm(`¿Eliminar ${name}?`)) { pushHistory(); if(type === 'exp') appData.cats.exp = appData.cats.exp.filter(x => x !== name); else appData.cats.inc = appData.cats.inc.filter(x => x !== name); delete appData.concepts[name]; saveData(); } }
        function manualAddConcept(catName) { const input = document.getElementById(`newCon_${catName}`); const val = input.value.trim(); if(!val) return; pushHistory(); if(!appData.concepts[catName]) appData.concepts[catName] = []; if(!appData.concepts[catName].includes(val)) appData.concepts[catName].push(val); saveData(); renderAdminTree(); }
        function delConcept(cat, name) { if(confirm(`¿Eliminar ${name}?`)) { pushHistory(); appData.concepts[cat] = appData.concepts[cat].filter(x => x !== name); saveData(); } }
        function renderAdminTree() {
            const container = document.getElementById('adminTreeContainer'); container.innerHTML = '';
            const buildBranch = (title, type) => {
                const cats = type === 'inc' ? appData.cats.inc : appData.cats.exp;
                const icon = type === 'inc' ? 'trending_up' : 'trending_down';
                const color = type === 'inc' ? 'text-success' : 'text-danger';
                let html = `<div class="mb-1"><div class="flex items-center gap-2 mb-1 px-1 mt-1"><span class="material-symbols-outlined text-sm ${color}">${icon}</span><h4 class="font-bold text-[10px] text-slate-500 uppercase tracking-wide">${title}</h4></div><div class="space-y-1">`;
                cats.forEach(c => {
                    const concepts = appData.concepts[c] || [];
                    html += `<details class="group bg-slate-50 rounded-lg border border-slate-100 overflow-hidden open:bg-white open:shadow-sm transition-all"><summary class="flex justify-between items-center p-1.5 cursor-pointer hover:bg-slate-100 transition-colors"><div class="flex items-center gap-1"><span class="material-symbols-outlined text-slate-400 text-base group-open:text-primary transition-colors">folder</span><span class="text-[11px] font-bold text-slate-700">${c}</span><span class="text-[9px] text-slate-400 bg-white px-1.5 rounded-full border border-slate-100">${concepts.length}</span></div><button onclick="delCat('${type}','${c}')" class="text-slate-300 hover:text-red-500 transition-colors"><span class="material-symbols-outlined text-sm">delete</span></button></summary><div class="p-1.5 pt-0 border-t border-slate-100 bg-white"><div class="flex flex-wrap gap-1 mb-1 mt-1">${concepts.map(con => `<div class="cat-tag flex items-center gap-1 group/tag">${con}<button onclick="delConcept('${c}','${con}')" class="text-slate-300 hover:text-red-500 hidden group-hover/tag:block"><span class="material-symbols-outlined text-[10px] font-bold">close</span></button></div>`).join('')}</div><div class="flex gap-1"><input type="text" id="newCon_${c}" placeholder="+ Subcat" class="w-full text-[10px] border-none bg-slate-50 rounded px-2 py-0.5 focus:ring-1 focus:ring-primary"><button onclick="manualAddConcept('${c}')" class="text-primary hover:bg-primary/10 rounded px-1"><span class="material-symbols-outlined text-sm">add</span></button></div></div></details>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            };
            buildBranch("Gastos", "exp");
            buildBranch("Ingresos", "inc");
        }
        function saveMonthlyRates() { const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1; appData.monthlyRates[`${y}-${m.toString().padStart(2,'0')}`] = { ARS: parseFloat(document.getElementById('rate_ARS').value), COP: parseFloat(document.getElementById('rate_COP').value), USD: 1 }; saveData(); }
        function renderRecurrentesAdmin() { const b=document.getElementById('recurrente-table-body'); b.innerHTML=''; appData.recurrentes.forEach((r,i)=>{const d=document.createElement('div'); d.className='flex gap-2 items-center text-xs border-b border-slate-200 py-1 last:border-0'; d.innerHTML=`<input value="${r.desc}" onchange="pushHistory();appData.recurrentes[${i}].desc=this.value" class="w-1/3 border-slate-200 rounded px-1 py-0.5"><input type="number" value="${r.amount}" onchange="pushHistory();appData.recurrentes[${i}].amount=parseFloat(this.value)" class="w-1/4 border-slate-200 rounded px-1 py-0.5 text-right"><span class="text-slate-400 text-[10px] w-1/4">${r.cat}</span><button onclick="deleteRecurrente(${i})" class="text-red-400 hover:text-red-600 font-bold px-2">x</button>`; b.appendChild(d);}); }
        function deleteRecurrente(i) { pushHistory(); appData.recurrentes.splice(i,1); saveData(); }
        function addRecurrenteRow() { pushHistory(); appData.recurrentes.push({desc:'Nuevo', amount:0, cat:'Esenciales', type:'exp'}); renderRecurrentesAdmin(); }
        function saveRecurrentesConfig() { saveData(); alert('Guardado'); }
        function executeRecurrentes() { 
            if(isMonthClosed()) return alert("Mes cerrado."); 
            const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; 
            let c=0; const defAcc = appData.accounts[0].id; 
            appData.recurrentes.forEach(r=>{ 
                if(!appData.txs.some(t=>!t.deletedAt && t.desc==r.desc && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m)){ 
                    appData.txs.push({...r, id:Date.now()+Math.random(), date:`${y}-${m.toString().padStart(2,'0')}-01`, exec:false, linkId:null, deletedAt:null, origAmt:r.amount, origCurr:'ARS', fromAccountId: r.type==='exp'?defAcc:null, toAccountId:r.type==='inc'?defAcc:null, children: []}); 
                    c++; 
                }
            }); 
            if(c>0){ pushHistory(); saveData(); alert('Generados: '+c);} else alert('Ya estaban cargados'); 
        }
        function autoAssign() { if(isMonthClosed()) return alert("Mes cerrado."); if(!confirm("¿Asignar automáticamente?")) return; const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1; const currentMonthTxs = appData.txs.filter(t => !t.deletedAt && t.type !== 'transfer' && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m); let incomes = currentMonthTxs.filter(t => t.type === 'inc').map(i => { const assigned = currentMonthTxs.filter(e => e.type === 'exp' && e.linkId == i.id).reduce((a,b)=>a+b.amount,0); return { ...i, balance: i.amount - assigned }; }); const unassignedExps = currentMonthTxs.filter(t => t.type === 'exp' && !t.linkId); let count = 0; let changesMade = false; unassignedExps.forEach(exp => { const validIncome = incomes.find(inc => inc.date <= exp.date && inc.balance >= exp.amount); if(validIncome) { if(!changesMade) { pushHistory(); changesMade = true; } exp.linkId = validIncome.id; validIncome.balance -= exp.amount; count++; } }); if(count > 0) { alert(`Asignados: ${count} gastos.`); saveData(); } else { alert("No se encontraron coincidencias válidas."); } }
        function unassignAll() { if(isMonthClosed()) return alert("Mes cerrado."); if(!confirm("¿Desvincular TODOS los gastos?")) return; pushHistory(); const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1; appData.txs.forEach(t => { if(!t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m && t.type === 'exp') { t.linkId = null; }}); saveData(); }
        function unassignGroup(incId) { if(isMonthClosed()) return alert("Mes cerrado."); if(!confirm("¿Desvincular gastos?")) return; pushHistory(); appData.txs.forEach(t => { if(t.type === 'exp' && t.linkId == incId) t.linkId = null; }); saveData(); }
        function populateRecurringDefaults() { if(!confirm("¿Sugerir recurrentes?")) return; const limitDate = new Date(); limitDate.setDate(limitDate.getDate() - 90); const recent = appData.txs.filter(t => !t.deletedAt && t.type === 'exp' && new Date(t.date) >= limitDate); const analysis = {}; recent.forEach(t => { const d = t.desc.trim(); if(!analysis[d]) analysis[d] = { count: 0, lastAmt: 0, cat: t.cat, dates: new Set() }; analysis[d].count++; analysis[d].lastAmt = t.origAmt || t.amount; analysis[d].cat = t.cat; analysis[d].dates.add(t.date.substring(0, 7)); }); let added = 0; let changesMade = false; Object.entries(analysis).forEach(([desc, data]) => { if((data.dates.size >= 2 || data.count >= 2) && !appData.recurrentes.some(r => r.desc.toLowerCase() === desc.toLowerCase())) { if(!changesMade) { pushHistory(); changesMade = true; } appData.recurrentes.push({ desc: desc, amount: data.lastAmt, cat: data.cat, type: 'exp' }); added++; } }); if(added === 0) alert("Sin novedades."); else alert(`Agregadas ${added} sugerencias.`); renderRecurrentesAdmin(); saveData(); }
        
        // --- NET WORTH LOGIC ---
        function renderNetWorthView() {
            const list = document.getElementById('list-accounts'); list.innerHTML = '';
            const rateARS = parseFloat(document.getElementById('rate_ARS').value) || 1200;
            const rateCOP = parseFloat(document.getElementById('rate_COP').value) || 3700;
            const rates = { ARS: rateARS, COP: rateCOP, USD: 1 };

            const balances = {}; 
            appData.accounts.forEach(a => balances[a.id] = (a.initBal || 0));
            const sortedTxs = appData.txs.filter(t => !t.deletedAt).sort((a,b) => a.date.localeCompare(b.date));
            
            sortedTxs.forEach(t => {
                const getAmountForAccount = (accId, tx) => {
                    const acc = appData.accounts.find(a => a.id === accId);
                    if (!acc) return 0;
                    if (acc.currency === 'USD') {
                        if (tx.origCurr === 'USD') return (tx.origAmt || tx.amount);
                        return tx.amount / rates.ARS; 
                    }
                    if (acc.currency === 'COP') {
                        if (tx.origCurr === 'COP') return (tx.origAmt || tx.amount);
                         return (tx.amount / rates.ARS) * rates.COP; 
                    }
                    return tx.amount; 
                };

                if(t.type === 'inc' && t.toAccountId) {
                    balances[t.toAccountId] = (balances[t.toAccountId] || 0) + getAmountForAccount(t.toAccountId, t);
                } else if(t.type === 'exp' && t.fromAccountId) {
                    balances[t.fromAccountId] = (balances[t.fromAccountId] || 0) - getAmountForAccount(t.fromAccountId, t);
                } else if(t.type === 'transfer' && t.fromAccountId && t.toAccountId) {
                    balances[t.fromAccountId] = (balances[t.fromAccountId] || 0) - getAmountForAccount(t.fromAccountId, t);
                    if (t.destAmount) {
                         balances[t.toAccountId] = (balances[t.toAccountId] || 0) + t.destAmount;
                    } else {
                        balances[t.toAccountId] = (balances[t.toAccountId] || 0) + getAmountForAccount(t.toAccountId, t);
                    }
                }
            });

            let totalAssets = 0, totalLiabs = 0;
            appData.accounts.forEach(a => {
                const bal = balances[a.id] || 0;
                const balARS = convertValue(bal, a.currency, rates);
                if (a.kind === 'asset') totalAssets += balARS; else totalLiabs += balARS;
                
                const el = document.createElement('div');
                el.className = "flex items-center justify-between p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 group";
                el.innerHTML = `
                    <div class="flex items-center gap-3 cursor-pointer" onclick="editAccount('${a.id}')">
                        <div class="size-8 rounded-full flex items-center justify-center ${a.kind==='asset'?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-600'}">
                            <span class="material-symbols-outlined text-lg">${a.kind==='asset'?'account_balance':'credit_card'}</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-700">${a.name}</p>
                            <p class="text-[10px] text-slate-400">${a.currency}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold ${bal >= 0 ? 'text-slate-700' : 'text-red-500'}">${a.currency} ${fmt(bal)}</p>
                        ${a.currency !== 'ARS' ? `<p class="text-[9px] text-slate-400">≈ $${fmt(balARS)}</p>` : ''}
                    </div>`;
                list.appendChild(el);
            });

            const nw = totalAssets + totalLiabs; 
            document.getElementById('nw-total').innerText = `$${fmt(nw)}`;
            document.getElementById('nw-usd').innerText = `USD ${fmt(nw / rateARS)}`;
            document.getElementById('nw-assets').innerText = `$${fmt(totalAssets)}`; 
            document.getElementById('nw-liabs').innerText = `$${fmt(totalLiabs)}`; 
            renderNetWorthChart();
            renderNetWorthComposition(balances, rates);
        }

        function convertValue(amt, curr, rates) {
            if (curr === 'ARS') return amt;
            if (curr === 'USD') return amt * rates.ARS;
            if (curr === 'COP') return (amt / rates.COP) * rates.ARS;
            return amt;
        }

        function renderNetWorthChart() {
            const ctx = document.getElementById('chartNetWorth');
            if(netWorthChartInst) netWorthChartInst.destroy();
            const labels = []; const dataAssets = []; const dataLiabs = []; const dataNet = [];
            let d = new Date(); d.setDate(1); d.setMonth(d.getMonth() - 11); 
            
            for(let i=0; i<12; i++) {
                const y = d.getFullYear(), m = d.getMonth() + 1;
                const key = `${y}-${m.toString().padStart(2,'0')}`;
                labels.push(MONTHS[d.getMonth()]);
                const monthRates = appData.monthlyRates[key] || { ARS: 1500, COP: 3700, USD: 1 };
                const endOfMonth = new Date(y, m, 0); 
                const subTxs = appData.txs.filter(t => !t.deletedAt && new Date(t.date) <= endOfMonth);
                const tmpBal = {};
                appData.accounts.forEach(a => tmpBal[a.id] = (a.initBal || 0));
                
                subTxs.forEach(t => {
                   if(t.type === 'inc' && t.toAccountId) tmpBal[t.toAccountId] = (tmpBal[t.toAccountId]||0) + (t.origAmt||t.amount);
                   else if(t.type === 'exp' && t.fromAccountId) tmpBal[t.fromAccountId] = (tmpBal[t.fromAccountId]||0) - (t.origAmt||t.amount);
                   else if(t.type === 'transfer') {
                       tmpBal[t.fromAccountId] = (tmpBal[t.fromAccountId]||0) - (t.origAmt||t.amount);
                       tmpBal[t.toAccountId] = (tmpBal[t.toAccountId]||0) + (t.origAmt||t.amount); 
                   }
                });
                let mAssets = 0, mLiabs = 0;
                appData.accounts.forEach(a => {
                    const val = convertValue(tmpBal[a.id], a.currency, monthRates);
                    if(a.kind === 'asset') mAssets += val; else mLiabs += val;
                });
                dataAssets.push(mAssets); dataLiabs.push(mLiabs); dataNet.push(mAssets + mLiabs);
                d.setMonth(d.getMonth() + 1);
            }

            netWorthChartInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Activos', data: dataAssets, backgroundColor: '#10b981', stack: 'Stack 0' },
                        { label: 'Pasivos', data: dataLiabs, backgroundColor: '#ef4444', stack: 'Stack 0' },
                        { type: 'line', label: 'Neto', data: dataNet, borderColor: '#0f172a', borderWidth: 2, tension: 0.3, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: {boxWidth: 8, font:{size:9}} } }, scales: { x: { grid: {display: false} }, y: { ticks: { callback: (v) => '$' + (v/1000000).toFixed(1) + 'M', font:{size:9} } } } }
            });
        }
        
        function renderNetWorthComposition(balances, rates) {
            const cvs = document.getElementById('chartNWComp');
            if(cNWComp) cNWComp.destroy();
            const data = []; const labels = [];
            appData.accounts.filter(a => a.kind === 'asset').forEach(a => {
                 const val = convertValue(balances[a.id] || 0, a.currency, rates);
                 if(val > 0) { labels.push(a.name); data.push(val); }
            });
            cNWComp = new Chart(cvs, { type:'doughnut', data:{ labels:labels, datasets:[{data:data, backgroundColor:PALETTE, borderWidth:0}] }, options:{ responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{legend:{display:false}} } });
        }

        // --- ACCOUNT MODAL ---
        function openAccountModal() { editAccId=null; document.getElementById('accForm').reset(); document.getElementById('btnDelAcc').classList.add('hidden'); document.getElementById('accModal').classList.remove('hidden'); }
        function closeAccountModal() { document.getElementById('accModal').classList.add('hidden'); }
        function editAccount(id) {
            editAccId = id; const a = appData.accounts.find(x => x.id === id);
            document.getElementById('accName').value = a.name;
            document.getElementById('accKind').value = a.kind;
            document.getElementById('accCurr').value = a.currency;
            document.getElementById('accInit').value = a.initBal;
            document.getElementById('btnDelAcc').classList.remove('hidden');
            document.getElementById('accModal').classList.remove('hidden');
        }
        function saveAccount(e) {
            e.preventDefault(); pushHistory();
            const acc = {
                id: editAccId || 'acc_'+Date.now(),
                name: document.getElementById('accName').value,
                kind: document.getElementById('accKind').value,
                currency: document.getElementById('accCurr').value,
                initBal: parseFloat(document.getElementById('accInit').value) || 0
            };
            if(editAccId) { const i = appData.accounts.findIndex(x=>x.id===editAccId); appData.accounts[i] = acc; }
            else appData.accounts.push(acc);
            saveData(); closeAccountModal();
        }
        function deleteAccount() {
            if(!confirm('¿Eliminar cuenta?')) return;
            pushHistory();
            appData.accounts = appData.accounts.filter(x => x.id !== editAccId);
            saveData(); closeAccountModal();
        }
    </script>
</body>
</html>
