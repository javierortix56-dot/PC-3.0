<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FinanceFlow PRO | Javi</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#0e757c", "primary-dark": "#085055", "success": "#558055", "danger": "#b91c1c", "warning": "#D4A373" },
                    fontFamily: { "display": ["Manrope", "sans-serif"], "body": ["Inter", "sans-serif"] }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Manrope', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .hidden-view { display: none !important; }
        .active-nav { background-color: rgba(14, 117, 124, 0.1); color: #0e757c; border-right: 3px solid #0e757c; }
        .d-picker { position: absolute; inset:0; opacity:0; cursor: pointer; width: 100%; }
        .compact-row { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        /* Animación suave */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>

<body class="bg-[#f0f2f2] text-slate-900 h-screen flex overflow-hidden selection:bg-primary/20">

    <aside class="w-16 hover:w-60 transition-all duration-300 group fixed h-screen z-40 flex flex-col justify-between py-4 bg-white shadow-xl border-r border-slate-200">
        <div class="flex flex-col gap-6">
            <div class="flex items-center justify-center h-10 group-hover:justify-start group-hover:px-4 transition-all">
                <div class="bg-primary size-9 rounded-xl flex items-center justify-center text-white shrink-0 shadow-md">
                    <span class="material-symbols-outlined text-xl">account_balance_wallet</span>
                </div>
                <h1 class="font-bold text-lg text-primary ml-3 opacity-0 group-hover:opacity-100 transition-opacity overflow-hidden whitespace-nowrap">FinanceFlow OS</h1>
            </div>
            
            <nav class="flex flex-col gap-1 px-2" id="main-nav">
                <button onclick="nav('dashboard', this)" id="nav-dashboard" class="active-nav flex items-center h-11 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">dashboard</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Operaciones</span>
                </button>
                <button onclick="nav('analytics', this)" class="flex items-center h-11 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">pie_chart</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Análisis</span>
                </button>
                <button onclick="nav('strategy', this)" class="flex items-center h-11 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">monitoring</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Estrategia</span>
                </button>
                <button onclick="nav('admin', this)" class="flex items-center h-11 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">settings</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Ajustes</span>
                </button>
            </nav>
        </div>
        
        <div class="px-2">
            <button onclick="openModal()" class="flex items-center justify-center w-full h-11 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-lg transition-all group-hover:justify-start group-hover:px-3 mb-4 overflow-hidden">
                <span class="material-symbols-outlined text-xl">add</span>
                <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Nuevo Movimiento</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 ml-16 p-5 lg:p-8 h-screen overflow-hidden flex flex-col relative">
        
        <header class="flex justify-between items-center mb-6 shrink-0">
            <div class="flex flex-col">
                <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight" id="pageTitle">Panel de Control</h2>
                <div class="flex items-center gap-2 text-slate-500 relative cursor-pointer hover:text-primary transition-colors mt-1">
                    <button onclick="changeMonth(-1)" class="hover:bg-slate-200 rounded p-1"><span class="material-symbols-outlined text-base">chevron_left</span></button>
                    <div class="relative">
                        <span class="text-sm font-bold uppercase tracking-wide flex items-center gap-1">
                            <span class="material-symbols-outlined text-base">calendar_today</span>
                            <span id="monthTxt">...</span>
                        </span>
                        <input type="month" id="datePicker" class="d-picker" onchange="manualDate()">
                    </div>
                    <button onclick="changeMonth(1)" class="hover:bg-slate-200 rounded p-1"><span class="material-symbols-outlined text-base">chevron_right</span></button>
                </div>
            </div>

            <div class="flex items-center bg-white border border-slate-200 rounded-lg shadow-sm h-10 px-4 gap-3">
                <span class="material-symbols-outlined text-slate-400">currency_exchange</span>
                <div class="flex flex-col items-end leading-none">
                    <span class="text-[9px] font-bold text-slate-400 uppercase">Dólar Base (ARS)</span>
                    <span class="text-sm font-bold text-slate-700" id="headerRateDisplay">$0</span>
                </div>
            </div>
        </header>

        <section class="grid grid-cols-4 gap-4 mb-6 shrink-0">
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center h-24">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Balance (ARS)</p>
                <h3 class="text-2xl font-extrabold text-slate-800" id="k-bal">$0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center h-24">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Estimado USD</p>
                <h3 class="text-2xl font-extrabold text-primary" id="k-usd">$0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center h-24">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Ingresos</p>
                <h3 class="text-2xl font-extrabold text-success" id="k-inc">$0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center h-24">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Gastos</p>
                <h3 class="text-2xl font-extrabold text-danger" id="k-exp">$0</h3>
            </div>
        </section>

        <div id="view-dashboard" class="view-container grid grid-cols-1 xl:grid-cols-3 gap-6 flex-1 min-h-0 fade-in">
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-4 py-3 border-b bg-slate-50/50 flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-2">
                        <span class="material-symbols-outlined text-base text-success">arrow_circle_up</span>Ingresos
                    </span>
                    <span class="bg-success/10 text-success text-[10px] font-bold px-2 py-0.5 rounded-full" id="c-inc">0</span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2" id="list-inc"></div>
            </section>
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-4 py-3 border-b bg-slate-50/50 flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-2">
                        <span class="material-symbols-outlined text-base text-danger">arrow_circle_down</span>Gastos
                    </span>
                    <span class="bg-danger/10 text-danger text-[10px] font-bold px-2 py-0.5 rounded-full" id="c-exp">0</span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2" id="list-exp"></div>
            </section>
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-4 py-3 border-b bg-slate-50/50 flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-2">
                        <span class="material-symbols-outlined text-base text-primary">pie_chart</span>Asignación
                    </span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3" id="list-alloc"></div>
            </section>
        </div>

        <div id="view-analytics" class="view-container hidden-view grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0 fade-in">
            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm flex flex-col h-full">
                <div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-slate-600 uppercase">Gastos por Categoría</h3></div>
                <div class="flex items-center gap-6 flex-1 overflow-hidden">
                    <div class="relative h-[220px] w-[220px] shrink-0"><canvas id="chartExp"></canvas></div>
                    <div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-2" id="legExp"></div>
                </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm flex flex-col h-full">
                <div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-slate-600 uppercase">Ingresos por Concepto</h3></div>
                <div class="flex items-center gap-6 flex-1 overflow-hidden">
                    <div class="relative h-[220px] w-[220px] shrink-0"><canvas id="chartInc"></canvas></div>
                    <div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-2" id="legInc"></div>
                </div>
            </div>
        </div>

        <div id="view-strategy" class="view-container hidden-view grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0 fade-in">
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-600 uppercase flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">psychology</span> Financial Twin
                    </h3>
                </div>
                <div class="flex-1 relative flex justify-center items-center">
                    <canvas id="chartRadar" style="max-height: 300px;"></canvas>
                </div>
                <p class="text-xs text-center text-slate-400 mt-2">Comparativa vs Perfil Ideal Ingeniero</p>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-bold text-slate-600 uppercase flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">savings</span> Portafolio Inversiones
                    </h3>
                    <span class="bg-primary/10 text-primary text-xs font-bold px-3 py-1 rounded-full">Total: $0 USD</span>
                </div>
                
                <div class="flex-1 flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                    <span class="material-symbols-outlined text-5xl text-slate-300 mb-3">hub</span>
                    <p class="text-sm font-bold text-slate-600">Conectividad API</p>
                    <p class="text-xs text-slate-400 max-w-[250px] mt-2">Próximamente: Visualización en tiempo real de CEDEARs, Crypto y Bonos.</p>
                    <button class="mt-4 text-xs bg-white border border-slate-200 px-4 py-2 rounded-lg shadow-sm hover:border-primary hover:text-primary font-bold transition-all">Configurar API</button>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-container hidden-view grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0 fade-in">
            
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-6 flex flex-col h-full overflow-hidden">
                <h3 class="text-sm font-bold text-slate-800 uppercase mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">currency_exchange</span> Tasas del Mes (Base 1 USD)
                </h3>
                <div class="bg-blue-50 text-blue-800 p-3 rounded-lg text-xs mb-4">
                    <strong>Configuración Global:</strong> Define cuánto vale 1 USD en cada moneda para el mes seleccionado.
                </div>

                <div class="space-y-4 overflow-y-auto custom-scrollbar pr-2 flex-1">
                    <div class="flex justify-between items-center p-2 hover:bg-slate-50 rounded">
                        <span class="text-sm font-bold text-slate-600">ARS (Peso Arg)</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400">1 USD =</span>
                            <input type="number" id="rate_ARS" onchange="saveMonthlyRates()" class="w-24 text-right text-sm border-slate-300 rounded focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                    <div class="flex justify-between items-center p-2 hover:bg-slate-50 rounded">
                        <span class="text-sm font-bold text-slate-600">EUR (Euro)</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400">1 USD =</span>
                            <input type="number" id="rate_EUR" step="0.01" onchange="saveMonthlyRates()" class="w-24 text-right text-sm border-slate-300 rounded focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                    <div class="flex justify-between items-center p-2 hover:bg-slate-50 rounded">
                        <span class="text-sm font-bold text-slate-600">COP (Col)</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400">1 USD =</span>
                            <input type="number" id="rate_COP" step="0.01" onchange="saveMonthlyRates()" class="w-24 text-right text-sm border-slate-300 rounded focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                    <div class="flex justify-between items-center p-2 hover:bg-slate-50 rounded">
                        <span class="text-sm font-bold text-slate-600">BRL (Real)</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400">1 USD =</span>
                            <input type="number" id="rate_BRL" step="0.01" onchange="saveMonthlyRates()" class="w-24 text-right text-sm border-slate-300 rounded focus:ring-primary focus:border-primary">
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-6 flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-800 uppercase flex items-center gap-2">
                        <span class="material-symbols-outlined text-base">update</span> Plantillas Recurrentes
                    </h3>
                    <button onclick="addRecurrenteRow()" class="text-primary text-xs font-bold hover:underline">+ Agregar Fila</button>
                </div>
                
                <div class="grid grid-cols-12 gap-2 text-[10px] font-bold text-slate-400 uppercase mb-2 px-2">
                    <div class="col-span-4">Concepto</div>
                    <div class="col-span-3 text-right">Monto (ARS)</div>
                    <div class="col-span-3">Tipo</div>
                    <div class="col-span-2"></div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar space-y-2" id="recurrente-table-body">
                    </div>

                <div class="mt-4 pt-4 border-t border-slate-100 flex flex-col gap-2">
                    <button onclick="saveRecurrentesConfig()" class="w-full bg-slate-100 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-slate-200">Guardar Cambios Planilla</button>
                    <button onclick="executeRecurrentes()" class="w-full bg-slate-800 text-white py-3 rounded-lg text-xs font-bold hover:bg-slate-700 shadow-lg flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">play_arrow</span> EJECUTAR EN MES ACTUAL
                    </button>
                </div>
            </div>
            
            <div class="lg:col-span-2 bg-white border border-slate-200 rounded-xl shadow-sm p-4 flex justify-between items-center">
                 <div class="flex gap-4">
                     <button onclick="cloneMonth()" class="text-xs font-bold text-slate-600 hover:text-primary">Clonar mes anterior</button>
                     <input type="month" id="cloneSrc" class="text-xs border-slate-200 rounded p-1">
                 </div>
                 <button onclick="clearMonth()" class="text-xs font-bold text-red-500 hover:underline">Eliminar datos del mes</button>
            </div>
        </div>

    </main>

    <div id="modalOverlay" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative z-10 w-full max-w-[450px] bg-white rounded-2xl shadow-2xl flex flex-col animate-fade-in mx-4 overflow-hidden max-h-[95vh]">
            <div class="px-6 pt-5 pb-3 flex justify-between items-center border-b border-slate-100 bg-slate-50">
                <h1 class="text-lg font-bold text-slate-800" id="mTitle">Nuevo Movimiento</h1>
                <button onclick="closeModal()" class="size-8 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <form id="txForm" class="p-6 flex flex-col gap-5 overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-2 p-1 bg-slate-100 rounded-lg">
                    <button type="button" id="btnExp" onclick="setType('exp')" class="py-2 text-xs font-bold rounded-md transition-all">Gasto</button>
                    <button type="button" id="btnInc" onclick="setType('inc')" class="py-2 text-xs font-bold rounded-md transition-all">Ingreso</button>
                </div>
                <input type="hidden" id="fType" value="exp">

                <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Monto & Moneda Original</label>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <input type="number" id="fAmt" step="0.01" class="w-full pl-3 pr-2 py-2 bg-white border-slate-200 rounded-lg text-lg font-bold focus:ring-primary focus:border-primary text-right" placeholder="0" required oninput="calcConversion()">
                        </div>
                        <div class="w-24">
                            <select id="fCurr" onchange="calcConversion()" class="w-full py-2.5 bg-white border-slate-200 rounded-lg text-xs font-bold focus:ring-primary focus:border-primary">
                                <option value="ARS">ARS</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="COP">COP</option>
                                <option value="BRL">BRL</option>
                            </select>
                        </div>
                    </div>
                    <div id="convPreview" class="hidden mt-2 text-right">
                        <span class="text-[10px] text-slate-500 mr-1">Equivale a:</span>
                        <span class="font-bold text-sm text-slate-800" id="convResult">$0 ARS</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Fecha</label>
                        <input type="date" id="fDate" class="w-full py-2 bg-white border-slate-200 rounded-lg text-xs font-medium focus:ring-primary focus:border-primary" required>
                    </div>
                    <div id="catRow">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Categoría</label>
                        <select id="fCatSel" class="w-full py-2 bg-white border-slate-200 rounded-lg text-xs font-medium focus:ring-primary focus:border-primary"></select>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Concepto / Detalle</label>
                    <input type="text" id="fDesc" class="w-full py-2 bg-white border-slate-200 rounded-lg text-sm font-medium focus:ring-primary focus:border-primary" placeholder="Ej: Supermercado, Cena..." required>
                </div>
                
                <div id="linkRow">
                    <label class="block text-[10px] font-bold text-primary uppercase mb-1">Fuente de Pago</label>
                    <select id="fLink" class="w-full py-2 bg-white border-slate-200 rounded-lg text-xs font-medium focus:ring-primary focus:border-primary"></select>
                </div>

                <div class="flex items-center gap-3 py-2">
                    <input type="checkbox" id="fExec" class="size-4 text-primary rounded border-slate-300 focus:ring-primary">
                    <label for="fExec" class="text-xs font-bold text-slate-700 cursor-pointer select-none">Marcar como ejecutado</label>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="submit" class="flex-1 py-3 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-lg hover:bg-slate-800 transition-all active:scale-95">GUARDAR</button>
                    <button type="button" id="btnDel" onclick="delTx()" class="hidden px-4 py-3 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 transition-all">ELIMINAR</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec"; // Reemplaza con tu URL
        
        const MONTHS = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const PALETTE = ['#0e757c','#558055','#D4A373','#996A5C','#334155','#64748b'];
        
        // Estructura de Datos Principal
        let appData = { 
            txs: [], 
            cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Venta','Otros'] }, 
            recurrentes: [], // Ahora vive en la base de datos
            monthlyRates: {} // Formato: {'2026-01': {ARS:1120, EUR:0.95...}}
        };
        
        // Variables de Estado
        let currentDate = new Date(); currentDate.setDate(1);
        let editId=null, cExp=null, cInc=null, cRadar=null;
        
        // Helpers
        const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        // --- INIT ---
        window.onload = () => { 
            updateDateUI(); 
            forceSync(); 
            Chart.defaults.font.family = "'Inter', sans-serif";
        };

        // --- CORE SYNC ---
        async function forceSync() {
            try { 
                const r = await fetch(API_URL); 
                const data = await r.json();
                
                // Merge seguro de datos
                appData.txs = data.txs || [];
                appData.cats = data.cats || appData.cats;
                appData.recurrentes = data.recurrentes || [];
                appData.monthlyRates = data.monthlyRates || {};
                
                loadMonthData(); 
            } catch(e){ console.error("Error Sync:", e); alert("Error de conexión. Trabajando offline (visual)."); }
        }
        
        async function saveData() {
            try { 
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(appData) }); 
                loadMonthData(); 
            } catch(e){ alert('Error guardando en la nube.'); }
        }

        // --- DATA LOADING & CALCS ---
        function loadMonthData() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth() + 1;
            const key = `${y}-${m.toString().padStart(2,'0')}`;
            
            // 1. Cargar Tasas del Mes (o Default)
            let rates = appData.monthlyRates[key];
            if (!rates) {
                // Default fallback values (Base 1 USD)
                rates = { ARS: 1120, EUR: 0.92, COP: 4000, BRL: 5.0, USD: 1 };
            }
            // Actualizar inputs en Admin
            document.getElementById('rate_ARS').value = rates.ARS;
            document.getElementById('rate_EUR').value = rates.EUR;
            document.getElementById('rate_COP').value = rates.COP;
            document.getElementById('rate_BRL').value = rates.BRL;
            document.getElementById('headerRateDisplay').innerText = `$${rates.ARS}`;

            // 2. Filtrar Transacciones
            const txs = appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
            txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
            
            // 3. Renderizar todo
            renderLists(txs); 
            renderCharts(txs); 
            updateKPIs(txs);
            renderRecurrentesAdmin(); // Renderizar tabla admin
        }

        // --- RENDER LISTS ---
        function renderLists(txs) {
            const lI=document.getElementById('list-inc'), lE=document.getElementById('list-exp'), lA=document.getElementById('list-alloc');
            lI.innerHTML=''; lE.innerHTML=''; lA.innerHTML=''; let rb=0;

            txs.forEach(t => {
                if(t.type=='inc') rb+=t.amount; else rb-=t.amount;
                
                // Badge Moneda
                let currBadge = '';
                if(t.origCurr && t.origCurr !== 'ARS') {
                    currBadge = `<span class="bg-blue-50 text-blue-600 border border-blue-100 text-[9px] px-1.5 rounded ml-2 font-bold">${t.origAmt} ${t.origCurr}</span>`;
                }

                const el = document.createElement('div');
                const styles = t.exec ? "opacity-50 grayscale" : "";
                const strike = t.exec ? "line-through decoration-slate-400" : "";
                
                el.className = `compact-row flex items-center justify-between px-2 hover:bg-slate-50 cursor-pointer border-b border-dashed border-slate-100 last:border-0 ${styles}`;
                el.onclick = () => editTx(t.id);
                
                el.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="size-8 rounded-lg bg-slate-50 flex items-center justify-center shrink-0 border border-slate-100">
                            <span class="material-symbols-outlined text-sm ${t.type=='inc'?'text-success':'text-danger'}">circle</span>
                        </div>
                        <div class="min-w-0">
                            <div class="flex items-center">
                                <p class="text-xs font-bold text-slate-700 truncate leading-tight ${strike}">${t.desc}</p>
                                ${currBadge}
                            </div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[9px] text-slate-400 bg-slate-50 px-1.5 rounded border border-slate-100">${t.cat}</span>
                                <span class="text-[9px] text-slate-400">${t.date.split('-')[2]}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right shrink-0 ml-2">
                        <p class="text-xs font-bold ${t.type=='inc'?'text-success':'text-danger'} ${strike}">$${fmt(t.amount)}</p>
                    </div>
                `;
                (t.type=='inc'?lI:lE).appendChild(el);
            });
            
            document.getElementById('c-inc').innerText = txs.filter(t=>t.type=='inc').length;
            document.getElementById('c-exp').innerText = txs.filter(t=>t.type=='exp').length;

            // Allocation (Sin cambios visuales mayores)
            const incs = txs.filter(t=>t.type=='inc');
            if(!incs.length) lA.innerHTML = '<div class="text-center text-slate-400 text-xs py-4">Sin ingresos registrados</div>';
            
            incs.forEach(inc => {
                const subs = txs.filter(t=>t.type=='exp' && t.linkId==inc.id);
                const spent = subs.reduce((a,b)=>a+b.amount,0);
                const pct = Math.min(100, (spent/inc.amount)*100);
                let barColor = pct > 90 ? (spent > inc.amount ? 'bg-danger' : 'bg-warning') : 'bg-primary';

                let rows = '';
                subs.forEach(s => rows += `<div class="flex justify-between py-1 text-[10px] border-b border-dashed border-slate-100 text-slate-500"><span class="truncate">${s.desc}</span><span>$${fmt(s.amount)}</span></div>`);

                const card = document.createElement('div');
                card.innerHTML = `
                    <div class="rounded-lg border border-slate-100 bg-white mb-2 shadow-sm overflow-hidden">
                        <div class="p-2 bg-slate-50/50 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors" onclick="this.nextElementSibling.nextElementSibling.classList.toggle('hidden')">
                            <div><p class="text-xs font-bold text-slate-700">${inc.desc}</p><p class="text-[9px] text-slate-500">$${fmt(spent)} / $${fmt(inc.amount)}</p></div>
                            <span class="text-[10px] font-bold text-slate-600">${Math.round(pct)}%</span>
                        </div>
                        <div class="w-full h-1 bg-slate-100"><div class="h-full ${barColor}" style="width: ${pct}%;"></div></div>
                        <div class="hidden bg-white p-2 border-t border-slate-100">${rows || '<span class="text-[9px] italic text-slate-400">Sin gastos asignados</span>'}</div>
                    </div>`;
                lA.appendChild(card);
            });
        }

        // --- CHARTS ---
        function renderCharts(txs) {
            renderDoughnut(document.getElementById('chartExp'), document.getElementById('legExp'), txs.filter(t=>t.type=='exp'), 'cat', cExp, i=>cExp=i);
            renderDoughnut(document.getElementById('chartInc'), document.getElementById('legInc'), txs.filter(t=>t.type=='inc'), 'desc', cInc, i=>cInc=i);
            
            // Radar
            if(cRadar) cRadar.destroy();
            const totalInc = txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0) || 1;
            const savings = txs.filter(t=>t.cat=='Ahorro').reduce((a,b)=>a+b.amount,0);
            const fixed = txs.filter(t=>t.cat=='Esenciales').reduce((a,b)=>a+b.amount,0);
            const ctxR = document.getElementById('chartRadar');
            cRadar = new Chart(ctxR, {
                type: 'radar',
                data: {
                    labels: ['Ahorro', 'Fijos', 'Ocio', 'Inversión', 'Ejecución'],
                    datasets: [{
                        label: 'Real', data: [Math.min(100, (savings/totalInc)*100), Math.min(100, (fixed/totalInc)*100), 30, 20, 85],
                        fill: true, backgroundColor: 'rgba(14, 117, 124, 0.2)', borderColor: '#0e757c', pointBackgroundColor: '#0e757c'
                    }, {
                        label: 'Ideal', data: [30, 50, 20, 20, 100],
                        fill: true, backgroundColor: 'rgba(203, 213, 225, 0.2)', borderColor: '#cbd5e1', pointBackgroundColor: '#cbd5e1', borderDash: [5, 5]
                    }]
                },
                options: { scales: { r: { min: 0, max: 100, ticks: { display: false } } }, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderDoughnut(cvs, leg, data, key, inst, setInst) {
            if(inst) inst.destroy();
            let map={}; data.forEach(t=>{const k=t[key]||'Gral'; map[k]=(map[k]||0)+t.amount;});
            const ent=Object.entries(map).sort((a,b)=>b[1]-a[1]);
            setInst(new Chart(cvs, {
                type:'doughnut', 
                data:{labels:ent.map(e=>e[0]), datasets:[{data:ent.map(e=>e[1]), backgroundColor:PALETTE, borderWidth:0, hoverOffset:2}]},
                options:{responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{display:false}}}
            }));
            leg.innerHTML='';
            ent.forEach((e,i)=>{
                leg.innerHTML+=`<div class="flex justify-between py-1.5 border-b border-dashed border-slate-100 text-[10px]"><div class="flex items-center gap-2"><span class="size-2 rounded-full" style="background:${PALETTE[i%PALETTE.length]}"></span><span class="font-medium text-slate-600">${e[0]}</span></div><span class="font-bold text-slate-800">$${fmt(e[1])}</span></div>`;
            });
        }

        // --- GESTIÓN DE TASAS MENSUALES (ADMIN) ---
        function saveMonthlyRates() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth() + 1;
            const key = `${y}-${m.toString().padStart(2,'0')}`;

            appData.monthlyRates[key] = {
                ARS: parseFloat(document.getElementById('rate_ARS').value) || 1120,
                EUR: parseFloat(document.getElementById('rate_EUR').value) || 0.92,
                COP: parseFloat(document.getElementById('rate_COP').value) || 4000,
                BRL: parseFloat(document.getElementById('rate_BRL').value) || 5.0,
                USD: 1 // Base
            };
            saveData();
            document.getElementById('headerRateDisplay').innerText = `$${appData.monthlyRates[key].ARS}`;
            alert(`Tasas guardadas para ${key}`);
        }

        // --- GESTIÓN DE RECURRENTES (ADMIN - PLANILLA CONFIGURABLE) ---
        function renderRecurrentesAdmin() {
            const tbody = document.getElementById('recurrente-table-body');
            tbody.innerHTML = '';
            
            // Si no hay recurrentes, iniciar con unos ejemplos (solo la primera vez)
            if(!appData.recurrentes || appData.recurrentes.length === 0) {
                 appData.recurrentes = []; // Empty start
            }

            appData.recurrentes.forEach((r, index) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-12 gap-2 items-center border-b border-slate-100 py-2';
                div.innerHTML = `
                    <div class="col-span-4"><input type="text" value="${r.desc}" onchange="updateRec(${index}, 'desc', this.value)" class="w-full text-xs border-slate-200 rounded px-1 py-1"></div>
                    <div class="col-span-3"><input type="number" value="${r.amount}" onchange="updateRec(${index}, 'amount', this.value)" class="w-full text-xs border-slate-200 rounded px-1 py-1 text-right"></div>
                    <div class="col-span-3">
                        <select onchange="updateRec(${index}, 'cat', this.value)" class="w-full text-xs border-slate-200 rounded px-1 py-1">
                            <option value="Esenciales" ${r.cat=='Esenciales'?'selected':''}>Esenciales</option>
                            <option value="Personal" ${r.cat=='Personal'?'selected':''}>Personal</option>
                            <option value="Ingresos" ${r.cat=='Ingresos'?'selected':''}>Ingresos</option>
                        </select>
                    </div>
                    <div class="col-span-2 text-right">
                        <button onclick="deleteRec(${index})" class="text-red-500 hover:text-red-700"><span class="material-symbols-outlined text-sm">delete</span></button>
                    </div>
                `;
                tbody.appendChild(div);
            });
        }

        function addRecurrenteRow() {
            appData.recurrentes.push({ desc: 'Nuevo Gasto', amount: 0, cat: 'Esenciales', type: 'exp' });
            renderRecurrentesAdmin();
        }

        function updateRec(idx, field, val) {
            if(field === 'amount') val = parseFloat(val);
            appData.recurrentes[idx][field] = val;
            if(field === 'cat' && val === 'Ingresos') appData.recurrentes[idx].type = 'inc';
        }

        function deleteRec(idx) {
            if(confirm('¿Borrar plantilla?')) {
                appData.recurrentes.splice(idx, 1);
                renderRecurrentesAdmin();
            }
        }

        function saveRecurrentesConfig() {
            saveData();
            alert('Configuración de recurrentes guardada.');
        }

        function executeRecurrentes() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            const targetDate = `${y}-${m.toString().padStart(2,'0')}-01`;
            let count = 0;
            appData.recurrentes.forEach(rec => {
                const exists = appData.txs.some(t => !t.deletedAt && t.desc === rec.desc && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
                if (!exists) {
                    appData.txs.push({
                        id: Date.now() + Math.random(),
                        date: targetDate, amount: rec.amount, type: rec.type, cat: rec.cat, desc: rec.desc,
                        exec: false, linkId: null, deletedAt: null, origAmt: rec.amount, origCurr: 'ARS'
                    });
                    count++;
                }
            });
            if (count > 0) { saveData(); alert(`Generados ${count} movimientos.`); } else { alert('Ya estaban cargados este mes.'); }
        }


        // --- LOGICA MULTIMONEDA (CONVERSION USD BASE) ---
        function calcConversion() {
            const amt = parseFloat(document.getElementById('fAmt').value) || 0;
            const curr = document.getElementById('fCurr').value;
            
            // Obtener tasas actuales
            const y = document.getElementById('fDate').value.split('-')[0] || currentDate.getFullYear();
            const m = document.getElementById('fDate').value.split('-')[1] || (currentDate.getMonth()+1);
            // Intentar buscar tasas del mes de la fecha seleccionada, si no, usar las actuales de la UI
            // Simplificación: usaremos las de los inputs del admin que reflejan el mes actual visualizado
            
            const rateARS = parseFloat(document.getElementById('rate_ARS').value); 
            let finalARS = 0;

            if (curr === 'ARS') {
                finalARS = amt;
            } else if (curr === 'USD') {
                finalARS = amt * rateARS;
            } else {
                // Cross rate: Si tengo COP. 
                // 1 USD = 4000 COP.  1 USD = 1120 ARS.
                // Input: 4000 COP -> (4000 / 4000) * 1120 = 1120 ARS.
                const rateSource = parseFloat(document.getElementById(`rate_${curr}`).value);
                finalARS = (amt / rateSource) * rateARS;
            }

            document.getElementById('convResult').innerText = `$${fmt(finalARS)} ARS`;
            
            const prev = document.getElementById('convPreview');
            if(curr !== 'ARS' && amt > 0) prev.classList.remove('hidden'); else prev.classList.add('hidden');
            
            return finalARS;
        }

        // --- FORM HANDLING ---
        function openModal(){ resetForm(); setType('exp'); document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex'); }
        function closeModal(){ document.getElementById('modalOverlay').classList.add('hidden'); document.getElementById('modalOverlay').classList.remove('flex'); }
        
        function resetForm(){ 
            document.getElementById('txForm').reset(); 
            document.getElementById('mTitle').innerText = 'Nuevo Movimiento';
            document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; 
            document.getElementById('convPreview').classList.add('hidden');
            document.getElementById('btnDel').classList.add('hidden');
            editId = null;
        }

        function editTx(id) {
            const t = appData.txs.find(x => x.id == id);
            if(!t) return;
            
            editId = id;
            document.getElementById('mTitle').innerText = 'Editar Movimiento';
            document.getElementById('btnDel').classList.remove('hidden');
            
            // Llenar campos
            document.getElementById('fDate').value = t.date;
            document.getElementById('fDesc').value = t.desc;
            document.getElementById('fExec').checked = t.exec;
            
            // Currency fields
            document.getElementById('fAmt').value = t.origAmt || t.amount;
            document.getElementById('fCurr').value = t.origCurr || 'ARS';
            
            setType(t.type);
            
            // Set Cat (Delay needed for select population)
            setTimeout(() => {
                if(t.type === 'exp') {
                    document.getElementById('fCatSel').value = t.cat;
                    document.getElementById('fLink').value = t.linkId || "";
                }
            }, 50);

            // Calc preview
            calcConversion();
            
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
        }

        function setType(t){
            document.getElementById('fType').value=t;
            const e=document.getElementById('btnExp'), i=document.getElementById('btnInc');
            if(t=='exp'){
                e.className="flex-1 py-2 text-xs font-bold rounded-md bg-white text-danger shadow-sm border border-slate-200 transition-all";
                i.className="flex-1 py-2 text-xs font-bold rounded-md text-slate-400 hover:bg-slate-50 transition-all";
                document.getElementById('catRow').classList.remove('hidden'); document.getElementById('linkRow').classList.remove('hidden');
                fillSelect('fCatSel', appData.cats.exp); fillLinkOpts();
            } else {
                i.className="flex-1 py-2 text-xs font-bold rounded-md bg-white text-success shadow-sm border border-slate-200 transition-all";
                e.className="flex-1 py-2 text-xs font-bold rounded-md text-slate-400 hover:bg-slate-50 transition-all";
                document.getElementById('catRow').classList.add('hidden'); document.getElementById('linkRow').classList.add('hidden');
            }
        }
        
        function fillSelect(id, arr){ const s=document.getElementById(id); s.innerHTML=''; arr.forEach(x=>s.add(new Option(x,x))); }
        
        function fillLinkOpts(){
            const s=document.getElementById('fLink'); s.innerHTML='<option value="">-- Sin Asignar --</option>';
            const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
            appData.txs.filter(t=>t.type=='inc' && parseInt(t.date.split('-')[1])==m).forEach(i=>{
                const sp=appData.txs.filter(x=>x.linkId==i.id && x.id != editId).reduce((a,b)=>a+b.amount,0);
                s.add(new Option(`${i.desc} (Disp: $${fmt(i.amount-sp)})`, i.id));
            });
        }

        document.getElementById('txForm').onsubmit=e=>{
            e.preventDefault();
            const type = document.getElementById('fType').value;
            const origAmt = parseFloat(document.getElementById('fAmt').value);
            const curr = document.getElementById('fCurr').value;
            
            // Calcular ARS final
            const finalAmt = calcConversion(); 

            const tx={
                id: editId || Date.now(), 
                date: document.getElementById('fDate').value,
                amount: finalAmt, 
                origAmt: origAmt, 
                origCurr: curr,
                type, 
                cat: type=='exp'?document.getElementById('fCatSel').value:null, 
                desc: document.getElementById('fDesc').value, 
                exec: document.getElementById('fExec').checked,
                linkId: type=='exp'?document.getElementById('fLink').value:null, 
                deletedAt: null
            };
            
            if(editId) {
                const idx = appData.txs.findIndex(x => x.id == editId);
                if(idx > -1) appData.txs[idx] = tx;
            } else {
                appData.txs.push(tx);
            }
            
            saveData(); closeModal();
        }

        function delTx() {
            if(confirm('¿Eliminar este movimiento?')) {
                const idx = appData.txs.findIndex(x => x.id == editId);
                if(idx > -1) {
                    appData.txs[idx].deletedAt = Date.now();
                    saveData();
                    closeModal();
                }
            }
        }

        // --- KPI & NAV ---
        function updateKPIs(txs){
            const i=txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
            const e=txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
            document.getElementById('k-inc').innerText='$'+fmt(i); document.getElementById('k-exp').innerText='$'+fmt(e);
            document.getElementById('k-bal').innerText='$'+fmt(i-e); 
            // Estimado USD usando la tasa del mes
            const rateUSD = parseFloat(document.getElementById('rate_ARS').value) || 1;
            document.getElementById('k-usd').innerText='USD '+fmt((i-e)/rateUSD);
        }

        function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); updateDateUI(); loadMonthData(); }
        function manualDate(){ const[y,m]=document.getElementById('datePicker').value.split('-'); currentDate.setFullYear(y); currentDate.setMonth(m-1); updateDateUI(); loadMonthData(); }
        function updateDateUI(){ document.getElementById('monthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }
        
        function nav(v, el){ 
            document.querySelectorAll('.view-container').forEach(e=>e.classList.add('hidden-view')); 
            document.getElementById(`view-${v}`).classList.remove('hidden-view'); 
            document.querySelectorAll('#main-nav button').forEach(e=>{ e.classList.remove('active-nav'); e.classList.add('text-slate-500'); }); 
            if(el) { el.classList.add('active-nav'); el.classList.remove('text-slate-500'); }
        }
        
        function cloneMonth(){ if(confirm('¿Clonar mes seleccionado?')) alert("Función de clonado lista para implementar."); }
        function clearMonth(){ if(confirm('¿Borrar TODO este mes?')) alert("Función de borrado lista para implementar."); }
    </script>
</body>
</html>
