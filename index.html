<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FinanceFlow PRO | Javi</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#0e757c", "primary-dark": "#085055", "success": "#558055", "danger": "#b91c1c", "warning": "#D4A373" },
                    fontFamily: { "display": ["Manrope", "sans-serif"], "body": ["Inter", "sans-serif"] }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Manrope', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .hidden-view { display: none !important; }
        .active-nav { background-color: rgba(14, 117, 124, 0.1); color: #0e757c; border-right: 3px solid #0e757c; }
        .d-picker { position: absolute; inset:0; opacity:0; cursor: pointer; width: 100%; }
        .compact-row { padding-top: 0.35rem; padding-bottom: 0.35rem; }
    </style>
</head>

<body class="bg-[#f0f2f2] text-slate-900 h-screen flex overflow-hidden selection:bg-primary/20">

    <aside class="w-16 hover:w-56 transition-all duration-300 group fixed h-screen z-40 flex flex-col justify-between py-4 bg-white shadow-xl border-r border-slate-200">
        <div class="flex flex-col gap-6">
            <div class="flex items-center justify-center h-10 group-hover:justify-start group-hover:px-4 transition-all">
                <div class="bg-primary size-8 rounded-lg flex items-center justify-center text-white shrink-0 shadow-md">
                    <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                </div>
                <h1 class="font-bold text-base text-primary ml-3 opacity-0 group-hover:opacity-100 transition-opacity overflow-hidden whitespace-nowrap">FinanceFlow OS</h1>
            </div>
            <nav class="flex flex-col gap-1 px-2" id="main-nav">
                <button onclick="nav('dashboard', this)" id="nav-dashboard" class="active-nav flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">dashboard</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Operaciones</span>
                </button>
                <button onclick="nav('analytics', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">query_stats</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Análisis 360</span>
                </button>
                <button onclick="nav('admin', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">settings</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Ajustes</span>
                </button>
            </nav>
        </div>
        <div class="px-2">
            <button onclick="openModal()" class="flex items-center justify-center w-full h-10 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-lg transition-all group-hover:justify-start group-hover:px-3 mb-4 overflow-hidden">
                <span class="material-symbols-outlined text-xl">add</span>
                <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Nuevo</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 ml-16 p-4 lg:p-6 h-screen overflow-hidden flex flex-col relative">
        
        <header class="flex justify-between items-center mb-4 shrink-0">
            <div class="flex flex-col">
                <h2 class="text-xl font-extrabold text-slate-900 tracking-tight">Panel de Control</h2>
                <div class="flex items-center gap-1 text-slate-500 relative cursor-pointer hover:text-primary transition-colors mt-0.5">
                    <button onclick="changeMonth(-1)" class="hover:bg-slate-200 rounded p-0.5"><span class="material-symbols-outlined text-sm">chevron_left</span></button>
                    <div class="relative">
                        <span class="text-xs font-bold uppercase tracking-wide flex items-center gap-1"><span id="monthTxt">...</span></span>
                        <input type="month" id="datePicker" class="d-picker" onchange="manualDate()">
                    </div>
                    <button onclick="changeMonth(1)" class="hover:bg-slate-200 rounded p-0.5"><span class="material-symbols-outlined text-sm">chevron_right</span></button>
                </div>
            </div>

            <div class="flex items-center bg-white border border-slate-200 rounded-lg shadow-sm h-9 px-3 gap-2">
                <span class="material-symbols-outlined text-slate-400 text-sm">public</span>
                <span class="text-[10px] font-bold text-slate-500 uppercase">Base: ARS</span>
            </div>
        </header>

        <section class="grid grid-cols-4 gap-3 mb-4 shrink-0">
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Balance (ARS)</p>
                <h3 class="text-lg font-extrabold text-slate-800" id="k-bal">$0</h3>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Estimado USD</p>
                <h3 class="text-lg font-extrabold text-primary" id="k-usd">$0</h3>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Ingresos</p>
                <h3 class="text-lg font-extrabold text-success" id="k-inc">$0</h3>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Gastos</p>
                <h3 class="text-lg font-extrabold text-danger" id="k-exp">$0</h3>
            </div>
        </section>

        <div id="view-dashboard" class="view-container grid grid-cols-1 xl:grid-cols-3 gap-4 flex-1 min-h-0">
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-3 py-2 border-b bg-slate-50/50 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-1"><span class="material-symbols-outlined text-sm text-success">arrow_upward</span>Ingresos</span>
                    <span class="bg-success/10 text-success text-[10px] font-bold px-1.5 rounded" id="c-inc">0</span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1" id="list-inc"></div>
            </section>
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-3 py-2 border-b bg-slate-50/50 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-1"><span class="material-symbols-outlined text-sm text-danger">arrow_downward</span>Gastos</span>
                    <span class="bg-danger/10 text-danger text-[10px] font-bold px-1.5 rounded" id="c-exp">0</span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1" id="list-exp"></div>
            </section>
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-3 py-2 border-b bg-slate-50/50 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-1"><span class="material-symbols-outlined text-sm text-primary">pie_chart</span>Asignación</span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2" id="list-alloc"></div>
            </section>
        </div>

        <div id="view-analytics" class="view-container hidden-view grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1 min-h-0">
            
            <div class="flex flex-col gap-4 h-full">
                <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex flex-col flex-1 min-h-0">
                    <div class="flex justify-between items-center mb-2"><h3 class="text-xs font-bold text-slate-600 uppercase">Gastos por Categoría</h3></div>
                    <div class="flex items-center gap-4 flex-1 overflow-hidden">
                        <div class="relative h-[140px] w-[140px] shrink-0"><canvas id="chartExp"></canvas></div>
                        <div class="flex-1 h-full overflow-y-auto custom-scrollbar" id="legExp"></div>
                    </div>
                </div>
                <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex flex-col flex-1 min-h-0">
                    <div class="flex justify-between items-center mb-2"><h3 class="text-xs font-bold text-slate-600 uppercase">Financial Twin (Benchmarking)</h3></div>
                    <div class="flex-1 relative flex justify-center">
                        <canvas id="chartRadar"></canvas>
                    </div>
                    <p class="text-[9px] text-center text-slate-400 mt-1">Comparativa vs Perfil Ideal Ingeniero</p>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-600 uppercase flex items-center gap-2"><span class="material-symbols-outlined text-sm">savings</span> Portafolio Inversiones</h3>
                    <span class="bg-primary/10 text-primary text-[10px] font-bold px-2 py-0.5 rounded">Total: $0 USD</span>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center text-center p-6 border-2 border-dashed border-slate-100 rounded-lg bg-slate-50/50">
                    <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">hub</span>
                    <p class="text-xs font-bold text-slate-500">Conectividad API</p>
                    <p class="text-[10px] text-slate-400 max-w-[200px] mt-1">Aquí se visualizarán tus CEDEARs, Crypto y Bonos sincronizados en tiempo real.</p>
                    <button class="mt-3 text-[10px] bg-white border border-slate-200 px-3 py-1 rounded shadow-sm hover:text-primary font-bold">Configurar API</button>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-container hidden-view grid grid-cols-2 gap-4 flex-1 min-h-0">
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-4 flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-800 uppercase">Recurrentes</h3>
                    <button onclick="loadRecurrentes()" class="bg-slate-800 text-white text-[10px] px-2 py-1 rounded font-bold">EJECUTAR</button>
                </div>
                <div class="flex-1 bg-slate-50 rounded-lg p-2 text-xs text-slate-500 overflow-y-auto">
                    <div class="flex justify-between py-1 border-b border-slate-200"><span>Sueldo</span> <span class="font-bold">Inc</span></div>
                    <div class="flex justify-between py-1 border-b border-slate-200"><span>Alquiler</span> <span class="font-bold">Exp</span></div>
                    <div class="flex justify-between py-1 border-b border-slate-200"><span>Gym</span> <span class="font-bold">Exp</span></div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-4 flex flex-col h-fit">
                <h3 class="text-xs font-bold text-slate-800 uppercase mb-3">Tasas de Cambio (Base ARS)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">USD Blue</span>
                        <input type="number" id="rate-usd" value="1120" onchange="updateRates()" class="w-20 text-right text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">Euro</span>
                        <input type="number" id="rate-eur" value="1210" onchange="updateRates()" class="w-20 text-right text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">COP (Col)</span>
                        <input type="number" id="rate-cop" value="0.28" onchange="updateRates()" class="w-20 text-right text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">BRL (Real)</span>
                        <input type="number" id="rate-brl" value="225" onchange="updateRates()" class="w-20 text-right text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1">
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t border-slate-100">
                    <button onclick="clearMonth()" class="w-full text-red-500 text-[10px] font-bold hover:bg-red-50 py-1 rounded">RESET MES ACTUAL</button>
                </div>
            </div>
        </div>

    </main>

    <button onclick="openModal()" class="fixed bottom-6 right-6 size-12 bg-slate-900 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-50">
        <span class="material-symbols-outlined">add</span>
    </button>

    <div id="modalOverlay" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-[2px]" onclick="closeModal()"></div>
        <div class="relative z-10 w-full max-w-[400px] bg-white rounded-2xl shadow-2xl flex flex-col animate-fade-in mx-4 overflow-hidden">
            <div class="px-5 pt-4 pb-2 flex justify-between items-center border-b border-slate-100">
                <h1 class="text-base font-bold text-slate-800" id="mTitle">Nuevo Movimiento</h1>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><span class="material-symbols-outlined">close</span></button>
            </div>
            
            <form id="txForm" class="p-5 flex flex-col gap-4">
                <div class="grid grid-cols-2 p-1 bg-slate-100 rounded-lg">
                    <button type="button" id="btnExp" onclick="setType('exp')" class="py-1.5 text-xs font-bold rounded transition-all">Gasto</button>
                    <button type="button" id="btnInc" onclick="setType('inc')" class="py-1.5 text-xs font-bold rounded transition-all">Ingreso</button>
                </div>
                <input type="hidden" id="fType" value="exp">

                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Monto Original</label>
                        <input type="number" id="fAmt" step="0.01" class="w-full pl-3 pr-2 py-2 bg-slate-50 border-slate-200 rounded-lg text-lg font-bold focus:ring-primary" placeholder="0" required oninput="calcConversion()">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Moneda</label>
                        <select id="fCurr" onchange="calcConversion()" class="w-full py-2 bg-slate-50 border-slate-200 rounded-lg text-xs font-bold">
                            <option value="ARS">ARS</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="COP">COP</option>
                        </select>
                    </div>
                </div>

                <div id="convPreview" class="hidden bg-blue-50 text-blue-800 px-3 py-1.5 rounded text-[10px] font-medium flex justify-between items-center">
                    <span>Conversión estimada:</span>
                    <span class="font-bold text-xs" id="convResult">$0 ARS</span>
                </div>
                <input type="hidden" id="fRateUsed" value="1">

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Fecha</label>
                        <input type="date" id="fDate" class="w-full py-2 bg-white border-slate-200 rounded-lg text-xs" required>
                    </div>
                    <div id="catRow">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Categoría</label>
                        <select id="fCatSel" class="w-full py-2 bg-white border-slate-200 rounded-lg text-xs font-medium"></select>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Concepto</label>
                    <input type="text" id="fDesc" class="w-full py-2 bg-slate-50 border-slate-200 rounded-lg text-xs font-medium" placeholder="Detalle..." required>
                </div>
                
                <div id="linkRow">
                    <label class="block text-[10px] font-bold text-primary uppercase mb-1">Fuente</label>
                    <select id="fLink" class="w-full py-2 bg-white border-slate-200 rounded-lg text-xs"></select>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="fExec" class="text-primary rounded focus:ring-primary">
                    <label for="fExec" class="text-xs font-bold text-slate-600">Ejecutado</label>
                </div>

                <button type="submit" class="w-full py-3 bg-slate-900 text-white rounded-lg text-xs font-bold shadow-md hover:bg-slate-800">GUARDAR</button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const RECURRENTES = [
            { desc: 'Sueldo Famiq', amount: 2500000, type: 'inc', cat: 'Ingresos' },
            { desc: 'Alquiler', amount: 450000, type: 'exp', cat: 'Esenciales' },
            { desc: 'Gimnasio', amount: 45000, type: 'exp', cat: 'Personal' },
            { desc: 'Inversión', amount: 500000, type: 'exp', cat: 'Ahorro' }
        ];
        
        // TASAS DE CAMBIO POR DEFECTO (Se pueden editar en UI)
        let RATES = { ARS: 1, USD: 1120, EUR: 1210, COP: 0.28, BRL: 225 }; 

        const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
        const PALETTE = ['#0e757c','#558055','#D4A373','#996A5C','#334155','#64748b'];
        
        let appData = { txs: [], cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Venta','Otros'] }, concepts: {}, rates: {} };
        let currentDate = new Date(); currentDate.setDate(1);
        let editId=null, cExp=null, cInc=null, cRadar=null;
        const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        window.onload = () => { 
            updateDateUI(); 
            forceSync(); 
            // Init Chart Defaults
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.font.size = 10;
        };

        // --- CORE LOGIC ---
        async function forceSync() {
            try { 
                const r = await fetch(API_URL); appData = await r.json(); 
                if(!appData.rates) appData.rates={}; 
                loadMonthData(); 
            } catch(e){ console.error(e); }
        }
        
        async function saveData() {
            try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(appData) }); loadMonthData(); } catch(e){ alert('Error guardando'); }
        }

        function updateRates() {
            // Actualizar tasas desde los inputs de Admin
            RATES.USD = parseFloat(document.getElementById('rate-usd').value);
            RATES.EUR = parseFloat(document.getElementById('rate-eur').value);
            RATES.COP = parseFloat(document.getElementById('rate-cop').value);
            RATES.BRL = parseFloat(document.getElementById('rate-brl').value);
            alert("Tasas actualizadas para nuevas conversiones.");
        }

        function loadMonthData() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            const txs = appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
            txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
            renderLists(txs); renderCharts(txs); updateKPIs(txs);
        }

        // --- RENDER UI ---
        function renderLists(txs) {
            const lI=document.getElementById('list-inc'), lE=document.getElementById('list-exp'), lA=document.getElementById('list-alloc');
            lI.innerHTML=''; lE.innerHTML=''; lA.innerHTML=''; let rb=0;

            txs.forEach(t => {
                if(t.type=='inc') rb+=t.amount; else rb-=t.amount;
                
                // Badge de Moneda Original (Si no es ARS)
                let currBadge = '';
                if(t.origCurr && t.origCurr !== 'ARS') {
                    currBadge = `<span class="bg-blue-100 text-blue-700 text-[9px] px-1 rounded font-bold ml-1">${t.origAmt} ${t.origCurr}</span>`;
                }

                const el = document.createElement('div');
                const styles = t.exec ? "opacity-50 grayscale" : "";
                const strike = t.exec ? "line-through decoration-slate-400" : "";
                
                el.className = `compact-row flex items-center justify-between px-2 hover:bg-slate-50 cursor-pointer border-b border-dashed border-slate-100 last:border-0 ${styles}`;
                el.onclick = () => editTx(t.id);
                
                el.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="size-6 rounded bg-slate-50 flex items-center justify-center shrink-0 border border-slate-100">
                            <span class="material-symbols-outlined text-xs ${t.type=='inc'?'text-success':'text-danger'}">circle</span>
                        </div>
                        <div class="min-w-0">
                            <div class="flex items-center">
                                <p class="text-xs font-bold text-slate-700 truncate leading-tight ${strike}">${t.desc}</p>
                                ${currBadge}
                            </div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[9px] text-slate-400 bg-slate-50 px-1 rounded">${t.cat}</span>
                                <span class="text-[9px] text-slate-400">${t.date.split('-')[2]}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right shrink-0 ml-2">
                        <p class="text-xs font-bold ${t.type=='inc'?'text-success':'text-danger'} ${strike}">$${fmt(t.amount)}</p>
                    </div>
                `;
                (t.type=='inc'?lI:lE).appendChild(el);
            });
            
            document.getElementById('c-inc').innerText = txs.filter(t=>t.type=='inc').length;
            document.getElementById('c-exp').innerText = txs.filter(t=>t.type=='exp').length;

            // Allocation Logic
            const incs = txs.filter(t=>t.type=='inc');
            if(!incs.length) lA.innerHTML = '<div class="text-center text-slate-400 text-[10px] py-4">Sin datos</div>';
            
            incs.forEach(inc => {
                const subs = txs.filter(t=>t.type=='exp' && t.linkId==inc.id);
                const spent = subs.reduce((a,b)=>a+b.amount,0);
                const pct = Math.min(100, (spent/inc.amount)*100);
                let barColor = pct > 90 ? (spent > inc.amount ? 'bg-danger' : 'bg-warning') : 'bg-primary';

                let rows = '';
                subs.forEach(s => {
                    rows += `<div class="flex justify-between py-1 text-[10px] border-b border-dashed border-slate-100 text-slate-500"><span class="truncate">${s.desc}</span><span>$${fmt(s.amount)}</span></div>`;
                });

                const card = document.createElement('div');
                card.innerHTML = `
                    <div class="rounded-lg border border-slate-100 bg-white mb-1 shadow-sm overflow-hidden">
                        <div class="p-2 bg-slate-50/30 flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.nextElementSibling.classList.toggle('hidden')">
                            <div><p class="text-xs font-bold text-slate-700">${inc.desc}</p><p class="text-[9px] text-slate-400">$${fmt(spent)} / $${fmt(inc.amount)}</p></div>
                            <span class="text-[9px] font-bold text-slate-600">${Math.round(pct)}%</span>
                        </div>
                        <div class="w-full h-1 bg-slate-100"><div class="h-full ${barColor}" style="width: ${pct}%;"></div></div>
                        <div class="hidden bg-white p-2">${rows || '<span class="text-[9px] italic">Sin gastos</span>'}</div>
                    </div>`;
                lA.appendChild(card);
            });
        }

        // --- CHARTS (Including Financial Twin) ---
        function renderCharts(txs) {
            renderDoughnut(document.getElementById('chartExp'), document.getElementById('legExp'), txs.filter(t=>t.type=='exp'), 'cat', cExp, i=>cExp=i);
            
            // Financial Twin (Feature 10)
            if(cRadar) cRadar.destroy();
            
            // Calculos simples para el radar
            const totalInc = txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0) || 1;
            const savings = txs.filter(t=>t.cat=='Ahorro').reduce((a,b)=>a+b.amount,0);
            const fixed = txs.filter(t=>t.cat=='Esenciales').reduce((a,b)=>a+b.amount,0);
            
            const savRate = Math.min(100, Math.round((savings/totalInc)*100));
            const fixRate = Math.min(100, Math.round((fixed/totalInc)*100));
            
            const ctxR = document.getElementById('chartRadar');
            cRadar = new Chart(ctxR, {
                type: 'radar',
                data: {
                    labels: ['Ahorro %', 'Fijos %', 'Ocio %', 'Inversión %', 'Ejecución %'],
                    datasets: [{
                        label: 'Tú',
                        data: [savRate, fixRate, 100-(savRate+fixRate), savRate/2, 85], // Datos reales aproximados
                        fill: true,
                        backgroundColor: 'rgba(14, 117, 124, 0.2)',
                        borderColor: '#0e757c',
                        pointBackgroundColor: '#0e757c'
                    }, {
                        label: 'Ing. Ideal',
                        data: [30, 50, 20, 20, 100], // Benchmark
                        fill: true,
                        backgroundColor: 'rgba(200, 200, 200, 0.2)',
                        borderColor: '#cbd5e1',
                        pointBackgroundColor: '#cbd5e1',
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    scales: { r: { suggesteMin: 0, suggesteMax: 100, ticks: { display: false } } },
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } }
                }
            });
        }

        function renderDoughnut(cvs, leg, data, key, inst, setInst) {
            if(inst) inst.destroy();
            let map={}; data.forEach(t=>{const k=t[key]||'Gral'; map[k]=(map[k]||0)+t.amount;});
            const ent=Object.entries(map).sort((a,b)=>b[1]-a[1]);
            const tot=ent.reduce((a,b)=>a+b[1],0);
            setInst(new Chart(cvs, {
                type:'doughnut', 
                data:{labels:ent.map(e=>e[0]), datasets:[{data:ent.map(e=>e[1]), backgroundColor:PALETTE, borderWidth:0, hoverOffset:2}]},
                options:{responsive:true, maintainAspectRatio:false, cutout:'75%', plugins:{legend:{display:false}}}
            }));
            leg.innerHTML='';
            ent.forEach((e,i)=>{
                leg.innerHTML+=`<div class="flex justify-between py-1 border-b border-dashed border-slate-100 text-[10px]"><div class="flex items-center gap-1"><span class="size-2 rounded-full" style="background:${PALETTE[i%PALETTE.length]}"></span><span>${e[0]}</span></div><span class="font-bold">$${fmt(e[1])}</span></div>`;
            });
        }

        // --- FORM MULTIMONEDA ---
        function calcConversion() {
            const amt = parseFloat(document.getElementById('fAmt').value) || 0;
            const curr = document.getElementById('fCurr').value;
            const rate = RATES[curr] || 1;
            
            const final = amt * rate;
            document.getElementById('convResult').innerText = `$${fmt(final)} ARS`;
            document.getElementById('fRateUsed').value = rate;
            
            const prev = document.getElementById('convPreview');
            if(curr !== 'ARS' && amt > 0) prev.classList.remove('hidden'); else prev.classList.add('hidden');
        }

        function setType(t){
            document.getElementById('fType').value=t;
            const e=document.getElementById('btnExp'), i=document.getElementById('btnInc');
            if(t=='exp'){
                e.className="py-1.5 px-4 text-xs font-bold rounded bg-white text-danger shadow-sm transition-all";
                i.className="py-1.5 px-4 text-xs font-bold rounded text-slate-400 hover:text-slate-600 transition-all";
                document.getElementById('catRow').classList.remove('hidden'); document.getElementById('linkRow').classList.remove('hidden');
                fillSelect('fCatSel', appData.cats.exp); fillLinkOpts();
            } else {
                i.className="py-1.5 px-4 text-xs font-bold rounded bg-white text-success shadow-sm transition-all";
                e.className="py-1.5 px-4 text-xs font-bold rounded text-slate-400 hover:text-slate-600 transition-all";
                document.getElementById('catRow').classList.add('hidden'); document.getElementById('linkRow').classList.add('hidden');
            }
        }
        
        function fillSelect(id, arr){ const s=document.getElementById(id); s.innerHTML=''; arr.forEach(x=>s.add(new Option(x,x))); }
        function fillLinkOpts(){
            const s=document.getElementById('fLink'); s.innerHTML='<option value="">-- Sin Asignar --</option>';
            const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
            appData.txs.filter(t=>t.type=='inc' && parseInt(t.date.split('-')[1])==m).forEach(i=>{
                const sp=appData.txs.filter(x=>x.linkId==i.id).reduce((a,b)=>a+b.amount,0);
                s.add(new Option(`${i.desc} ($${fmt(i.amount-sp)})`, i.id));
            });
        }

        function openModal(){ resetForm(); setType('exp'); document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex'); }
        function closeModal(){ document.getElementById('modalOverlay').classList.add('hidden'); document.getElementById('modalOverlay').classList.remove('flex'); }
        
        function resetForm(){ 
            document.getElementById('txForm').reset(); 
            document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; 
            document.getElementById('convPreview').classList.add('hidden');
        }

        document.getElementById('txForm').onsubmit=e=>{
            e.preventDefault();
            const type = document.getElementById('fType').value;
            const origAmt = parseFloat(document.getElementById('fAmt').value);
            const curr = document.getElementById('fCurr').value;
            const rate = parseFloat(document.getElementById('fRateUsed').value);
            
            // Normalización a ARS
            const finalAmt = origAmt * rate;
            
            const tx={
                id: Date.now(), 
                date: document.getElementById('fDate').value,
                amount: finalAmt, // Se guarda en ARS para consistencia
                origAmt: origAmt, // Se guarda original para referencia
                origCurr: curr,
                rate: rate,
                type, 
                cat: type=='exp'?document.getElementById('fCatSel').value:null, 
                desc: document.getElementById('fDesc').value, 
                exec: document.getElementById('fExec').checked,
                linkId: type=='exp'?document.getElementById('fLink').value:null, 
                deletedAt: null
            };
            appData.txs.push(tx); saveData(); closeModal();
        }

        function updateKPIs(txs){
            const i=txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
            const e=txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
            document.getElementById('k-inc').innerText='$'+fmt(i); document.getElementById('k-exp').innerText='$'+fmt(e);
            document.getElementById('k-bal').innerText='$'+fmt(i-e); 
            // Estimado USD (Blue)
            document.getElementById('k-usd').innerText='USD '+fmt((i-e)/1120);
        }

        function loadRecurrentes() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            const d = `${y}-${m.toString().padStart(2,'0')}-01`;
            let c=0;
            RECURRENTES.forEach(r => {
                if(!appData.txs.some(t=>t.desc==r.desc && t.date.startsWith(`${y}-${m.toString().padStart(2,'0')}`))){
                    appData.txs.push({...r, id:Date.now()+Math.random(), date:d, exec:false, linkId:null, deletedAt:null}); c++;
                }
            });
            if(c>0){saveData(); alert('Generados: '+c);} else alert('Ya estaban cargados');
        }
        
        function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); updateDateUI(); loadMonthData(); }
        function manualDate(){ const[y,m]=document.getElementById('datePicker').value.split('-'); currentDate.setFullYear(y); currentDate.setMonth(m-1); updateDateUI(); loadMonthData(); }
        function updateDateUI(){ document.getElementById('monthTxt').innerText=`${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][currentDate.getMonth()]} ${currentDate.getFullYear()}`; document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }
        
        function nav(v, el){ 
            document.querySelectorAll('.view-container').forEach(e=>e.classList.add('hidden-view')); 
            document.getElementById(`view-${v}`).classList.remove('hidden-view'); 
            document.querySelectorAll('#main-nav button').forEach(e=>{ e.classList.remove('active-nav'); e.classList.add('text-slate-500'); }); 
            if(el) { el.classList.add('active-nav'); el.classList.remove('text-slate-500'); }
        }
    </script>
</body>
</html>
