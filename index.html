<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Finanzas J&M | Pro</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#0e757c", "primary-dark": "#085055", "surface": "#ffffff", "success": "#15803d", "danger": "#b91c1c", "warning": "#b45309" },
                    fontFamily: { "display": ["Manrope", "sans-serif"], "body": ["Inter", "sans-serif"] }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Manrope', sans-serif; background-color: #f8fafc; }
        .glass-sidebar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-right: 1px solid #e2e8f0; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hidden-view { display: none !important; }
        .active-nav { background-color: rgba(14, 117, 124, 0.08); color: #0e757c; border-right: 3px solid #0e757c; }
        .d-picker { position: absolute; inset:0; opacity:0; cursor: pointer; width: 100%; }
        
        .compact-row { padding: 6px 10px; border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
        .compact-row:last-child { border-bottom: none; }
        .compact-row:hover { background-color: #f8fafc; }
        .compact-row.selected { background-color: #f0f9ff; }
        
        .chip { border: 1px solid #e2e8f0; background: white; color: #475569; font-size: 11px; font-weight: 600; transition: all 0.1s; border-radius: 20px; }
        .chip:hover { border-color: #0e757c; color: #0e757c; }
        .chip.active { background: #0e757c; color: white; border-color: #0e757c; box-shadow: 0 2px 4px rgba(14,117,124,0.3); }
        
        .cat-tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: #f1f5f9; color: #64748b; border: 1px solid transparent; }
        .cat-tag:hover { border-color: #cbd5e1; color: #334155; background: white; }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .tc-input { 
            -moz-appearance: textfield; background: transparent; border: none; padding: 0 4px; margin: 0; 
            font-weight: 700; color: #334155; text-align: right; width: 90px; font-size: 12px; height: 100%;
        }
        .tc-input:focus { outline: none; ring: 0; border-bottom: 1px solid #0e757c; }
        
        .h-header-el { height: 32px; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        .btn-disabled { opacity: 0.3; pointer-events: none; }
        .bulk-chk { width: 16px; height: 16px; border-radius: 4px; border: 2px solid #cbd5e1; display:flex; align-items:center; justify-content:center; transition:0.2s; }
        .bulk-chk.checked { background: #0e757c; border-color: #0e757c; }
        .bulk-chk i { color:white; font-size:12px; display:none; }
        .bulk-chk.checked i { display:block; }
        .alert-card { transition: all 0.2s; }
        .alert-card:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>

<body class="text-slate-900 h-screen flex overflow-hidden selection:bg-primary/20">

    <aside class="glass-sidebar w-16 hover:w-64 transition-all duration-300 group fixed h-screen z-40 flex flex-col justify-between py-4 shadow-xl">
        <div class="flex flex-col gap-6">
            <div class="flex items-center justify-center h-10 px-2 group-hover:justify-start group-hover:px-4 transition-all">
                <div class="bg-primary size-8 rounded-lg flex items-center justify-center text-white shrink-0 shadow-md">
                    <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                </div>
                <h1 class="font-bold text-sm text-primary ml-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap overflow-hidden delay-75 tracking-tight">Finanzas J&M</h1>
            </div>

            <nav class="flex flex-col gap-1 px-2" id="main-nav">
                <button onclick="nav('dashboard', this)" id="nav-dashboard" class="active-nav flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">dashboard</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Operaciones</span>
                </button>
                <button onclick="nav('networth', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">savings</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Patrimonio</span>
                </button>
                <button onclick="nav('analytics', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">query_stats</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Análisis</span>
                </button>
                <button onclick="nav('admin', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">settings</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Ajustes</span>
                </button>
                <button onclick="forceSync()" class="flex items-center h-10 rounded-lg px-2 text-primary hover:bg-slate-100 transition-colors w-full overflow-hidden mt-2 border-t border-slate-100 pt-2">
                    <span class="material-symbols-outlined text-xl shrink-0" id="syncIcon">cloud_sync</span>
                    <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Sincronizar</span>
                </button>
            </nav>
        </div>

        <div class="px-2">
            <button onclick="openModal()" class="flex items-center justify-center w-full h-10 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-lg transition-all mb-4 group-hover:justify-start group-hover:px-3">
                <span class="material-symbols-outlined text-xl">add</span>
                <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Nuevo</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 ml-16 p-4 lg:p-6 h-screen overflow-hidden relative flex flex-col">
        
        <header class="flex justify-between items-center mb-3 shrink-0 gap-4 h-header-el">
            <div class="flex items-center gap-4 h-full">
                <h2 class="text-xl font-extrabold tracking-tight text-slate-800 leading-none" id="pageTitle">Panel de Control</h2>
                <div class="flex items-center gap-1 bg-white px-2 rounded-md border border-slate-200 shadow-sm transition-colors relative group h-full">
                    <button onclick="changeMonth(-1)" class="text-slate-400 hover:text-primary flex items-center px-1"><span class="material-symbols-outlined text-sm">chevron_left</span></button>
                    <div class="relative min-w-[80px] text-center flex items-center justify-center h-full">
                        <span class="text-[11px] font-bold uppercase text-slate-600 tracking-wide" id="monthTxt">...</span>
                        <input type="month" id="datePicker" class="d-picker" onchange="manualDate()">
                    </div>
                    <button onclick="changeMonth(1)" class="text-slate-400 hover:text-primary flex items-center px-1"><span class="material-symbols-outlined text-sm">chevron_right</span></button>
                    <div class="w-px h-4 bg-slate-200 mx-1"></div>
                    <button onclick="undo()" id="btnUndo" class="text-slate-400 hover:text-primary flex items-center px-1 btn-disabled" title="Deshacer"><span class="material-symbols-outlined text-sm">undo</span></button>
                    <button onclick="redo()" id="btnRedo" class="text-slate-400 hover:text-primary flex items-center px-1 btn-disabled" title="Rehacer"><span class="material-symbols-outlined text-sm">redo</span></button>
                </div>
            </div>
            <div class="flex items-center gap-3 bg-white px-3 rounded-md border border-slate-200 shadow-sm h-full shrink-0">
                <span class="material-symbols-outlined text-slate-400 text-sm">currency_exchange</span>
                <div class="flex items-center gap-2 border-r border-slate-100 pr-3 h-full">
                    <span class="text-[10px] font-bold text-slate-400">USD</span>
                    <div class="flex items-center h-full"><span class="text-[10px] text-slate-300 mr-1">$</span><input type="number" id="rate_ARS" onchange="pushHistory(); saveMonthlyRates()" class="tc-input" placeholder="0"></div>
                </div>
                <div class="flex items-center gap-2 h-full">
                    <span class="text-[10px] font-bold text-slate-400">COP</span>
                    <div class="flex items-center h-full"><span class="text-[10px] text-slate-300 mr-1">$</span><input type="number" id="rate_COP" step="0.01" onchange="pushHistory(); saveMonthlyRates()" class="tc-input" placeholder="0"></div>
                </div>
            </div>
        </header>

        <div id="view-dashboard" class="view-container animate-fade-in flex flex-col flex-1 min-h-0 gap-3 relative">
            <div id="dashboardAlerts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-1 shrink-0 empty:hidden"></div>
            
            <section class="grid grid-cols-4 gap-3 shrink-0">
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Balance Neto</p>
                    <h3 class="text-xl font-black text-slate-800 tracking-tight" id="k-bal">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Estimado USD</p>
                    <h3 class="text-lg font-bold text-primary" id="k-usd">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-success">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Ingresos</p>
                    <h3 class="text-lg font-bold text-success" id="k-inc">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-danger">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Gastos</p>
                    <h3 class="text-lg font-bold text-danger" id="k-exp">$0</h3>
                </div>
            </section>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-3 flex-1 min-h-0">
                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5"><span class="material-symbols-outlined text-success text-sm">arrow_circle_up</span> Ingresos</h4>
                        <span class="bg-success/10 text-success text-[9px] font-bold px-1.5 py-0.5 rounded-full" id="c-inc">0</span>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-0" id="list-inc"></div>
                </section>
                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <div class="flex items-center gap-2 flex-1 mr-2">
                            <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5 shrink-0"><span class="material-symbols-outlined text-danger text-sm">arrow_circle_down</span> Gastos</h4>
                            <input type="text" id="searchExpInput" oninput="filterExpList()" placeholder="Buscar..." class="w-full max-w-[100px] bg-white border-none text-[10px] rounded-md px-2 py-0.5 focus:ring-1 focus:ring-primary shadow-sm placeholder:text-slate-300">
                        </div>
                        <div class="flex items-center gap-1">
                             <button onclick="toggleSelectionMode()" id="btnSelectMode" class="text-slate-400 hover:text-primary transition-colors p-1"><span class="material-symbols-outlined text-base">check_box</span></button>
                             <span class="bg-danger/10 text-danger text-[9px] font-bold px-1.5 py-0.5 rounded-full" id="c-exp">0</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-0" id="list-exp"></div>
                </section>
                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5"><span class="material-symbols-outlined text-primary text-sm">pie_chart</span> Asignación</h4>
                    </div>
                    <div class="px-2 py-2 flex gap-2 border-b border-slate-100 bg-white">
                        <button onclick="autoAssign()" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:to-blue-700 text-white text-[10px] font-bold py-1.5 rounded-lg shadow-sm flex items-center justify-center gap-1"><span class="material-symbols-outlined text-sm">auto_fix_high</span> Auto</button>
                        <button onclick="unassignAll()" class="flex-1 bg-white border border-slate-200 text-slate-500 text-[10px] font-bold py-1.5 rounded-lg hover:text-red-500 hover:border-red-200 flex items-center justify-center gap-1"><span class="material-symbols-outlined text-sm">link_off</span> Reset</button>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-2 flex flex-col gap-2" id="list-alloc"></div>
                </section>
            </div>
            <div id="bulkBar" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-full shadow-xl flex items-center gap-4 z-50 animate-fade-in">
                <span class="text-xs font-bold" id="bulkCount">0</span><div class="h-4 w-px bg-slate-700"></div><button onclick="openBulkModal()" class="text-xs font-bold hover:text-primary-300 flex items-center gap-1"><span class="material-symbols-outlined text-sm">edit_square</span> Acciones</button><button onclick="toggleSelectionMode()" class="text-xs text-slate-400 hover:text-white"><span class="material-symbols-outlined text-sm">close</span></button>
            </div>
        </div>

        <div id="view-networth" class="view-container animate-fade-in hidden-view flex flex-col flex-1 min-h-0 gap-3">
             <div class="grid grid-cols-1 md:grid-cols-4 gap-3 shrink-0">
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-emerald-500">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Activos</p>
                    <h3 class="text-lg font-black text-emerald-700" id="nw-assets">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-red-500">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Pasivos</p>
                    <h3 class="text-lg font-black text-red-700" id="nw-liabilities">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-slate-800">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Patrimonio Neto</p>
                    <h3 class="text-xl font-black text-slate-800" id="nw-total">$0</h3>
                </div>
                 <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Neto USD</p>
                    <h3 class="text-lg font-bold text-primary" id="nw-usd">$0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 flex-1 min-h-0">
                <div class="col-span-1 lg:col-span-2 glass-panel rounded-xl p-4 flex flex-col">
                    <h3 class="text-xs font-bold text-slate-700 mb-4">Evolución Patrimonio (Últimos 12 Meses)</h3>
                    <div class="flex-1 min-h-0 relative"><canvas id="chartNetWorth"></canvas></div>
                </div>
                <div class="glass-panel rounded-xl p-4 flex flex-col overflow-hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-slate-700">Cuentas</h3>
                        <button onclick="addAccount()" class="bg-slate-900 text-white px-2 py-1 rounded text-[10px] font-bold hover:bg-slate-700">+ Cuenta</button>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar space-y-2" id="accountsList"></div>
                    <div id="accForm" class="hidden mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <input type="hidden" id="accId">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                             <input id="accName" placeholder="Nombre" class="w-full text-xs border-none rounded bg-white p-1.5 focus:ring-1 focus:ring-primary">
                             <select id="accKind" class="w-full text-xs border-none rounded bg-white p-1.5"><option value="asset">Activo</option><option value="liability">Pasivo</option></select>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <select id="accCurr" class="w-full text-xs border-none rounded bg-white p-1.5"><option value="ARS">ARS</option><option value="USD">USD</option><option value="COP">COP</option></select>
                            <input id="accInit" type="number" placeholder="Saldo Inicial" class="w-full text-xs border-none rounded bg-white p-1.5 focus:ring-1 focus:ring-primary">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="document.getElementById('accForm').classList.add('hidden')" class="text-xs text-slate-400 hover:text-slate-600">Cancelar</button>
                            <button onclick="saveAccount()" class="text-xs bg-primary text-white px-3 py-1 rounded font-bold">Guardar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-analytics" class="view-container animate-fade-in hidden-view grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1 min-h-0">
             <div id="analyticsAlerts" class="col-span-1 lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-2 empty:hidden"></div>
            <div class="glass-panel rounded-xl p-4 flex flex-col h-[360px]">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-bold text-slate-700">Gastos por Categoría</h3><button onclick="resetCharts()" class="text-[10px] text-primary font-bold hover:underline hidden" id="resetBtn">VOLVER</button></div>
                <div class="flex items-center gap-4 flex-1 min-h-0 overflow-hidden"><div class="relative h-[200px] w-[200px] shrink-0"><canvas id="chartExp"></canvas></div><div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-1" id="legExp"></div></div>
            </div>
            <div class="glass-panel rounded-xl p-4 flex flex-col h-[360px]">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-bold text-slate-700">Ingresos por Concepto</h3></div>
                <div class="flex items-center gap-4 flex-1 min-h-0 overflow-hidden"><div class="relative h-[200px] w-[200px] shrink-0"><canvas id="chartInc"></canvas></div><div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-1" id="legInc"></div></div>
            </div>
        </div>

        <div id="view-admin" class="view-container animate-fade-in hidden-view grid grid-cols-1 lg:grid-cols-2 gap-2 flex-1 min-h-0 pt-1">
            <div class="glass-panel rounded-xl p-2 flex flex-col h-full overflow-hidden">
                <h3 class="text-xs font-bold text-slate-800 mb-2 flex items-center gap-2 px-1"><span class="material-symbols-outlined text-base text-primary">folder_open</span> Categorías</h3>
                <div class="flex gap-1 mb-2 bg-slate-50 p-1 rounded-lg border border-slate-100">
                    <input type="text" id="newCatName" placeholder="Nueva..." class="flex-1 bg-transparent border-none text-xs px-2 focus:ring-0 font-medium">
                    <select id="newCatType" class="bg-white border-none rounded-md text-[10px] px-2 py-1 text-slate-600 shadow-sm"><option value="exp">Gasto</option><option value="inc">Ingreso</option></select>
                    <button onclick="manualAddCat()" class="bg-slate-800 text-white size-6 rounded-md hover:bg-slate-700 flex items-center justify-center shadow-sm text-xs">+</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar pr-1" id="adminTreeContainer"></div>
            </div>
            <div class="glass-panel rounded-xl p-2 flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-center mb-2 px-1">
                    <h3 class="text-xs font-bold text-slate-800">Recurrentes</h3>
                    <div class="flex gap-2"><button onclick="populateRecurringDefaults()" class="text-slate-400 text-[10px] font-bold hover:text-primary">SUGERIR</button><button onclick="addRecurrenteRow()" class="bg-primary/10 text-primary px-2 py-0.5 rounded text-[10px] font-bold">+ AGREGAR</button></div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 rounded-lg border border-slate-100 p-1 mb-2" id="recurrente-table-body"></div>
                <div class="grid grid-cols-2 gap-2 mt-auto">
                    <button onclick="saveRecurrentesConfig()" class="py-1.5 rounded-lg bg-white border border-slate-200 text-slate-600 text-[10px] font-bold">Guardar</button>
                    <button onclick="executeRecurrentes()" class="py-1.5 rounded-lg bg-slate-800 text-white text-[10px] font-bold">Ejecutar</button>
                </div>
            </div>
        </div>
    </main>

    <button onclick="openModal()" class="fixed bottom-6 right-6 size-12 bg-slate-900 text-white rounded-xl shadow-xl shadow-slate-900/30 flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-50"><span class="material-symbols-outlined text-2xl">add</span></button>

    <div id="modalOverlay" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="relative z-10 w-full max-w-[380px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in mx-4 max-h-[90vh]">
            <div class="flex items-center justify-between px-5 pt-5 pb-2 shrink-0">
                <h1 class="text-lg font-bold text-slate-800" id="mTitle">Nuevo</h1>
                <button onclick="closeModal()" class="size-7 flex items-center justify-center rounded-full bg-slate-50 hover:bg-slate-100 text-slate-400 transition-colors"><span class="material-symbols-outlined text-base">close</span></button>
            </div>
            
            <form id="txForm" class="p-5 overflow-y-auto custom-scrollbar flex-1">
                <div class="grid grid-cols-3 p-1 bg-slate-100 rounded-xl mb-4">
                    <button type="button" id="btnExp" onclick="setType('exp')" class="flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-danger">Gasto</button>
                    <button type="button" id="btnInc" onclick="setType('inc')" class="flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400">Ingreso</button>
                    <button type="button" id="btnTrf" onclick="setType('transfer')" class="flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400">Transf.</button>
                </div>
                <input type="hidden" id="fType" value="exp">

                <div class="flex gap-3 mb-4">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-light text-lg">$</span>
                        <input type="number" id="fAmt" step="0.01" class="w-full pl-6 pr-3 py-2.5 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-primary rounded-xl text-lg font-bold text-slate-800 outline-none text-right transition-all" placeholder="0" required oninput="calcConversion()">
                    </div>
                    <div class="w-20">
                        <select id="fCurr" onchange="calcConversion()" class="w-full h-full bg-slate-100 border-transparent rounded-xl text-[11px] font-bold focus:border-primary focus:ring-0 text-center pl-1 pr-6"><option value="ARS">ARS</option><option value="USD">USD</option><option value="COP">COP</option></select>
                    </div>
                </div>
                <div id="convPreview" class="hidden text-right text-[10px] text-slate-500 font-medium -mt-2 mb-4 bg-slate-50 px-2 py-1 rounded inline-block float-right">= <span id="convResult" class="text-slate-800 font-bold">$0 ARS</span></div>
                <div class="clear-both"></div>

                <div id="accSelectors" class="grid grid-cols-2 gap-3 mb-3">
                    <div id="fromAccBox">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Desde</label>
                        <select id="fFromAcc" class="w-full bg-slate-50 border-none rounded-xl text-xs font-bold py-2.5"></select>
                    </div>
                    <div id="toAccBox" class="hidden">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Hacia</label>
                        <select id="fToAcc" class="w-full bg-slate-50 border-none rounded-xl text-xs font-bold py-2.5"></select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Fecha</label>
                    <input type="date" id="fDate" class="w-full px-3 py-2.5 bg-slate-50 border-none rounded-xl text-xs font-medium focus:ring-2 focus:ring-primary/20" required>
                </div>

                <div id="catSection">
                    <div class="mb-3">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Categoría</label>
                        <div class="flex flex-wrap gap-1.5" id="chipBox"></div>
                        <input type="hidden" id="fCat">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1" id="lblDesc">Concepto</label>
                    <div class="flex flex-wrap gap-1.5 mb-2" id="conceptBox"></div>
                    <input type="text" id="fDesc" class="w-full px-3 py-2.5 bg-slate-50 border-none rounded-xl text-xs focus:ring-2 focus:ring-primary/20 placeholder:text-slate-400" placeholder="Detalle..." required>
                </div>

                <div class="mb-4" id="linkRow">
                    <label class="block text-[10px] font-bold text-primary uppercase mb-1 ml-1">Pagar con (Fuente)</label>
                    <div id="linkChipsContainer" class="flex flex-wrap gap-1.5"></div>
                    <input type="hidden" id="fLink">
                </div>

                <div class="flex items-center gap-3 mb-5 p-2.5 border border-slate-100 rounded-xl bg-slate-50/50 hover:bg-slate-50 transition-colors cursor-pointer" onclick="document.getElementById('fExec').click()">
                    <input type="checkbox" id="fExec" class="size-4 text-primary rounded border-slate-300 focus:ring-primary bg-white">
                    <div>
                        <span class="block text-[11px] font-bold text-slate-700 select-none">Marcar como Ejecutado</span>
                        <span class="block text-[9px] text-slate-400">Congela el valor de la moneda</span>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <button type="submit" class="w-full py-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-xs font-bold shadow-lg shadow-slate-900/20 active:scale-95 transition-all">GUARDAR</button>
                    <button type="button" id="btnDel" onclick="delTx()" class="text-[10px] text-red-500 font-bold hover:bg-red-50 py-2 rounded-lg transition-colors hidden">Eliminar Registro</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="bulkModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeBulkModal()"></div>
        <div class="relative z-10 w-full max-w-sm bg-white rounded-2xl shadow-2xl p-4 animate-fade-in mx-4">
            <h3 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2">Acciones Masivas</h3>
            <div id="bulkMainOptions" class="grid grid-cols-1 gap-2">
                <button onclick="showBulkSubOption('category')" class="p-3 text-left rounded-lg border border-slate-200 hover:border-primary hover:bg-slate-50 flex items-center justify-between group"><span class="text-xs font-bold text-slate-600 group-hover:text-slate-800">Cambiar Categoría</span><span class="material-symbols-outlined text-base text-slate-400">category</span></button>
                <div class="grid grid-cols-2 gap-2"><button onclick="bulkSetExec(true)" class="p-2 text-left rounded-lg border border-slate-200 hover:border-primary text-xs font-bold text-slate-600">Marcar Ejecutado</button><button onclick="bulkSetExec(false)" class="p-2 text-left rounded-lg border border-slate-200 hover:border-primary text-xs font-bold text-slate-600">Marcar Pendiente</button></div>
                <button onclick="showBulkSubOption('link')" class="p-3 text-left rounded-lg border border-slate-200 hover:border-primary hover:bg-slate-50 flex items-center justify-between group"><span class="text-xs font-bold text-slate-600 group-hover:text-slate-800">Asignar a Ingreso</span><span class="material-symbols-outlined text-base text-slate-400">link</span></button>
                <button onclick="bulkUnassignIncome()" class="p-3 text-left rounded-lg border border-slate-200 hover:border-primary hover:bg-slate-50 flex items-center justify-between group"><span class="text-xs font-bold text-slate-600 group-hover:text-slate-800">Desvincular</span><span class="material-symbols-outlined text-base text-slate-400">link_off</span></button>
                <button onclick="bulkDelete()" class="p-3 text-left rounded-lg border border-red-200 bg-red-50 hover:bg-red-100 flex items-center justify-between group"><span class="text-xs font-bold text-red-600">Eliminar Seleccionados</span><span class="material-symbols-outlined text-base text-red-400">delete</span></button>
            </div>
            <div id="bulkSubCategory" class="hidden"><button onclick="resetBulkView()" class="mb-2 text-[10px] text-slate-400 hover:text-primary font-bold flex items-center">Volver</button><div class="mb-2"><input type="text" id="bulkCatSearch" placeholder="Buscar..." class="w-full text-xs border border-slate-200 rounded p-2"></div><div id="bulkCatList" class="max-h-[200px] overflow-y-auto custom-scrollbar flex flex-col gap-1"></div></div>
            <div id="bulkSubLink" class="hidden"><button onclick="resetBulkView()" class="mb-2 text-[10px] text-slate-400 hover:text-primary font-bold flex items-center">Volver</button><div id="bulkLinkList" class="max-h-[200px] overflow-y-auto custom-scrollbar flex flex-col gap-1"></div></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
        const MONTHS = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const PALETTE = ['#0e757c','#558055','#D4A373','#996A5C','#334155','#64748b','#94a3b8','#cbd5e1'];

        const defaultData = { 
            txs: [], 
            cats: { exp:['Esenciales','Deudas','Fitness','Viaje Italia','Inversiones','Proyectos'], inc:['Sueldo Famiq','Honorarios','Rentas','Otros'] }, 
            concepts: { 'Esenciales': ['Alquiler','Expensas','Supermercado','Luz','Gas','Internet'] }, 
            recurrentes: [], 
            monthlyRates: {},
            accounts: [] 
        };

        let appData = JSON.parse(JSON.stringify(defaultData)); 
        let currentDate = new Date(); currentDate.setDate(1);
        let editId=null, cExp=null, cInc=null, drillCat=null;
        
        let historyStack = []; let redoStack = []; const MAX_HISTORY = 50;
        let isSelectionMode = false; let selectedTxIds = new Set();
        let nwChart = null;

        const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        window.onload = () => { initApp(); };
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) { e.preventDefault(); redo(); }
        });

        async function initApp() {
            loadLocal();
            // MIGRATION: Ensure accounts exist
            if (!appData.accounts || appData.accounts.length === 0) {
                appData.accounts = [{id: 'acc_def', name: 'Efectivo', kind: 'asset', currency: 'ARS', init: 0}];
                // Migrate txs
                appData.txs.forEach(t => {
                    if (t.type === 'exp' && !t.fromAccountId) t.fromAccountId = 'acc_def';
                    if (t.type === 'inc' && !t.toAccountId) t.toAccountId = 'acc_def';
                });
                saveLocal();
            }
            updateDateUI(); renderAdminTree(); updateHistoryUI(); 
            Chart.defaults.font.family = "'Manrope', sans-serif";
            syncIndicator(true); await forceSync(); syncIndicator(false);
        }

        function pushHistory() { historyStack.push(JSON.stringify(appData)); if(historyStack.length>MAX_HISTORY) historyStack.shift(); redoStack=[]; updateHistoryUI(); }
        function undo() { if(!historyStack.length)return; redoStack.push(JSON.stringify(appData)); appData=JSON.parse(historyStack.pop()); isSelectionMode=false;selectedTxIds.clear();updateSelectionUI();saveData();updateHistoryUI(); }
        function redo() { if(!redoStack.length)return; historyStack.push(JSON.stringify(appData)); appData=JSON.parse(redoStack.pop()); isSelectionMode=false;selectedTxIds.clear();updateSelectionUI();saveData();updateHistoryUI(); }
        function updateHistoryUI() { document.getElementById('btnUndo').classList.toggle('btn-disabled',!historyStack.length); document.getElementById('btnRedo').classList.toggle('btn-disabled',!redoStack.length); }

        function saveLocal() { localStorage.setItem('financeFlowData_Javi', JSON.stringify(appData)); }
        function loadLocal() { const s=localStorage.getItem('financeFlowData_Javi'); if(s)try{appData=JSON.parse(s);}catch(e){} loadMonthData(); }
        async function forceSync() { try{const r=await fetch(API_URL);const d=await r.json();if(d){appData.txs=d.txs||[];appData.cats=d.cats||defaultData.cats;appData.concepts=d.concepts||defaultData.concepts;appData.monthlyRates=d.monthlyRates||{};appData.recurrentes=d.recurrentes||[];appData.accounts=d.accounts||[{id:'acc_def',name:'Efectivo',kind:'asset',currency:'ARS',init:0}]; saveLocal(); loadMonthData();}}catch(e){console.log("Offline");} }
        async function saveData() { saveLocal(); try{await fetch(API_URL,{method:'POST',body:JSON.stringify(appData)});}catch(e){} loadMonthData(); renderAdminTree(); }
        function syncIndicator(b) { const i=document.getElementById('syncIcon'); if(i)i.classList.toggle('animate-spin',b); }

        function loadMonthData() {
            const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
            const key=`${y}-${m.toString().padStart(2,'0')}`;
            let rates = appData.monthlyRates[key] || { ARS: 1500, COP: 3700, USD: 1 };
            document.getElementById('rate_ARS').value = rates.ARS; document.getElementById('rate_COP').value = rates.COP;
            
            const txs = appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
            // Conversion logic for display
            txs.forEach(t => { if (!t.exec && t.origCurr && t.origCurr !== 'ARS') { if (t.origCurr === 'USD') t.amount = t.origAmt * rates.ARS; else if (t.origCurr === 'COP') t.amount = (t.origAmt / rates.COP) * rates.ARS; } });
            txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);

            renderAlerts(computeAlerts(txs));
            renderLists(txs); renderCharts(txs); updateKPIs(txs); renderRecurrentesAdmin(); renderAdminTree();
            renderNetWorthView(); // New View Logic
        }

        // --- ACCOUNT & NET WORTH LOGIC ---
        function getAccountsBalance() {
            let bals = {};
            appData.accounts.forEach(a => bals[a.id] = a.init || 0);
            
            // Replay history
            appData.txs.forEach(t => {
                if(t.deletedAt) return;
                const amt = t.origAmt || t.amount; // Use original currency amount
                if(t.type === 'exp' && t.fromAccountId) bals[t.fromAccountId] -= amt;
                if(t.type === 'inc' && t.toAccountId) bals[t.toAccountId] += amt;
                if(t.type === 'transfer' && t.fromAccountId && t.toAccountId) {
                    bals[t.fromAccountId] -= amt;
                    bals[t.toAccountId] += amt;
                }
            });
            return bals;
        }

        function renderNetWorthView() {
            const bals = getAccountsBalance();
            const list = document.getElementById('accountsList'); list.innerHTML = '';
            const rateARS = parseFloat(document.getElementById('rate_ARS').value) || 1200;
            const rateCOP = parseFloat(document.getElementById('rate_COP').value) || 3700;
            
            let assets = 0, liabs = 0;

            appData.accounts.forEach(a => {
                const bal = bals[a.id];
                // Convert to ARS for Net Worth Total
                let valInARS = bal;
                if(a.currency === 'USD') valInARS = bal * rateARS;
                if(a.currency === 'COP') valInARS = (bal / rateCOP) * rateARS;

                if(a.kind === 'asset') assets += valInARS; else liabs += Math.abs(valInARS); 
                
                // Card UI
                const card = document.createElement('div');
                card.className = "flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100";
                card.innerHTML = `
                    <div>
                        <p class="text-xs font-bold text-slate-700">${a.name}</p>
                        <p class="text-[10px] text-slate-400 uppercase">${a.kind==='asset'?'Activo':'Pasivo'} • ${a.currency}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold text-slate-800">${a.currency} ${fmt(bal)}</p>
                        ${a.currency!=='ARS' ? `<p class="text-[9px] text-slate-400">≈ $${fmt(valInARS)}</p>` : ''}
                    </div>
                    <div class="ml-2 flex gap-1">
                        <button onclick="editAccount('${a.id}')" class="text-slate-300 hover:text-primary"><span class="material-symbols-outlined text-sm">edit</span></button>
                        <button onclick="delAccount('${a.id}')" class="text-slate-300 hover:text-red-500"><span class="material-symbols-outlined text-sm">delete</span></button>
                    </div>
                `;
                list.appendChild(card);
            });

            const net = assets - liabs;
            document.getElementById('nw-assets').innerText = '$'+fmt(assets);
            document.getElementById('nw-liabilities').innerText = '$'+fmt(liabs);
            document.getElementById('nw-total').innerText = '$'+fmt(net);
            document.getElementById('nw-usd').innerText = 'USD '+fmt(net/rateARS);

            renderNetWorthChart();
        }

        function renderNetWorthChart() {
            // Calc history last 12 months
            const labels = []; const data = [];
            const end = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0);
            
            for(let i=11; i>=0; i--) {
                const d = new Date(end.getFullYear(), end.getMonth()-i, 1);
                const y = d.getFullYear(); const m = d.getMonth()+1;
                const key = `${y}-${m.toString().padStart(2,'0')}`;
                
                // Get rates for that month
                const r = appData.monthlyRates[key] || {ARS:1200, COP:3800, USD:1};
                
                // Calc balance up to end of that month
                let mAssets = 0, mLiabs = 0;
                let accBals = {}; 
                appData.accounts.forEach(a => accBals[a.id] = a.init || 0);

                // Filter txs up to end of that month
                const lastDay = new Date(y, m, 0).toISOString().split('T')[0];
                
                appData.txs.forEach(t => {
                    if(t.deletedAt || t.date > lastDay) return;
                    const amt = t.origAmt || t.amount;
                    if(t.type === 'exp' && t.fromAccountId) accBals[t.fromAccountId] -= amt;
                    if(t.type === 'inc' && t.toAccountId) accBals[t.toAccountId] += amt;
                    if(t.type === 'transfer' && t.fromAccountId && t.toAccountId) {
                        accBals[t.fromAccountId] -= amt;
                        accBals[t.toAccountId] += amt;
                    }
                });

                appData.accounts.forEach(a => {
                    let val = accBals[a.id];
                    if(a.currency === 'USD') val = val * r.ARS;
                    if(a.currency === 'COP') val = (val / r.COP) * r.ARS;
                    if(a.kind === 'asset') mAssets += val; else mLiabs += val;
                });

                labels.push(MONTHS[m-1]);
                data.push(mAssets - mLiabs);
            }

            const ctx = document.getElementById('chartNetWorth');
            if(nwChart) nwChart.destroy();
            nwChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Patrimonio Neto', data: data, borderColor: '#0e757c', backgroundColor: 'rgba(14, 117, 124, 0.1)', fill: true, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { y: { beginAtZero: false, ticks: { callback: v => '$'+v/1000+'k' } } } }
            });
        }

        function addAccount() { document.getElementById('accForm').classList.remove('hidden'); document.getElementById('accId').value = ''; document.getElementById('accName').value = ''; document.getElementById('accInit').value = ''; }
        function editAccount(id) { const a = appData.accounts.find(x => x.id === id); if(!a) return; document.getElementById('accForm').classList.remove('hidden'); document.getElementById('accId').value = a.id; document.getElementById('accName').value = a.name; document.getElementById('accKind').value = a.kind; document.getElementById('accCurr').value = a.currency; document.getElementById('accInit').value = a.init || 0; }
        function saveAccount() {
            const id = document.getElementById('accId').value;
            const name = document.getElementById('accName').value;
            const kind = document.getElementById('accKind').value;
            const curr = document.getElementById('accCurr').value;
            const init = parseFloat(document.getElementById('accInit').value) || 0;
            if(!name) return alert('Nombre requerido');
            
            pushHistory();
            if(id) {
                const idx = appData.accounts.findIndex(x => x.id === id);
                appData.accounts[idx] = { ...appData.accounts[idx], name, kind, currency: curr, init };
            } else {
                appData.accounts.push({ id: 'acc_'+Date.now(), name, kind, currency: curr, init });
            }
            document.getElementById('accForm').classList.add('hidden');
            saveData();
        }
        function delAccount(id) {
            if(!confirm("Eliminar cuenta? (No elimina transacciones históricas)")) return;
            pushHistory();
            appData.accounts = appData.accounts.filter(x => x.id !== id);
            saveData();
        }

        // --- MODAL & TX LOGIC ---
        function setType(t){
            document.getElementById('fType').value=t;
            const bE=document.getElementById('btnExp'), bI=document.getElementById('btnInc'), bT=document.getElementById('btnTrf');
            const def="flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
            bE.className=def; bI.className=def; bT.className=def;

            document.getElementById('catSection').classList.remove('hidden');
            document.getElementById('linkRow').classList.add('hidden');
            document.getElementById('lblDesc').innerText = "Concepto";
            document.getElementById('fCat').value = ''; document.getElementById('conceptBox').innerHTML = '';

            // Render Accounts
            renderAccountOptions();

            if(t==='exp') {
                bE.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-danger";
                document.getElementById('linkRow').classList.remove('hidden'); renderLinkChips();
                renderChips('exp');
                document.getElementById('accSelectors').classList.remove('hidden');
                document.getElementById('fromAccBox').classList.remove('hidden');
                document.getElementById('toAccBox').classList.add('hidden');
            } else if(t==='inc') {
                bI.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-success";
                renderChips('inc'); document.getElementById('lblDesc').innerText = "Detalle";
                document.getElementById('accSelectors').classList.remove('hidden');
                document.getElementById('fromAccBox').classList.add('hidden');
                document.getElementById('toAccBox').classList.remove('hidden');
            } else { // Transfer
                bT.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-slate-800";
                document.getElementById('catSection').classList.add('hidden');
                document.getElementById('fCat').value = 'Transferencia';
                document.getElementById('fDesc').value = 'Traspaso de fondos';
                document.getElementById('accSelectors').classList.remove('hidden');
                document.getElementById('fromAccBox').classList.remove('hidden');
                document.getElementById('toAccBox').classList.remove('hidden');
            }
        }

        function renderAccountOptions() {
            const opts = appData.accounts.map(a => `<option value="${a.id}">${a.name} (${a.currency})</option>`).join('');
            document.getElementById('fFromAcc').innerHTML = opts;
            document.getElementById('fToAcc').innerHTML = opts;
        }

        function editTx(id) {
            const t=appData.txs.find(x=>x.id==id); if(!t)return; editId=id;
            document.getElementById('mTitle').innerText='Editar'; document.getElementById('btnDel').classList.remove('hidden');
            document.getElementById('fDate').value=t.date; document.getElementById('fDesc').value=t.desc; document.getElementById('fExec').checked=t.exec;
            document.getElementById('fAmt').value = t.origAmt || t.amount; document.getElementById('fCurr').value = t.origCurr || 'ARS';
            
            setType(t.type);
            setTimeout(() => {
                document.getElementById('fCat').value = t.cat;
                if(t.type !== 'transfer') { renderChips(t.type); renderConcepts(t.cat); }
                if(t.type === 'exp') { document.getElementById('fLink').value = t.linkId || ""; renderLinkChips(t.linkId); }
                if(t.fromAccountId) document.getElementById('fFromAcc').value = t.fromAccountId;
                if(t.toAccountId) document.getElementById('fToAcc').value = t.toAccountId;
            }, 50);
            calcConversion();
            document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex');
        }

        // --- ALERTS & BULK ACTIONS ---
        function computeAlerts(txs) {
            const alerts = []; const y = currentDate.getFullYear(); const m = currentDate.getMonth();
            const catMap = {}; txs.filter(t => t.type === 'exp').forEach(t => { catMap[t.cat] = (catMap[t.cat] || 0) + t.amount; });
            
            // 1. Trends
            Object.entries(catMap).forEach(([cat, amount]) => { 
                const avg = getPastAverage(cat, m, y); 
                if (avg > 0 && (amount - avg) / avg >= 0.20) {
                     alerts.push({ id: `trend-${cat}`, severity: 'warning', title: `Suba: ${cat}`, desc: `+${Math.round(((amount-avg)/avg)*100)}% vs prom.`, ctaLabel: 'Ver', ctaAction: `filterExpList('${cat}')` }); 
                }
            });
            
            // 2. Unassigned
            const unassignedAmt = txs.filter(t => t.type === 'exp' && !t.linkId).reduce((a, b) => a + b.amount, 0);
            if (unassignedAmt > 0) alerts.push({ id: 'unassigned', severity: 'warning', title: 'Sin asignar', desc: `$${fmt(unassignedAmt)} pendientes`, ctaLabel: 'Filtrar', ctaAction: "filterExpList('sin asignar')" });
            
            // 3. Pacing (Simple)
            const d = new Date();
            if(d.getMonth() === m && d.getFullYear() === y) {
                 const days = new Date(y, m+1, 0).getDate();
                 const prog = d.getDate() / days;
                 const tot = txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
                 if(tot > 0) {
                     Object.entries(catMap).forEach(([cat, amt]) => {
                         if((amt/tot) > (prog * 2.5) && (amt/tot) > 0.05) {
                             alerts.push({id: `pace-${cat}`, severity: 'info', title: `Ritmo: ${cat}`, desc: `Gasto acelerado (${Math.round((amt/tot)*100)}% del total)`, ctaLabel:'Ver', ctaAction:`filterExpList('${cat}')`});
                         }
                     });
                 }
            }

            return alerts.slice(0, 4);
        }
        function getPastAverage(cat, m, y) { let s=0, c=0; for(let i=1; i<=3; i++) { let tm=m-i, ty=y; if(tm<0){tm+=12;ty--;} const mt = appData.txs.filter(t=>!t.deletedAt && t.type=='exp' && t.cat==cat && parseInt(t.date.split('-')[0])==ty && parseInt(t.date.split('-')[1])==tm+1); if(mt.length){s+=mt.reduce((a,b)=>a+b.amount,0);c++;} } return c>0?s/3:0; }
        function renderAlerts(alerts) { 
            const html = alerts.map(a=>`<div class="alert-card border-l-4 rounded-r-lg p-2 shadow-sm flex items-center justify-between gap-2 ${a.severity=='warning'?'border-l-amber-500 bg-amber-50':a.severity=='danger'?'border-l-red-500 bg-red-50':'border-l-blue-500 bg-blue-50'}"><div class="min-w-0"><h4 class="text-xs font-bold truncate">${a.title}</h4><p class="text-[10px] opacity-80 truncate">${a.desc}</p></div><button onclick="${a.ctaAction}" class="text-[10px] font-bold underline">Ir</button></div>`).join('');
            document.getElementById('dashboardAlerts').innerHTML = html;
            document.getElementById('analyticsAlerts').innerHTML = html;
        }

        // --- BULK FUNCTIONS ---
        function toggleSelectionMode(){isSelectionMode=!isSelectionMode;if(!isSelectionMode)selectedTxIds.clear();updateSelectionUI();loadMonthData();}
        function toggleTxSelected(id){if(selectedTxIds.has(id))selectedTxIds.delete(id);else selectedTxIds.add(id);loadMonthData();updateSelectionUI();}
        function updateSelectionUI(){const b=document.getElementById('bulkBar');if(isSelectionMode&&selectedTxIds.size>0){b.classList.remove('hidden');document.getElementById('bulkCount').innerText=selectedTxIds.size;}else b.classList.add('hidden');document.getElementById('btnSelectMode').classList.toggle('text-primary',isSelectionMode);}
        function openBulkModal(){document.getElementById('bulkModal').classList.remove('hidden'); resetBulkView();}
        function closeBulkModal(){document.getElementById('bulkModal').classList.add('hidden');}
        function resetBulkView(){document.getElementById('bulkMainOptions').classList.remove('hidden');document.getElementById('bulkSubCategory').classList.add('hidden');document.getElementById('bulkSubLink').classList.add('hidden');}
        function showBulkSubOption(t){
            document.getElementById('bulkMainOptions').classList.add('hidden');
            if(t=='category'){
                document.getElementById('bulkSubCategory').classList.remove('hidden');
                const l=document.getElementById('bulkCatList');l.innerHTML='';
                appData.cats.exp.forEach(c=>{const b=document.createElement('button');b.className="text-left text-xs p-2 hover:bg-slate-50 rounded border border-transparent hover:border-primary w-full";b.innerText=c;b.onclick=()=>bulkApply('cat',c);l.appendChild(b)});
            }
            if(t=='link'){
                document.getElementById('bulkSubLink').classList.remove('hidden');
                const l=document.getElementById('bulkLinkList');l.innerHTML='';
                const y=currentDate.getFullYear(),m=currentDate.getMonth()+1;
                appData.txs.filter(x=>!x.deletedAt&&x.type=='inc'&&parseInt(x.date.split('-')[1])==m).forEach(i=>{const b=document.createElement('button');b.className="text-left text-xs p-2 hover:bg-slate-50 rounded border border-transparent hover:border-primary w-full";b.innerHTML=`<b>${i.desc}</b> $${fmt(i.amount)}`;b.onclick=()=>bulkApply('linkId',i.id);l.appendChild(b)});
            }
        }
        function bulkApply(field, val){
            pushHistory();
            selectedTxIds.forEach(id=>{ const t=appData.txs.find(x=>x.id==id); if(t && t.type=='exp') t[field]=val; });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }
        function bulkSetExec(val){ pushHistory(); selectedTxIds.forEach(id=>{const t=appData.txs.find(x=>x.id==id);if(t)t.exec=val;}); saveData(); toggleSelectionMode(); closeBulkModal(); }
        function bulkUnassignIncome(){ bulkApply('linkId',null); }
        function bulkDelete(){ if(confirm('Eliminar seleccionados?')){ pushHistory(); selectedTxIds.forEach(id=>{const t=appData.txs.find(x=>x.id==id);if(t)t.deletedAt=Date.now();}); saveData(); toggleSelectionMode(); closeBulkModal(); } }


        // --- STANDARD RENDER ---
        function renderLists(txs) {
            const lI=document.getElementById('list-inc'), lE=document.getElementById('list-exp'), lA=document.getElementById('list-alloc');
            lI.innerHTML=''; lE.innerHTML=''; lA.innerHTML=''; let rb=0;
            const incTxs = txs.filter(t=>t.type=='inc'); const expTxs = txs.filter(t=>t.type=='exp');
            incTxs.forEach(t=>rb+=t.amount); expTxs.forEach(t=>rb-=t.amount);
            
            const drawRow = (t, dest) => {
                let badge = (t.origCurr && t.origCurr !== 'ARS') ? `<span class="bg-blue-50 text-blue-600 text-[9px] px-1 ml-1 rounded font-bold">${t.origAmt} ${t.origCurr}</span>` : '';
                const el = document.createElement('div');
                const isSel = selectedTxIds.has(t.id);
                el.className = `compact-row flex items-center justify-between cursor-pointer ${isSelectionMode&&isSel?'bg-blue-50/50 selected':t.exec?'opacity-60 bg-slate-50/50 line-through':''}`;
                el.onclick = () => { if(isSelectionMode&&t.type=='exp') toggleTxSelected(t.id); else if(!isSelectionMode) editTx(t.id); };
                let icon = isSelectionMode && t.type=='exp' ? `<div class="bulk-chk ${isSel?'checked':''}"><i class="material-symbols-outlined text-[10px]">check</i></div>` : (t.exec ? `<span class="material-symbols-outlined text-base text-primary">check_circle</span>` : `<div class="size-4 rounded-full border-2 border-slate-200"></div>`);
                el.innerHTML = `<div class="flex items-center gap-3 w-full"><div class="shrink-0 flex justify-center size-6">${icon}</div><div class="min-w-0 flex-1"><div class="flex justify-between"><p class="text-xs font-bold text-slate-800 truncate">${t.desc} ${badge}</p><p class="text-xs font-bold ${t.type=='inc'?'text-success':'text-danger'} ml-2">$${fmt(t.amount)}</p></div><div class="flex justify-between mt-0.5"><div class="flex gap-2"><span class="text-[9px] text-slate-500 bg-slate-100 px-1 rounded">${t.cat||'Gral'}</span></div></div></div></div>`;
                dest.appendChild(el);
            };
            incTxs.forEach(t => drawRow(t, lI)); expTxs.forEach(t => drawRow(t, lE));
            document.getElementById('c-inc').innerText = incTxs.length; document.getElementById('c-exp').innerText = expTxs.length;
            
            // Allocation Logic
            incTxs.forEach(inc => {
                const subs = expTxs.filter(t=>t.linkId==inc.id); const spent = subs.reduce((a,b)=>a+b.amount,0); const pct = Math.min(100, (spent/inc.amount)*100);
                const el = document.createElement('div'); el.innerHTML=`<div class="rounded-xl border border-slate-200 bg-white mb-2 shadow-sm overflow-hidden"><div class="p-3 flex justify-between items-center"><div class="flex-1"><p class="text-[11px] font-bold text-slate-700">${inc.desc}</p><p class="text-[10px] font-extrabold ${inc.amount-spent>=0?'text-success':'text-danger'}">$${fmt(inc.amount-spent)}</p></div><span class="text-[9px] font-bold">${Math.round(pct)}%</span></div><div class="w-full h-1 bg-slate-100"><div class="h-full bg-primary" style="width:${pct}%"></div></div></div>`;
                lA.appendChild(el);
            });
            const orphans = expTxs.filter(t=>!t.linkId).reduce((a,b)=>a+b.amount,0);
            if(orphans>0) { lA.innerHTML+=`<div class="rounded-xl border-l-4 border-l-danger border border-slate-200 bg-white p-3 shadow-sm mb-2"><p class="text-[11px] font-bold text-slate-700">Sin Asignar</p><p class="text-[10px] font-extrabold text-danger">$${fmt(orphans)}</p></div>`; }
        }

        function calcConversion() { const a=parseFloat(document.getElementById('fAmt').value)||0, c=document.getElementById('fCurr').value, r=parseFloat(document.getElementById('rate_ARS').value)||1200; let f=a; if(c=='USD')f=a*r; if(c=='COP')f=(a/parseFloat(document.getElementById('rate_COP').value))*r; document.getElementById('convResult').innerText=`$${fmt(f)} ARS`; document.getElementById('convPreview').classList.toggle('hidden', c=='ARS'); return f; }
        function renderChips(t){const c=document.getElementById('chipBox');c.innerHTML='';(t=='inc'?appData.cats.inc:appData.cats.exp).forEach(x=>{const d=document.createElement('div');d.className=`chip px-3 py-1 cursor-pointer ${document.getElementById('fCat').value==x?'active':''}`;d.innerText=x;d.onclick=()=>{document.getElementById('fCat').value=x;renderChips(t);renderConcepts(x)};c.appendChild(d)})}
        function renderConcepts(k){const b=document.getElementById('conceptBox');b.innerHTML='';(appData.concepts[k]||[]).forEach(c=>{const e=document.createElement('div');e.className='cat-tag px-2 py-1 text-xs cursor-pointer';e.innerText=c;e.onclick=()=>{document.getElementById('fDesc').value=c};b.appendChild(e)})}
        function renderLinkChips(id){const c=document.getElementById('linkChipsContainer');c.innerHTML='';const y=currentDate.getFullYear(),m=currentDate.getMonth()+1;appData.txs.filter(t=>!t.deletedAt&&t.type=='inc'&&parseInt(t.date.split('-')[1])==m).forEach(i=>{const bal=i.amount-appData.txs.filter(x=>!x.deletedAt&&x.type=='exp'&&x.linkId==i.id&&x.id!=editId).reduce((a,b)=>a+b.amount,0);if(bal<1&&i.id!=id)return;const d=document.createElement('div');d.className=`chip px-2 py-1 ${id==i.id?'active':''}`;d.innerHTML=`<b>${i.desc}</b> <span class="opacity-70">($${fmt(bal)})</span>`;d.onclick=()=>{document.getElementById('fLink').value=i.id;renderLinkChips(i.id)};c.appendChild(d)})}
        
        document.getElementById('txForm').onsubmit=e=>{
            e.preventDefault();
            const t=document.getElementById('fType').value;
            const cat=document.getElementById('fCat').value;
            if(t!=='transfer' && !cat) return alert('Categoría?');
            pushHistory();
            if(cat && t!=='transfer') { if(!appData.concepts[cat]) appData.concepts[cat]=[]; const d=document.getElementById('fDesc').value; if(!appData.concepts[cat].includes(d)) appData.concepts[cat].push(d); }
            
            const tx={
                id:editId||Date.now(), date:document.getElementById('fDate').value,
                amount:calcConversion(), origAmt:parseFloat(document.getElementById('fAmt').value), origCurr:document.getElementById('fCurr').value,
                type:t, cat, desc:document.getElementById('fDesc').value, exec:document.getElementById('fExec').checked,
                linkId:t=='exp'?document.getElementById('fLink').value:null, deletedAt:null,
                fromAccountId: (t=='exp'||t=='transfer') ? document.getElementById('fFromAcc').value : null,
                toAccountId: (t=='inc'||t=='transfer') ? document.getElementById('fToAcc').value : null
            };
            if(editId){const i=appData.txs.findIndex(x=>x.id==editId);appData.txs[i]=tx;}else appData.txs.push(tx);
            saveData(); closeModal();
        }

        function resetForm(){document.getElementById('txForm').reset();editId=null;document.getElementById('mTitle').innerText='Nuevo';document.getElementById('btnDel').classList.add('hidden');document.getElementById('fDate').value=new Date().toISOString().split('T')[0];document.getElementById('convPreview').classList.add('hidden');}
        function delTx(){if(confirm('Eliminar?')){pushHistory();appData.txs.find(x=>x.id==editId).deletedAt=Date.now();saveData();closeModal();}}
        function closeModal(){document.getElementById('modalOverlay').classList.add('hidden');}
        
        // --- CHARTS & HELPERS ---
        function renderCharts(txs){
             let cE=null, cI=null; 
             const doCh=(id,d,k,pal)=>{const ctx=document.getElementById(id);if(ctx.chart)ctx.chart.destroy(); const map={}; d.forEach(t=>{const n=t[k]||'Gral';map[n]=(map[n]||0)+t.amount}); const vs=Object.entries(map).sort((a,b)=>b[1]-a[1]); ctx.chart=new Chart(ctx,{type:'doughnut',data:{labels:vs.map(x=>x[0]),datasets:[{data:vs.map(x=>x[1]),backgroundColor:pal,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});};
             doCh('chartExp', txs.filter(t=>t.type=='exp'), 'cat', PALETTE);
             doCh('chartInc', txs.filter(t=>t.type=='inc'), 'desc', PALETTE);
        }
        function resetCharts(){renderCharts(appData.txs.filter(t=>!t.deletedAt));} 
        function updateKPIs(txs){const tc=parseFloat(document.getElementById('rate_ARS').value)||1200;const i=txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);const e=txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);document.getElementById('k-inc').innerText='$'+fmt(i);document.getElementById('k-exp').innerText='$'+fmt(e);const b=i-e;const be=document.getElementById('k-bal');be.innerText='$'+fmt(b);be.className=`text-2xl font-black tracking-tight ${b>=0?'text-emerald-700':'text-rose-700'}`;document.getElementById('k-usd').innerText='USD '+fmt(b/tc);}
        function filterExpList(term){
            const v=term||document.getElementById('searchExpInput').value.toLowerCase();
            document.getElementById('searchExpInput').value = v;
            const rows=document.querySelectorAll('#list-exp .compact-row');
            rows.forEach(r=>{const t=r.innerText.toLowerCase();if((v=='sin asignar' && !r.innerHTML.includes('bg-slate-100')) || t.includes(v))r.classList.remove('hidden');else r.classList.add('hidden');});
        }
        function nav(v,el){document.querySelectorAll('.view-container').forEach(e=>e.classList.add('hidden-view'));document.getElementById(`view-${v}`).classList.remove('hidden-view');document.querySelectorAll('#main-nav button').forEach(e=>e.classList.remove('active-nav'));if(el)el.classList.add('active-nav');}
        
        // --- Admin Functions ---
        function manualAddCat(){const n=document.getElementById('newCatName').value;if(n){pushHistory();const t=document.getElementById('newCatType').value;if(t=='exp')appData.cats.exp.push(n);else appData.cats.inc.push(n);saveData();}}
        function changeMonth(d){currentDate.setMonth(currentDate.getMonth()+d);updateDateUI();loadMonthData();}
        function manualDate(){const [y,m]=document.getElementById('datePicker').value.split('-');currentDate.setFullYear(y);currentDate.setMonth(m-1);updateDateUI();loadMonthData();}
        function updateDateUI(){document.getElementById('monthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`;document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`;}
        function saveMonthlyRates() { const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1; appData.monthlyRates[`${y}-${m.toString().padStart(2,'0')}`] = { ARS: parseFloat(document.getElementById('rate_ARS').value), COP: parseFloat(document.getElementById('rate_COP').value), USD: 1 }; saveData(); }
        
        // --- Recurrentes/Auto/Clone (Previous Logic) ---
        function renderRecurrentesAdmin() { const b=document.getElementById('recurrente-table-body'); b.innerHTML=''; appData.recurrentes.forEach((r,i)=>{const d=document.createElement('div'); d.className='flex gap-2 items-center text-xs border-b border-slate-200 py-1 last:border-0'; d.innerHTML=`<input value="${r.desc}" onchange="pushHistory();appData.recurrentes[${i}].desc=this.value" class="w-1/3 border-slate-200 rounded px-1 py-0.5"><input type="number" value="${r.amount}" onchange="pushHistory();appData.recurrentes[${i}].amount=parseFloat(this.value)" class="w-1/4 border-slate-200 rounded px-1 py-0.5 text-right"><span class="text-slate-400 text-[10px] w-1/4">${r.cat}</span><button onclick="deleteRecurrente(${i})" class="text-red-400 hover:text-red-600 font-bold px-2">x</button>`; b.appendChild(d);}); }
        function deleteRecurrente(i) { pushHistory(); appData.recurrentes.splice(i,1); saveData(); }
        function addRecurrenteRow() { pushHistory(); appData.recurrentes.push({desc:'Nuevo', amount:0, cat:'Esenciales', type:'exp'}); renderRecurrentesAdmin(); }
        function saveRecurrentesConfig() { saveData(); alert('Guardado'); }
        function executeRecurrentes() { const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; let c=0; appData.recurrentes.forEach(r=>{ if(!appData.txs.some(t=>!t.deletedAt && t.desc==r.desc && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m)){ appData.txs.push({...r, id:Date.now()+Math.random(), date:`${y}-${m.toString().padStart(2,'0')}-01`, exec:false, linkId:null, deletedAt:null, origAmt:r.amount, origCurr:'ARS', fromAccountId:'acc_def'}); c++; }}); if(c>0){ pushHistory(); saveData(); alert('Generados: '+c);} else alert('Ya estaban cargados'); }
        function autoAssign() { if(!confirm("Asignar auto?")){return;} const y=currentDate.getFullYear(),m=currentDate.getMonth()+1; const txs=appData.txs.filter(t=>!t.deletedAt && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m); let c=0; txs.filter(t=>t.type=='exp'&&!t.linkId).forEach(exp=>{ const inc=txs.find(i=>i.type=='inc' && i.date<=exp.date && (i.amount - txs.filter(e=>e.linkId==i.id).reduce((a,b)=>a+b.amount,0))>=exp.amount); if(inc){exp.linkId=inc.id;c++;}}); alert(c>0?`Asignados: ${c}`:'Nada nuevo'); saveData(); }
        function unassignAll(){ if(confirm("Reset asignaciones mes?")){ pushHistory(); const y=currentDate.getFullYear(),m=currentDate.getMonth()+1; appData.txs.forEach(t=>{if(!t.deletedAt && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m && t.type=='exp') t.linkId=null;}); saveData(); }}
        function renderAdminTree() {
            const container = document.getElementById('adminTreeContainer'); container.innerHTML = '';
            const buildBranch = (title, type) => {
                const cats = type === 'inc' ? appData.cats.inc : appData.cats.exp;
                let html = `<div class="mb-1"><h4 class="font-bold text-[10px] text-slate-500 uppercase">${title}</h4><div class="space-y-1">`;
                cats.forEach(c => {
                    const concepts = appData.concepts[c] || [];
                    html += `<details class="group bg-slate-50 rounded-lg border border-slate-100"><summary class="flex justify-between p-1.5 cursor-pointer hover:bg-slate-100"><span class="text-[11px] font-bold text-slate-700">${c}</span><span class="text-[9px] text-slate-400">${concepts.length}</span></summary><div class="p-1.5 pt-0 border-t border-slate-100 bg-white"><div class="flex flex-wrap gap-1 mb-1 mt-1">${concepts.map(con=>`<div class="cat-tag">${con}</div>`).join('')}</div></div></details>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            };
            buildBranch("Gastos", "exp");
            buildBranch("Ingresos", "inc");
        }
        function populateRecurringDefaults(){
            if(!confirm("Sugerir recurrentes?")){return;}
            const limit = new Date(); limit.setDate(limit.getDate()-90);
            const rec = appData.txs.filter(t=>!t.deletedAt && t.type=='exp' && new Date(t.date)>=limit);
            const map = {}; rec.forEach(t=>{const d=t.desc.trim(); if(!map[d])map[d]={c:0,a:t.amount,cat:t.cat}; map[d].c++;});
            let c=0;
            Object.entries(map).forEach(([d,v])=>{
                if(v.c>=3 && !appData.recurrentes.some(r=>r.desc==d)){
                    appData.recurrentes.push({desc:d, amount:v.a, cat:v.cat, type:'exp'});
                    c++;
                }
            });
            alert(c>0?`Sugeridos: ${c}`:'No se encontraron patrones');
            renderRecurrentesAdmin(); saveData();
        }
    </script>
</body>
</html>
