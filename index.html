<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Finanzas J&M | Desktop</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#0e757c", "primary-dark": "#085055", "surface": "#ffffff", "success": "#15803d", "danger": "#b91c1c", "warning": "#b45309" },
                    fontFamily: { "display": ["Manrope", "sans-serif"], "body": ["Inter", "sans-serif"] }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Manrope', sans-serif; background-color: #f8fafc; }
        .glass-sidebar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-right: 1px solid #e2e8f0; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hidden-view { display: none !important; }
        .active-nav { background-color: rgba(14, 117, 124, 0.08); color: #0e757c; border-right: 3px solid #0e757c; }
        .d-picker { position: absolute; inset:0; opacity:0; cursor: pointer; width: 100%; }
        
        .compact-row { padding: 6px 10px; border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
        .compact-row:last-child { border-bottom: none; }
        .compact-row:hover { background-color: #f8fafc; }
        .compact-row.selected { background-color: #f0f9ff; }
        
        .chip { border: 1px solid #e2e8f0; background: white; color: #475569; font-size: 11px; font-weight: 600; transition: all 0.1s; border-radius: 20px; }
        .chip:hover { border-color: #0e757c; color: #0e757c; }
        .chip.active { background: #0e757c; color: white; border-color: #0e757c; box-shadow: 0 2px 4px rgba(14,117,124,0.3); }
        
        .cat-tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: #f1f5f9; color: #64748b; border: 1px solid transparent; }
        .cat-tag:hover { border-color: #cbd5e1; color: #334155; background: white; }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .tc-input { 
            -moz-appearance: textfield; 
            background: transparent; 
            border: none; 
            padding: 0 4px; 
            margin: 0; 
            font-weight: 700; 
            color: #334155; 
            text-align: right; 
            width: 90px; 
            font-size: 12px;
            height: 100%;
        }
        .tc-input:focus { outline: none; ring: 0; border-bottom: 1px solid #0e757c; }
        
        .h-header-el { height: 32px; }

        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        .btn-disabled { opacity: 0.3; pointer-events: none; }
        
        /* Checkbox custom style for bulk edit */
        .bulk-chk { width: 16px; height: 16px; border-radius: 4px; border: 2px solid #cbd5e1; display:flex; align-items:center; justify-content:center; transition:0.2s; }
        .bulk-chk.checked { background: #0e757c; border-color: #0e757c; }
        .bulk-chk i { color:white; font-size:12px; display:none; }
        .bulk-chk.checked i { display:block; }
    </style>
</head>

<body class="text-slate-900 h-screen flex overflow-hidden selection:bg-primary/20">

    <aside class="glass-sidebar w-16 hover:w-64 transition-all duration-300 group fixed h-screen z-40 flex flex-col justify-between py-4 shadow-xl">
        <div class="flex flex-col gap-6">
            <div class="flex items-center justify-center h-10 px-2 group-hover:justify-start group-hover:px-4 transition-all">
                <div class="bg-primary size-8 rounded-lg flex items-center justify-center text-white shrink-0 shadow-md">
                    <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                </div>
                <h1 class="font-bold text-sm text-primary ml-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap overflow-hidden delay-75 tracking-tight">Finanzas Personales J&M</h1>
            </div>

            <nav class="flex flex-col gap-1 px-2" id="main-nav">
                <button onclick="nav('dashboard', this)" id="nav-dashboard" class="active-nav flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">dashboard</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Operaciones</span>
                </button>
                <button onclick="nav('analytics', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">query_stats</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Análisis</span>
                </button>
                <button onclick="nav('admin', this)" class="flex items-center h-10 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">settings</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Ajustes</span>
                </button>
                <button onclick="forceSync()" class="flex items-center h-10 rounded-lg px-2 text-primary hover:bg-slate-100 transition-colors w-full overflow-hidden mt-2 border-t border-slate-100 pt-2" title="Forzar Sincronización">
                    <span class="material-symbols-outlined text-xl shrink-0" id="syncIcon">cloud_sync</span>
                    <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Sincronizar</span>
                </button>
            </nav>
        </div>

        <div class="px-2">
            <button onclick="openModal()" class="flex items-center justify-center w-full h-10 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-lg transition-all mb-4 group-hover:justify-start group-hover:px-3">
                <span class="material-symbols-outlined text-xl">add</span>
                <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Nuevo</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 ml-16 p-4 lg:p-6 h-screen overflow-hidden relative flex flex-col">
        
        <header class="flex justify-between items-center mb-3 shrink-0 gap-4 h-header-el">
            <div class="flex items-center gap-4 h-full">
                <h2 class="text-xl font-extrabold tracking-tight text-slate-800 leading-none" id="pageTitle">Panel de Control</h2>
                
                <div class="flex items-center gap-1 bg-white px-2 rounded-md border border-slate-200 shadow-sm transition-colors relative group h-full">
                    <button onclick="changeMonth(-1)" class="text-slate-400 hover:text-primary flex items-center px-1"><span class="material-symbols-outlined text-sm">chevron_left</span></button>
                    <div class="relative min-w-[80px] text-center flex items-center justify-center h-full">
                        <span class="text-[11px] font-bold uppercase text-slate-600 tracking-wide" id="monthTxt">...</span>
                        <input type="month" id="datePicker" class="d-picker" onchange="manualDate()">
                    </div>
                    <button onclick="changeMonth(1)" class="text-slate-400 hover:text-primary flex items-center px-1"><span class="material-symbols-outlined text-sm">chevron_right</span></button>
                    <div class="w-px h-4 bg-slate-200 mx-1"></div>
                    <button onclick="undo()" id="btnUndo" class="text-slate-400 hover:text-primary flex items-center px-1 btn-disabled" title="Deshacer (Ctrl+Z)"><span class="material-symbols-outlined text-sm">undo</span></button>
                    <button onclick="redo()" id="btnRedo" class="text-slate-400 hover:text-primary flex items-center px-1 btn-disabled" title="Rehacer (Ctrl+Y)"><span class="material-symbols-outlined text-sm">redo</span></button>
                </div>
            </div>
            
            <div class="flex items-center gap-3 bg-white px-3 rounded-md border border-slate-200 shadow-sm h-full shrink-0">
                <span class="material-symbols-outlined text-slate-400 text-sm">currency_exchange</span>
                <div class="flex items-center gap-2 border-r border-slate-100 pr-3 h-full">
                    <span class="text-[10px] font-bold text-slate-400">USD</span>
                    <div class="flex items-center h-full">
                        <span class="text-[10px] text-slate-300 mr-1">$</span>
                        <input type="number" id="rate_ARS" onchange="pushHistory(); saveMonthlyRates()" class="tc-input" placeholder="0">
                    </div>
                </div>
                <div class="flex items-center gap-2 h-full">
                    <span class="text-[10px] font-bold text-slate-400">COP</span>
                    <div class="flex items-center h-full">
                        <span class="text-[10px] text-slate-300 mr-1">$</span>
                        <input type="number" id="rate_COP" step="0.01" onchange="pushHistory(); saveMonthlyRates()" class="tc-input" placeholder="0">
                    </div>
                </div>
            </div>
        </header>

        <div id="view-dashboard" class="view-container animate-fade-in flex flex-col flex-1 min-h-0 gap-3 relative">
            
            <section class="grid grid-cols-4 gap-3 shrink-0">
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Balance Neto</p>
                    <h3 class="text-xl font-black text-slate-800 tracking-tight" id="k-bal">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Estimado USD</p>
                    <h3 class="text-lg font-bold text-primary" id="k-usd">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-success">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Ingresos</p>
                    <h3 class="text-lg font-bold text-success" id="k-inc">$0</h3>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-center border-l-4 border-l-danger">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Gastos</p>
                    <h3 class="text-lg font-bold text-danger" id="k-exp">$0</h3>
                </div>
            </section>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-3 flex-1 min-h-0">
                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5"><span class="material-symbols-outlined text-success text-sm">arrow_circle_up</span> Ingresos</h4>
                        <span class="bg-success/10 text-success text-[9px] font-bold px-1.5 py-0.5 rounded-full" id="c-inc">0</span>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-0" id="list-inc"></div>
                </section>
                
                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <div class="flex items-center gap-2 flex-1 mr-2">
                            <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5 shrink-0">
                                <span class="material-symbols-outlined text-danger text-sm">arrow_circle_down</span> Gastos
                            </h4>
                            <input type="text" id="searchExpInput" oninput="filterExpList()" placeholder="Buscar..." class="w-full max-w-[100px] bg-white border-none text-[10px] rounded-md px-2 py-0.5 focus:ring-1 focus:ring-primary shadow-sm placeholder:text-slate-300">
                        </div>
                        <div class="flex items-center gap-1">
                             <button onclick="toggleSelectionMode()" id="btnSelectMode" class="text-slate-400 hover:text-primary transition-colors p-1" title="Seleccionar múltiple">
                                <span class="material-symbols-outlined text-base">check_box</span>
                             </button>
                             <span class="bg-danger/10 text-danger text-[9px] font-bold px-1.5 py-0.5 rounded-full" id="c-exp">0</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-0" id="list-exp"></div>
                </section>

                <section class="flex flex-col glass-panel rounded-xl overflow-hidden h-full">
                    <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 bg-slate-50/50 shrink-0">
                        <h4 class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5"><span class="material-symbols-outlined text-primary text-sm">pie_chart</span> Asignación</h4>
                    </div>
                    <div class="px-2 py-2 flex gap-2 border-b border-slate-100 bg-white">
                        <button onclick="autoAssign()" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:to-blue-700 text-white text-[10px] font-bold py-1.5 rounded-lg shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-sm">auto_fix_high</span> Auto-Asignar
                        </button>
                        <button onclick="unassignAll()" class="flex-1 bg-white border border-slate-200 text-slate-500 text-[10px] font-bold py-1.5 rounded-lg hover:text-red-500 hover:border-red-200 transition-all flex items-center justify-center gap-1">
                            <span class="material-symbols-outlined text-sm">link_off</span> Desasignar Todo
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar p-2 flex flex-col gap-2" id="list-alloc"></div>
                </section>
            </div>

            <div id="bulkBar" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-full shadow-xl flex items-center gap-4 z-50 animate-fade-in">
                <span class="text-xs font-bold" id="bulkCount">0 seleccionados</span>
                <div class="h-4 w-px bg-slate-700"></div>
                <button onclick="openBulkModal()" class="text-xs font-bold hover:text-primary-300 transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">edit_square</span> Acciones
                </button>
                <button onclick="toggleSelectionMode()" class="text-xs text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-sm">close</span>
                </button>
            </div>

        </div>

        <div id="view-analytics" class="view-container animate-fade-in hidden-view grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1 min-h-0">
            <div class="glass-panel rounded-xl p-4 flex flex-col h-[360px]">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-bold text-slate-700">Gastos por Categoría</h3><button onclick="resetCharts()" class="text-[10px] text-primary font-bold hover:underline hidden" id="resetBtn">VOLVER</button></div>
                <div class="flex items-center gap-4 flex-1 min-h-0 overflow-hidden"><div class="relative h-[200px] w-[200px] shrink-0"><canvas id="chartExp"></canvas></div><div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-1" id="legExp"></div></div>
            </div>
            <div class="glass-panel rounded-xl p-4 flex flex-col h-[360px]">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-bold text-slate-700">Ingresos por Concepto</h3></div>
                <div class="flex items-center gap-4 flex-1 min-h-0 overflow-hidden"><div class="relative h-[200px] w-[200px] shrink-0"><canvas id="chartInc"></canvas></div><div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-1" id="legInc"></div></div>
            </div>
        </div>

        <div id="view-admin" class="view-container animate-fade-in hidden-view grid grid-cols-1 lg:grid-cols-2 gap-2 flex-1 min-h-0 pt-1">
            <div class="glass-panel rounded-xl p-2 flex flex-col h-full overflow-hidden">
                <h3 class="text-xs font-bold text-slate-800 mb-2 flex items-center gap-2 px-1">
                    <span class="material-symbols-outlined text-base text-primary">folder_open</span> Gestión de Categorías
                </h3>
                <div class="flex gap-1 mb-2 bg-slate-50 p-1 rounded-lg border border-slate-100">
                    <input type="text" id="newCatName" placeholder="Nueva Categoría..." class="flex-1 bg-transparent border-none text-xs px-2 focus:ring-0 font-medium">
                    <select id="newCatType" class="bg-white border-none rounded-md text-[10px] px-2 py-1 text-slate-600 shadow-sm"><option value="exp">Gasto</option><option value="inc">Ingreso</option></select>
                    <button onclick="manualAddCat()" class="bg-slate-800 text-white size-6 rounded-md hover:bg-slate-700 flex items-center justify-center shadow-sm text-xs">+</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar pr-1" id="adminTreeContainer"></div>
            </div>
            <div class="glass-panel rounded-xl p-2 flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-center mb-2 px-1">
                    <h3 class="text-xs font-bold text-slate-800">Recurrentes</h3>
                    <div class="flex gap-2">
                        <button onclick="populateRecurringDefaults()" class="text-slate-400 text-[10px] font-bold hover:text-primary transition-colors">SUGERIR (3M)</button>
                        <button onclick="addRecurrenteRow()" class="bg-primary/10 text-primary px-2 py-0.5 rounded text-[10px] font-bold hover:bg-primary hover:text-white transition-colors">+ AGREGAR</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 rounded-lg border border-slate-100 p-1 mb-2" id="recurrente-table-body"></div>
                <div class="grid grid-cols-2 gap-2 mt-auto">
                    <button onclick="saveRecurrentesConfig()" class="py-1.5 rounded-lg bg-white border border-slate-200 text-slate-600 text-[10px] font-bold hover:bg-slate-50 shadow-sm">Guardar</button>
                    <button onclick="executeRecurrentes()" class="py-1.5 rounded-lg bg-slate-800 text-white text-[10px] font-bold hover:bg-slate-700 shadow-sm">Ejecutar</button>
                    <div class="col-span-2 border-t border-slate-100 my-0.5"></div>
                    <div class="col-span-2 bg-slate-100 p-1.5 rounded-lg flex items-center justify-between">
                         <label class="block text-[9px] font-bold text-slate-400 uppercase">Clonar Mes</label>
                         <div class="flex gap-1">
                            <input type="month" id="cloneSrc" class="bg-white border-none rounded-md px-1 py-0.5 text-[10px] shadow-sm w-24">
                            <button onclick="cloneMonth()" class="text-primary font-bold text-[10px] hover:underline">Copiar</button>
                        </div>
                    </div>
                    <button onclick="clearMonth()" class="col-span-2 border border-red-100 text-red-400 py-1 rounded-lg text-[10px] font-bold uppercase hover:bg-red-50 hover:text-red-500 transition-colors">Borrar Mes Actual</button>
                </div>
            </div>
        </div>
    </main>

    <button onclick="openModal()" class="fixed bottom-6 right-6 size-12 bg-slate-900 text-white rounded-xl shadow-xl shadow-slate-900/30 flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-50">
        <span class="material-symbols-outlined text-2xl">add</span>
    </button>

    <div id="modalOverlay" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="relative z-10 w-full max-w-[380px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in mx-4 max-h-[90vh]">
            <div class="flex items-center justify-between px-5 pt-5 pb-2 shrink-0">
                <h1 class="text-lg font-bold text-slate-800" id="mTitle">Nuevo</h1>
                <button onclick="closeModal()" class="size-7 flex items-center justify-center rounded-full bg-slate-50 hover:bg-slate-100 text-slate-400 transition-colors">
                    <span class="material-symbols-outlined text-base">close</span>
                </button>
            </div>
            
            <form id="txForm" class="p-5 overflow-y-auto custom-scrollbar flex-1">
                <div class="grid grid-cols-2 p-1 bg-slate-100 rounded-xl mb-4">
                    <button type="button" id="btnExp" onclick="setType('exp')" class="flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-danger border border-slate-100">Gasto</button>
                    <button type="button" id="btnInc" onclick="setType('inc')" class="flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600">Ingreso</button>
                </div>
                <input type="hidden" id="fType" value="exp">

                <div class="flex gap-3 mb-4">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-light text-lg">$</span>
                        <input type="number" id="fAmt" step="0.01" class="w-full pl-6 pr-3 py-2.5 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-primary rounded-xl text-lg font-bold text-slate-800 outline-none text-right transition-all" placeholder="0" required oninput="calcConversion()">
                    </div>
                    <div class="w-20">
                        <select id="fCurr" onchange="calcConversion()" class="w-full h-full bg-slate-100 border-transparent rounded-xl text-[11px] font-bold focus:border-primary focus:ring-0 text-center pl-1 pr-6">
                            <option value="ARS">ARS</option>
                            <option value="USD">USD</option>
                            <option value="COP">COP</option>
                        </select>
                    </div>
                </div>
                <div id="convPreview" class="hidden text-right text-[10px] text-slate-500 font-medium -mt-2 mb-4 bg-slate-50 px-2 py-1 rounded inline-block float-right">
                    = <span id="convResult" class="text-slate-800 font-bold">$0 ARS</span>
                </div>
                <div class="clear-both"></div>

                <div class="mb-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Fecha</label>
                    <input type="date" id="fDate" class="w-full px-3 py-2.5 bg-slate-50 border-none rounded-xl text-xs font-medium focus:ring-2 focus:ring-primary/20" required>
                </div>

                <div class="mb-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Categoría</label>
                    <div class="flex flex-wrap gap-1.5" id="chipBox"></div>
                    <input type="hidden" id="fCat">
                </div>

                <div class="mb-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1" id="lblDesc">Concepto</label>
                    <div class="flex flex-wrap gap-1.5 mb-2" id="conceptBox"></div>
                    <input type="text" id="fDesc" class="w-full px-3 py-2.5 bg-slate-50 border-none rounded-xl text-xs focus:ring-2 focus:ring-primary/20 placeholder:text-slate-400" placeholder="Detalle..." required>
                </div>

                <div class="mb-4" id="linkRow">
                    <label class="block text-[10px] font-bold text-primary uppercase mb-1 ml-1">Pagar con (Fuente)</label>
                    <div id="linkChipsContainer" class="flex flex-wrap gap-1.5"></div>
                    <input type="hidden" id="fLink">
                </div>

                <div class="flex items-center gap-3 mb-5 p-2.5 border border-slate-100 rounded-xl bg-slate-50/50 hover:bg-slate-50 transition-colors cursor-pointer" onclick="document.getElementById('fExec').click()">
                    <input type="checkbox" id="fExec" class="size-4 text-primary rounded border-slate-300 focus:ring-primary bg-white">
                    <div>
                        <span class="block text-[11px] font-bold text-slate-700 select-none">Marcar como Ejecutado</span>
                        <span class="block text-[9px] text-slate-400">Congela el valor de la moneda</span>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <button type="submit" class="w-full py-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-white text-xs font-bold shadow-lg shadow-slate-900/20 active:scale-95 transition-all">GUARDAR</button>
                    <button type="button" id="btnDel" onclick="delTx()" class="text-[10px] text-red-500 font-bold hover:bg-red-50 py-2 rounded-lg transition-colors hidden">Eliminar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bulkModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeBulkModal()"></div>
        <div class="relative z-10 w-full max-w-sm bg-white rounded-2xl shadow-2xl p-4 animate-fade-in mx-4">
            <h3 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2">Acciones Masivas</h3>
            
            <div id="bulkMainOptions" class="grid grid-cols-1 gap-2">
                <button onclick="showBulkSubOption('category')" class="p-3 text-left rounded-lg border border-slate-200 hover:border-primary hover:bg-slate-50 flex items-center justify-between group">
                    <span class="text-xs font-bold text-slate-600 group-hover:text-slate-800">Cambiar Categoría</span>
                    <span class="material-symbols-outlined text-base text-slate-400">category</span>
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="bulkSetExec(true)" class="p-2 text-left rounded-lg border border-slate-200 hover:border-primary hover:bg-slate-50 text-xs font-bold text-slate-600">Marcar Ejecutado</button>
                    <button onclick="bulkSetExec(false)" class="p-2 text-left rounded-lg border border-slate-200 hover:border-primary hover:bg-slate-50 text-xs font-bold text-slate-600">Marcar Pendiente</button>
                </div>
                <button onclick="showBulkSubOption('link')" class="p-3 text-left rounded-lg border border-slate-200 hover:border-primary hover:bg-slate-50 flex items-center justify-between group">
                    <span class="text-xs font-bold text-slate-600 group-hover:text-slate-800">Asignar a Ingreso</span>
                    <span class="material-symbols-outlined text-base text-slate-400">link</span>
                </button>
                <button onclick="bulkUnassignIncome()" class="p-3 text-left rounded-lg border border-slate-200 hover:border-primary hover:bg-slate-50 flex items-center justify-between group">
                    <span class="text-xs font-bold text-slate-600 group-hover:text-slate-800">Desvincular (Link = Null)</span>
                    <span class="material-symbols-outlined text-base text-slate-400">link_off</span>
                </button>
                <button onclick="bulkDelete()" class="p-3 text-left rounded-lg border border-red-200 bg-red-50 hover:bg-red-100 flex items-center justify-between group">
                    <span class="text-xs font-bold text-red-600">Eliminar Seleccionados</span>
                    <span class="material-symbols-outlined text-base text-red-400">delete</span>
                </button>
            </div>

            <div id="bulkSubCategory" class="hidden">
                <button onclick="resetBulkView()" class="mb-2 text-[10px] text-slate-400 hover:text-primary font-bold flex items-center"><span class="material-symbols-outlined text-sm">arrow_back</span> Volver</button>
                <div class="mb-2"><input type="text" id="bulkCatSearch" placeholder="Buscar categoría..." class="w-full text-xs border border-slate-200 rounded p-2"></div>
                <div id="bulkCatList" class="max-h-[200px] overflow-y-auto custom-scrollbar flex flex-col gap-1"></div>
            </div>

            <div id="bulkSubLink" class="hidden">
                <button onclick="resetBulkView()" class="mb-2 text-[10px] text-slate-400 hover:text-primary font-bold flex items-center"><span class="material-symbols-outlined text-sm">arrow_back</span> Volver</button>
                 <div id="bulkLinkList" class="max-h-[200px] overflow-y-auto custom-scrollbar flex flex-col gap-1"></div>
            </div>

        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
        
        const MONTHS = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const PALETTE = ['#0e757c','#558055','#D4A373','#996A5C','#334155','#64748b','#94a3b8','#cbd5e1'];

        const defaultData = { 
            txs: [], 
            cats: { 
                exp:['Esenciales','Deudas','Fitness','Viaje Italia','Inversiones','Proyectos'], 
                inc:['Sueldo Famiq','Honorarios','Rentas','Otros'] 
            }, 
            concepts: {
                'Esenciales': ['Alquiler','Expensas','Supermercado','Luz','Gas','Internet'],
                'Deudas': ['Prestamo 11M','Visa','Mastercard'],
                'Fitness': ['Cuota Gym','Proteína','Creatina','Ropa Deportiva'],
                'Viaje Italia': ['Fondo Ahorro','Pasajes','Alojamiento'],
                'Inversiones': ['Plan 500 USD','CEDEARs','Crypto'],
                'Proyectos': ['ALEJEN Pediátrica','App Finance'],
                'Sueldo Famiq': ['Mensual','Bono'],
                'Honorarios': ['Consultas Dra','Particulares']
            }, 
            recurrentes: [], 
            monthlyRates: {} 
        };

        let appData = JSON.parse(JSON.stringify(defaultData)); 
        let currentDate = new Date(); currentDate.setDate(1);
        let editId=null, cExp=null, cInc=null, drillCat=null;
        
        // --- HISTORY STATE ---
        let historyStack = [];
        let redoStack = [];
        const MAX_HISTORY = 50;

        // --- BULK SELECTION STATE ---
        let isSelectionMode = false;
        let selectedTxIds = new Set();

        const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        window.onload = () => { initApp(); };
        
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z' || e.key === 'Z'))) { e.preventDefault(); redo(); }
        });

        async function initApp() {
            loadLocal();
            updateDateUI(); 
            renderAdminTree();
            updateHistoryUI(); 
            Chart.defaults.font.family = "'Manrope', sans-serif";
            syncIndicator(true); 
            await forceSync();
            syncIndicator(false);
        }

        // --- HISTORY LOGIC ---
        function pushHistory() {
            historyStack.push(JSON.stringify(appData));
            if(historyStack.length > MAX_HISTORY) historyStack.shift();
            redoStack = []; 
            updateHistoryUI();
        }

        function undo() {
            if(historyStack.length === 0) return;
            redoStack.push(JSON.stringify(appData));
            appData = JSON.parse(historyStack.pop());
            isSelectionMode = false; selectedTxIds.clear(); updateSelectionUI(); // Reset selection on undo
            saveData(); updateHistoryUI();
        }

        function redo() {
            if(redoStack.length === 0) return;
            historyStack.push(JSON.stringify(appData));
            appData = JSON.parse(redoStack.pop());
            isSelectionMode = false; selectedTxIds.clear(); updateSelectionUI();
            saveData(); updateHistoryUI();
        }

        function updateHistoryUI() {
            const btnUndo = document.getElementById('btnUndo');
            const btnRedo = document.getElementById('btnRedo');
            if(historyStack.length > 0) btnUndo.classList.remove('btn-disabled'); else btnUndo.classList.add('btn-disabled');
            if(redoStack.length > 0) btnRedo.classList.remove('btn-disabled'); else btnRedo.classList.add('btn-disabled');
        }

        function saveLocal() { localStorage.setItem('financeFlowData_Javi', JSON.stringify(appData)); }
        function loadLocal() {
            const stored = localStorage.getItem('financeFlowData_Javi');
            if(stored) { try { appData = JSON.parse(stored); } catch(e){ } }
            loadMonthData();
        }

        async function forceSync() {
            try { 
                const r = await fetch(API_URL); 
                const cloudData = await r.json(); 
                if(cloudData) {
                    appData.txs = cloudData.txs || [];
                    appData.cats = cloudData.cats || defaultData.cats;
                    appData.concepts = cloudData.concepts || defaultData.concepts; 
                    appData.rates = cloudData.rates || {}; 
                    appData.monthlyRates = cloudData.monthlyRates || appData.rates; 
                    appData.recurrentes = cloudData.recurrentes || [];
                    saveLocal();
                    loadMonthData();
                }
            } catch(e) { console.log("Offline mode"); }
        }
        
        function syncIndicator(isLoading) {
            const btn = document.getElementById('syncIcon');
            if(btn) { if(isLoading) btn.classList.add('animate-spin'); else btn.classList.remove('animate-spin'); }
        }
        
        async function saveData() {
            saveLocal();
            try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(appData) }); } catch(e){}
            loadMonthData(); renderAdminTree();
        }

        function loadMonthData() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            const key = `${y}-${m.toString().padStart(2,'0')}`;
            
            let rates = appData.monthlyRates[key] || { ARS: 1500, COP: 3700, USD: 1 };
            document.getElementById('rate_ARS').value = rates.ARS; 
            document.getElementById('rate_COP').value = rates.COP;
            
            const txs = appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
            
            txs.forEach(t => {
                if (!t.exec && t.origCurr && t.origCurr !== 'ARS') {
                    if (t.origCurr === 'USD') t.amount = t.origAmt * rates.ARS;
                    else if (t.origCurr === 'COP') t.amount = (t.origAmt / rates.COP) * rates.ARS;
                }
            });

            txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
            renderLists(txs); renderCharts(txs); updateKPIs(txs); renderRecurrentesAdmin(); renderAdminTree();
        }

        // --- BULK LOGIC START ---

        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            if(!isSelectionMode) selectedTxIds.clear();
            updateSelectionUI();
            loadMonthData(); // Re-render lists to show/hide checkboxes
        }

        function toggleTxSelected(id) {
            if(selectedTxIds.has(id)) selectedTxIds.delete(id);
            else selectedTxIds.add(id);
            // Re-render only lists to reflect check state
            const txs = getMonthTxs();
            renderLists(txs); 
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const btn = document.getElementById('btnSelectMode');
            const bar = document.getElementById('bulkBar');
            const countEl = document.getElementById('bulkCount');
            
            if(isSelectionMode) {
                btn.classList.add('text-primary'); btn.classList.remove('text-slate-400');
                if(selectedTxIds.size > 0) {
                    bar.classList.remove('hidden');
                    countEl.innerText = `${selectedTxIds.size} seleccionados`;
                } else {
                    bar.classList.add('hidden');
                }
            } else {
                btn.classList.remove('text-primary'); btn.classList.add('text-slate-400');
                bar.classList.add('hidden');
            }
        }

        function getMonthTxs() {
             const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
             return appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m).sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
        }

        function openBulkModal() {
            document.getElementById('bulkModal').classList.remove('hidden');
            resetBulkView();
        }
        function closeBulkModal() { document.getElementById('bulkModal').classList.add('hidden'); }
        
        function resetBulkView() {
            document.getElementById('bulkMainOptions').classList.remove('hidden');
            document.getElementById('bulkSubCategory').classList.add('hidden');
            document.getElementById('bulkSubLink').classList.add('hidden');
        }

        function showBulkSubOption(type) {
            document.getElementById('bulkMainOptions').classList.add('hidden');
            if(type === 'category') {
                document.getElementById('bulkSubCategory').classList.remove('hidden');
                const list = document.getElementById('bulkCatList'); list.innerHTML = '';
                (appData.cats.exp || []).forEach(cat => {
                    const b = document.createElement('button');
                    b.className = "text-left text-xs p-2 hover:bg-slate-50 rounded border border-transparent hover:border-primary";
                    b.innerText = cat;
                    b.onclick = () => bulkApplyCategory(cat);
                    list.appendChild(b);
                });
            }
            if(type === 'link') {
                document.getElementById('bulkSubLink').classList.remove('hidden');
                const list = document.getElementById('bulkLinkList'); list.innerHTML = '';
                const incs = getMonthTxs().filter(t => t.type === 'inc');
                if(incs.length === 0) list.innerHTML = '<span class="text-xs text-slate-400">Sin ingresos este mes</span>';
                incs.forEach(inc => {
                     const b = document.createElement('button');
                    b.className = "text-left text-xs p-2 hover:bg-slate-50 rounded border border-transparent hover:border-primary";
                    b.innerHTML = `<b>${inc.desc}</b> <span class="text-slate-400">($${fmt(inc.amount)})</span>`;
                    b.onclick = () => bulkAssignIncome(inc.id);
                    list.appendChild(b);
                });
            }
        }

        function bulkApplyCategory(cat) {
            pushHistory();
            selectedTxIds.forEach(id => {
                const tx = appData.txs.find(t => t.id === id);
                if(tx && tx.type === 'exp') tx.cat = cat;
            });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }

        function bulkSetExec(val) {
            pushHistory();
            selectedTxIds.forEach(id => {
                const tx = appData.txs.find(t => t.id === id);
                if(tx) tx.exec = val;
            });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }

        function bulkAssignIncome(incomeId) {
            pushHistory();
            selectedTxIds.forEach(id => {
                const tx = appData.txs.find(t => t.id === id);
                if(tx && tx.type === 'exp') tx.linkId = incomeId;
            });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }

        function bulkUnassignIncome() {
             pushHistory();
            selectedTxIds.forEach(id => {
                const tx = appData.txs.find(t => t.id === id);
                if(tx && tx.type === 'exp') tx.linkId = null;
            });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }

        function bulkDelete() {
            if(!confirm(`¿Eliminar ${selectedTxIds.size} elementos?`)) return;
            pushHistory();
            selectedTxIds.forEach(id => {
                const tx = appData.txs.find(t => t.id === id);
                if(tx) tx.deletedAt = Date.now();
            });
            saveData(); toggleSelectionMode(); closeBulkModal();
        }

        // --- END BULK LOGIC ---

        function renderLists(txs) {
            const lI=document.getElementById('list-inc'), lE=document.getElementById('list-exp'), lA=document.getElementById('list-alloc');
            lI.innerHTML=''; lE.innerHTML=''; lA.innerHTML=''; let rb=0;
            
            txs.forEach(t => {
                if(t.type=='inc') rb+=t.amount; else rb-=t.amount;
                
                let currBadge = (t.origCurr && t.origCurr !== 'ARS') ? `<span class="bg-blue-50 text-blue-600 text-[9px] px-1.5 py-0.5 rounded ml-1 font-bold">${t.origAmt} ${t.origCurr}</span>` : '';
                let linkText = '';
                if(t.type=='exp' && t.linkId) { 
                    const source = appData.txs.find(x => x.id == t.linkId); 
                    if(source) linkText = `<span class="inline-flex items-center ml-2 bg-slate-100 text-slate-500 text-[9px] px-1.5 py-0.5 rounded-md"><span class="material-symbols-outlined text-[10px] mr-0.5">link</span>${source.desc.substring(0,8)}</span>`; 
                }

                const el = document.createElement('div');
                
                // BULK EDIT STYLING
                const isSelected = selectedTxIds.has(t.id);
                let baseClass = t.exec ? "opacity-60 bg-slate-50/50 line-through decoration-slate-400" : "bg-white";
                if(isSelectionMode && isSelected) baseClass = "bg-blue-50/50";
                
                el.className = `compact-row group flex items-center justify-between cursor-pointer ${baseClass} ${isSelected ? 'selected' : ''}`;
                
                // CLICK HANDLER: Toggle selection OR Edit
                el.onclick = () => {
                    if(isSelectionMode && t.type === 'exp') toggleTxSelected(t.id);
                    else if(!isSelectionMode) editTx(t.id);
                };
                
                // ICON LOGIC: Checkbox vs Status Icon
                let leftIcon = '';
                if(isSelectionMode && t.type === 'exp') {
                    leftIcon = `<div class="bulk-chk ${isSelected?'checked':''}"><i class="fas fa-check material-symbols-outlined">check</i></div>`;
                } else {
                    leftIcon = t.exec 
                    ? `<span class="material-symbols-outlined text-base text-primary">check_circle</span>`
                    : `<div class="size-4 rounded-full border-2 border-slate-200 group-hover:border-primary transition-colors"></div>`;
                }

                el.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden w-full">
                        <div class="shrink-0 flex items-center justify-center size-6">${leftIcon}</div>
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center justify-between">
                                <p class="text-xs font-bold text-slate-800 truncate leading-tight">${t.desc} ${currBadge} ${linkText}</p>
                                <p class="text-xs font-bold ${t.type=='inc'?'text-success':'text-danger'} ml-2">$${fmt(t.amount)}</p>
                            </div>
                            <div class="flex items-center justify-between mt-1">
                                <div class="flex gap-2">
                                    <span class="text-[9px] text-slate-500 bg-slate-100 px-1.5 rounded">${t.cat || 'Gral'}</span>
                                    <span class="text-[9px] text-slate-400 font-medium">${t.date.split('-')[2]}</span>
                                </div>
                                ${t.type=='exp'?`<span class="text-[9px] font-bold ${rb>=0?'text-emerald-600':'text-rose-600'} opacity-60">Q: $${fmt(rb)}</span>`:''}
                            </div>
                        </div>
                    </div>`;
                (t.type=='inc'?lI:lE).appendChild(el);
            });
            document.getElementById('c-inc').innerText = txs.filter(t=>t.type=='inc').length;
            document.getElementById('c-exp').innerText = txs.filter(t=>t.type=='exp').length;
            
            const searchTerm = document.getElementById('searchExpInput').value;
            if(searchTerm) filterExpList();

            const incs = txs.filter(t=>t.type=='inc');
            incs.forEach(inc => {
                const subs = txs.filter(t=>t.type=='exp' && t.linkId==inc.id);
                const spent = subs.reduce((a,b)=>a+b.amount,0);
                const rem = inc.amount - spent;
                const remClass = rem >= 0 ? 'text-success' : 'text-danger';
                const pct = Math.min(100, (spent/inc.amount)*100);
                let barColor = pct > 90 ? 'bg-danger' : 'bg-primary';
                
                let rows = ''; 
                if (subs.length > 0) {
                    subs.forEach(s => {
                        const day = s.date.split('-')[2];
                        rows += `
                        <div class="flex justify-between py-1.5 text-[10px] border-b border-dashed border-slate-100 cursor-pointer hover:bg-slate-50 px-2 rounded ${s.exec ? 'line-through text-slate-400' : 'text-slate-600'}" onclick="editTx(${s.id})">
                            <span class="truncate pr-2">${s.desc} <span class="text-slate-300 text-[9px] ml-1">d-${day}</span></span>
                            <span class="font-bold shrink-0">$${fmt(s.amount)}</span>
                        </div>`;
                    });
                } else {
                    rows = '<span class="text-[10px] text-slate-300 italic px-2">Sin asignaciones</span>';
                }

                const card = document.createElement('div');
                card.innerHTML = `
                <div class="rounded-xl border border-slate-200 bg-white mb-2 shadow-sm overflow-hidden group">
                    <div class="p-3 bg-slate-50/50 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors">
                        <div onclick="this.closest('.rounded-xl').querySelector('.alloc-details').classList.toggle('hidden')" class="flex-1">
                            <p class="text-[11px] font-bold text-slate-700">${inc.desc}</p>
                            <p class="text-[10px] font-extrabold mt-0.5 ${remClass}">$${fmt(rem)}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[9px] font-bold text-slate-600">${Math.round(pct)}%</span>
                            <button onclick="unassignGroup(${inc.id})" class="text-slate-300 hover:text-red-500 transition-colors" title="Desvincular gastos"><span class="material-symbols-outlined text-sm">link_off</span></button>
                        </div>
                    </div>
                    <div class="w-full h-1 bg-slate-100"><div class="h-full ${barColor} transition-all duration-500" style="width: ${pct}%;"></div></div>
                    <div class="alloc-details hidden bg-white py-1 border-t border-slate-100">${rows}</div>
                </div>`;
                lA.appendChild(card);
            });

            const orphans = txs.filter(t => t.type === 'exp' && !t.linkId);
            if (orphans.length > 0) {
                const totalOrphans = orphans.reduce((a,b) => a+b.amount, 0);
                let orphanRows = '';
                orphans.forEach(s => {
                    const day = s.date.split('-')[2];
                    orphanRows += `
                    <div class="flex justify-between py-1.5 text-[10px] border-b border-dashed border-slate-100 cursor-pointer hover:bg-slate-50 px-2 rounded ${s.exec ? 'line-through text-slate-400' : 'text-slate-600'}" onclick="editTx(${s.id})">
                        <span class="truncate pr-2">${s.desc} <span class="text-slate-300 text-[9px] ml-1">d-${day}</span></span>
                        <span class="font-bold shrink-0">$${fmt(s.amount)}</span>
                    </div>`;
                });

                const orphanCard = document.createElement('div');
                orphanCard.innerHTML = `
                <div class="rounded-xl border border-l-4 border-l-danger border-slate-200 bg-white mb-2 shadow-sm overflow-hidden">
                    <div class="p-3 cursor-pointer hover:bg-slate-50 transition-colors flex justify-between items-center" onclick="this.nextElementSibling.classList.toggle('hidden')">
                         <p class="text-[11px] font-bold text-slate-700">Sin Asignar (${orphans.length})</p>
                         <p class="text-[10px] font-extrabold text-danger">$${fmt(totalOrphans)}</p>
                    </div>
                    <div class="hidden bg-white py-1 border-t border-slate-100">${orphanRows}</div>
                </div>`;
                lA.appendChild(orphanCard);
            } else if (incs.length === 0) {
                lA.innerHTML = '<div class="text-center text-slate-400 text-xs py-8">Sin ingresos registrados</div>';
            }
        }

        function updateKPIs(txs){ 
            const tc=parseFloat(document.getElementById('rate_ARS').value)||1200; 
            const i=txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0); 
            const e=txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0); 
            const bal = i-e;
            document.getElementById('k-inc').innerText='$'+fmt(i); 
            document.getElementById('k-exp').innerText='$'+fmt(e); 
            const balEl = document.getElementById('k-bal');
            balEl.innerText = '$'+fmt(bal);
            balEl.className = `text-2xl font-black tracking-tight ${bal >= 0 ? 'text-emerald-700' : 'text-rose-700'}`;
            document.getElementById('k-usd').innerText='USD '+fmt(bal/tc); 
        }

        function renderAdminTree() {
            const container = document.getElementById('adminTreeContainer'); container.innerHTML = '';
            const buildBranch = (title, type) => {
                const cats = type === 'inc' ? appData.cats.inc : appData.cats.exp;
                const icon = type === 'inc' ? 'trending_up' : 'trending_down';
                const color = type === 'inc' ? 'text-success' : 'text-danger';
                let html = `
                <div class="mb-1">
                    <div class="flex items-center gap-2 mb-1 px-1 mt-1">
                        <span class="material-symbols-outlined text-sm ${color}">${icon}</span>
                        <h4 class="font-bold text-[10px] text-slate-500 uppercase tracking-wide">${title}</h4>
                    </div>
                    <div class="space-y-1">`;
                cats.forEach(c => {
                    const concepts = appData.concepts[c] || [];
                    html += `
                    <details class="group bg-slate-50 rounded-lg border border-slate-100 overflow-hidden open:bg-white open:shadow-sm transition-all">
                        <summary class="flex justify-between items-center p-1.5 cursor-pointer hover:bg-slate-100 transition-colors">
                            <div class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-slate-400 text-base group-open:text-primary transition-colors">folder</span>
                                <span class="text-[11px] font-bold text-slate-700">${c}</span>
                                <span class="text-[9px] text-slate-400 bg-white px-1.5 rounded-full border border-slate-100">${concepts.length}</span>
                            </div>
                            <button onclick="delCat('${type}','${c}')" class="text-slate-300 hover:text-red-500 transition-colors"><span class="material-symbols-outlined text-sm">delete</span></button>
                        </summary>
                        <div class="p-1.5 pt-0 border-t border-slate-100 bg-white">
                            <div class="flex flex-wrap gap-1 mb-1 mt-1">
                                ${concepts.map(con => `
                                    <div class="cat-tag flex items-center gap-1 group/tag">
                                        ${con}
                                        <button onclick="delConcept('${c}','${con}')" class="text-slate-300 hover:text-red-500 hidden group-hover/tag:block"><span class="material-symbols-outlined text-[10px] font-bold">close</span></button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex gap-1">
                                <input type="text" id="newCon_${c}" placeholder="+ Subcat" class="w-full text-[10px] border-none bg-slate-50 rounded px-2 py-0.5 focus:ring-1 focus:ring-primary">
                                <button onclick="manualAddConcept('${c}')" class="text-primary hover:bg-primary/10 rounded px-1"><span class="material-symbols-outlined text-sm">add</span></button>
                            </div>
                        </div>
                    </details>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            };
            buildBranch("Gastos", "exp");
            buildBranch("Ingresos", "inc");
        }

        function openModal(){ editId=null; resetForm(); setType('exp'); document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex'); }
        function closeModal(){ document.getElementById('modalOverlay').classList.add('hidden'); document.getElementById('modalOverlay').classList.remove('flex'); }
        
        function setType(t){
            document.getElementById('fType').value=t;
            const btnExp = document.getElementById('btnExp'); const btnInc = document.getElementById('btnInc');
            if(t === 'exp') {
                btnExp.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-danger border border-slate-100";
                btnInc.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
                document.getElementById('linkRow').classList.remove('hidden');
                renderChips('exp'); renderLinkChips();
                document.getElementById('lblDesc').innerText = "Concepto"; 
            } else {
                btnInc.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-success border border-slate-100";
                btnExp.className = "flex items-center justify-center gap-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
                document.getElementById('linkRow').classList.add('hidden');
                renderChips('inc'); 
                document.getElementById('lblDesc').innerText = "Detalle";
            }
            document.getElementById('fCat').value = ''; document.getElementById('conceptBox').innerHTML = '';
        }

        function renderChips(type) {
            const container = document.getElementById('chipBox'); container.innerHTML = '';
            const cats = type === 'inc' ? (appData.cats.inc || []) : (appData.cats.exp || []);
            cats.forEach(c => {
                const chip = document.createElement('div');
                chip.className = `chip px-3 py-1 cursor-pointer select-none ${document.getElementById('fCat').value === c ? 'active' : ''}`;
                chip.innerText = c;
                chip.onclick = () => {
                    document.getElementById('fCat').value = c;
                    document.querySelectorAll('#chipBox .chip').forEach(x => x.classList.remove('active'));
                    chip.classList.add('active');
                    renderConcepts(c);
                };
                container.appendChild(chip);
            });
        }
        function renderConcepts(catKey) {
            const box = document.getElementById('conceptBox'); box.innerHTML = '';
            const list = appData.concepts[catKey] || [];
            list.forEach(c => {
                const el = document.createElement('div'); el.className = 'cat-tag px-2 py-1 text-xs cursor-pointer'; el.innerText = c;
                el.onclick = () => { document.getElementById('fDesc').value = c; };
                box.appendChild(el);
            });
        }
        function renderLinkChips(selectedId){const container = document.getElementById('linkChipsContainer'); container.innerHTML = '';const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;const incs = appData.txs.filter(t=>!t.deletedAt && t.type=='inc' && parseInt(t.date.split('-')[1])==m);if(incs.length === 0) { container.innerHTML = '<span class="text-[10px] text-slate-400 italic">No hay ingresos este mes</span>'; return; }incs.forEach(i => {const sp=appData.txs.filter(x=>!x.deletedAt && x.type=='exp' && x.linkId==i.id && x.id!=editId).reduce((a,b)=>a+b.amount,0);const bal = i.amount - sp;if(bal < 1 && i.id != selectedId) return; const chip = document.createElement('div');chip.className = `chip px-2 py-1 rounded cursor-pointer select-none text-[10px] ${selectedId == i.id ? 'active' : ''}`;chip.innerHTML = `<b>${i.desc}</b> <span class="opacity-70">($${fmt(bal)})</span>`;chip.onclick = () => {document.getElementById('fLink').value = i.id;document.querySelectorAll('#linkChipsContainer .chip').forEach(x => x.classList.remove('active'));chip.classList.add('active');};container.appendChild(chip);});}

        function calcConversion() {
            const amt = parseFloat(document.getElementById('fAmt').value) || 0;
            const curr = document.getElementById('fCurr').value;
            const rateARS = parseFloat(document.getElementById('rate_ARS').value) || 1200;
            let final = amt;
            if (curr === 'USD') final = amt * rateARS;
            if (curr === 'COP') final = (amt / parseFloat(document.getElementById('rate_COP').value)) * rateARS;
            document.getElementById('convResult').innerText = `$${fmt(final)} ARS`;
            document.getElementById('convPreview').classList.toggle('hidden', curr === 'ARS');
            return final;
        }

        document.getElementById('txForm').onsubmit=e=>{
            e.preventDefault();
            let cat=document.getElementById('fCat').value;
            const type = document.getElementById('fType').value;
            if(!cat) return alert('Selecciona categoría');
            const desc=document.getElementById('fDesc').value;
            pushHistory();
            if(cat) { if(!appData.concepts[cat]) appData.concepts[cat] = []; if(!appData.concepts[cat].includes(desc)) appData.concepts[cat].push(desc); }
            const tx={
                id:editId||Date.now(), date:document.getElementById('fDate').value,
                amount: calcConversion(), 
                origAmt: parseFloat(document.getElementById('fAmt').value), 
                origCurr: document.getElementById('fCurr').value,
                type, cat, desc, 
                exec:document.getElementById('fExec').checked,
                linkId:type=='exp'?document.getElementById('fLink').value:null, deletedAt:null
            };
            if(editId){ const i=appData.txs.findIndex(x=>x.id==editId); appData.txs[i]=tx; } else appData.txs.push(tx);
            saveData(); closeModal();
        }

        function editTx(id){const t=appData.txs.find(x=>x.id==id); if(!t)return; editId=id;document.getElementById('mTitle').innerText='Editar'; document.getElementById('btnDel').classList.remove('hidden');document.getElementById('fDate').value=t.date; document.getElementById('fDesc').value=t.desc; document.getElementById('fExec').checked=t.exec;document.getElementById('fAmt').value = t.origAmt || t.amount; document.getElementById('fCurr').value = t.origCurr || 'ARS';setType(t.type); setTimeout(() => {document.getElementById('fCat').value = t.cat;renderChips(t.type); if(t.type === 'exp') { document.getElementById('fLink').value = t.linkId || ""; renderLinkChips(t.linkId);}renderConcepts(t.cat);}, 50);calcConversion();document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex');}
        function resetForm(){ document.getElementById('txForm').reset(); document.getElementById('mTitle').innerText='Nuevo'; document.getElementById('btnDel').classList.add('hidden'); document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; document.getElementById('convPreview').classList.add('hidden'); editId=null; }
        function delTx(){ if(confirm('Eliminar?')){ pushHistory(); appData.txs.find(x=>x.id==editId).deletedAt=Date.now(); saveData(); closeModal(); }}
        
        function renderCharts(txs) {
            renderDoughnut(document.getElementById('chartExp'), document.getElementById('legExp'), txs.filter(t=>t.type=='exp'), 'cat', true, cExp, i=>cExp=i);
            renderDoughnut(document.getElementById('chartInc'), document.getElementById('legInc'), txs.filter(t=>t.type=='inc'), 'desc', false, cInc, i=>cInc=i);
        }

        function renderDoughnut(cvs, leg, data, key, drill, inst, setInst) {
            if(inst) inst.destroy();
            let map={}; if(drill && drillCat) { document.getElementById('resetBtn').classList.remove('hidden'); data.filter(t=>t.cat==drillCat).forEach(t=>map[t.desc]=(map[t.desc]||0)+t.amount); } else { if(drill) document.getElementById('resetBtn').classList.add('hidden'); data.forEach(t=>{ const k = t[key] || 'General'; map[k]=(map[k]||0)+t.amount; }); }
            const ent = Object.entries(map).sort((a,b)=>b[1]-a[1]); const tot = ent.reduce((a,b)=>a+b[1],0);
            setInst(new Chart(cvs, { type:'doughnut', data:{ labels:ent.map(e=>e[0]), datasets:[{data:ent.map(e=>e[1]), backgroundColor:PALETTE, borderWidth:0, hoverOffset:2}] }, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{display:false}}, onClick:(e,el)=>{if(drill&&!drillCat&&el.length){drillCat=ent[el[0].index][0]; loadMonthData();}} } }));
            leg.innerHTML = ''; ent.forEach((e,i) => { const pct = Math.round((e[1]/tot)*100); leg.innerHTML += `<div class="flex items-center justify-between text-[10px] py-1.5 border-b border-dashed border-slate-100 cursor-pointer hover:bg-slate-50 px-1 rounded" onclick="${drill&&!drillCat?`drillCat='${e[0]}';loadMonthData()`:''}"><div class="flex items-center gap-1.5 min-w-0"><span class="size-2 rounded-full shrink-0" style="background:${PALETTE[i%PALETTE.length]}"></span><span class="text-slate-600 font-medium truncate">${e[0]}</span></div><div class="flex items-center gap-2 shrink-0"><span class="text-slate-400">${pct}%</span><span class="font-bold text-slate-800">$${fmt(e[1])}</span></div></div>`; });
        }

        function resetCharts() { drillCat=null; loadMonthData(); }
        function manualAddCat() { const n = document.getElementById('newCatName').value.trim(); const t = document.getElementById('newCatType').value; if(!n) return alert('Nombre?'); pushHistory(); if(t === 'exp') { if(!appData.cats.exp.includes(n)) appData.cats.exp.push(n); } else { if(!appData.cats.inc.includes(n)) appData.cats.inc.push(n); } if(!appData.concepts[n]) appData.concepts[n] = []; document.getElementById('newCatName').value = ''; saveData(); }
        function manualAddConcept(catName) { const input = document.getElementById(`newCon_${catName}`); const val = input.value.trim(); if(!val) return; pushHistory(); if(!appData.concepts[catName]) appData.concepts[catName] = []; if(!appData.concepts[catName].includes(val)) appData.concepts[catName].push(val); saveData(); }
        function delCat(type, name) { if(confirm(`¿Eliminar ${name}?`)) { pushHistory(); if(type === 'exp') appData.cats.exp = appData.cats.exp.filter(x => x !== name); else appData.cats.inc = appData.cats.inc.filter(x => x !== name); delete appData.concepts[name]; saveData(); } }
        function delConcept(cat, name) { if(confirm(`¿Eliminar ${name}?`)) { pushHistory(); appData.concepts[cat] = appData.concepts[cat].filter(x => x !== name); saveData(); } }
        function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); updateDateUI(); loadMonthData(); }
        function manualDate(){ const[y,m]=document.getElementById('datePicker').value.split('-'); currentDate.setFullYear(y); currentDate.setMonth(m-1); updateDateUI(); loadMonthData(); }
        function updateDateUI(){ document.getElementById('monthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }
        function saveMonthlyRates() { const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1; appData.monthlyRates[`${y}-${m.toString().padStart(2,'0')}`] = { ARS: parseFloat(document.getElementById('rate_ARS').value), COP: parseFloat(document.getElementById('rate_COP').value), USD: 1 }; saveData(); }
        function renderRecurrentesAdmin() { const b=document.getElementById('recurrente-table-body'); b.innerHTML=''; appData.recurrentes.forEach((r,i)=>{const d=document.createElement('div'); d.className='flex gap-2 items-center text-xs border-b border-slate-200 py-1 last:border-0'; d.innerHTML=`<input value="${r.desc}" onchange="pushHistory();appData.recurrentes[${i}].desc=this.value" class="w-1/3 border-slate-200 rounded px-1 py-0.5"><input type="number" value="${r.amount}" onchange="pushHistory();appData.recurrentes[${i}].amount=parseFloat(this.value)" class="w-1/4 border-slate-200 rounded px-1 py-0.5 text-right"><span class="text-slate-400 text-[10px] w-1/4">${r.cat}</span><button onclick="deleteRecurrente(${i})" class="text-red-400 hover:text-red-600 font-bold px-2">x</button>`; b.appendChild(d);}); }
        function deleteRecurrente(i) { pushHistory(); appData.recurrentes.splice(i,1); saveData(); }
        function addRecurrenteRow() { pushHistory(); appData.recurrentes.push({desc:'Nuevo', amount:0, cat:'Esenciales', type:'exp'}); renderRecurrentesAdmin(); }
        function saveRecurrentesConfig() { saveData(); alert('Guardado'); }
        function executeRecurrentes() { const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; let c=0; appData.recurrentes.forEach(r=>{ if(!appData.txs.some(t=>!t.deletedAt && t.desc==r.desc && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m)){ appData.txs.push({...r, id:Date.now()+Math.random(), date:`${y}-${m.toString().padStart(2,'0')}-01`, exec:false, linkId:null, deletedAt:null, origAmt:r.amount, origCurr:'ARS'}); c++; }}); if(c>0){ pushHistory(); saveData(); alert('Generados: '+c);} else alert('Ya estaban cargados'); }
        function clearMonth(){ if(confirm('Borrar MES actual?')){ pushHistory(); const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; appData.txs.forEach(t=>{if(parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m) t.deletedAt=Date.now();}); saveData(); }}
        function cloneMonth() { const s=document.getElementById('cloneSrc').value; if(!s)return alert('Mes origen?'); if(!confirm('Copiar?')){return;} const [sy,sm]=s.split('-').map(Number); const src=appData.txs.filter(t=>!t.deletedAt && parseInt(t.date.split('-')[0])==sy && parseInt(t.date.split('-')[1])==sm); const tgt=document.getElementById('datePicker').value+'-01'; let map={}, n=[]; src.filter(t=>t.type=='inc').forEach(t=>{const id=Date.now()+Math.random(); map[t.id]=id; n.push({...t,id,date:tgt,exec:false});}); src.filter(t=>t.type=='exp').forEach(t=>{const id=Date.now()+Math.random(); n.push({...t,id,date:tgt,exec:false,linkId:t.linkId?map[t.linkId]:null});}); pushHistory(); appData.txs.push(...n); saveData(); }
        function autoAssign() {
            if(!confirm("¿Asignar automáticamente según fecha y saldo disponible?")) return;
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            const currentMonthTxs = appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
            let incomes = currentMonthTxs.filter(t => t.type === 'inc').map(i => {
                const assigned = currentMonthTxs.filter(e => e.type === 'exp' && e.linkId == i.id).reduce((a,b)=>a+b.amount,0);
                return { ...i, balance: i.amount - assigned };
            });
            const unassignedExps = currentMonthTxs.filter(t => t.type === 'exp' && !t.linkId);
            let count = 0; let changesMade = false;
            unassignedExps.forEach(exp => {
                const validIncome = incomes.find(inc => inc.date <= exp.date && inc.balance >= exp.amount);
                if(validIncome) {
                    if(!changesMade) { pushHistory(); changesMade = true; }
                    exp.linkId = validIncome.id;
                    validIncome.balance -= exp.amount; 
                    count++;
                }
            });
            if(count > 0) { alert(`Asignados: ${count} gastos.`); saveData(); } else { alert("No se encontraron coincidencias válidas."); }
        }
        function unassignAll() {
            if(!confirm("¿Desvincular TODOS los gastos de este mes?")) return;
            pushHistory(); const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            appData.txs.forEach(t => { if(!t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m && t.type === 'exp') { t.linkId = null; }});
            saveData();
        }
        function unassignGroup(incId) {
            if(!confirm("¿Desvincular gastos de este ingreso?")) return;
            pushHistory(); appData.txs.forEach(t => { if(t.type === 'exp' && t.linkId == incId) t.linkId = null; });
            saveData();
        }
        function populateRecurringDefaults() {
            if(!confirm("¿Analizar historial (3 meses) y sugerir?")) return;
            const limitDate = new Date(); limitDate.setDate(limitDate.getDate() - 90);
            const recent = appData.txs.filter(t => !t.deletedAt && t.type === 'exp' && new Date(t.date) >= limitDate);
            const analysis = {};
            recent.forEach(t => { const d = t.desc.trim(); if(!analysis[d]) analysis[d] = { count: 0, lastAmt: 0, cat: t.cat, dates: new Set() }; analysis[d].count++; analysis[d].lastAmt = t.origAmt || t.amount; analysis[d].cat = t.cat; analysis[d].dates.add(t.date.substring(0, 7)); });
            let added = 0; let changesMade = false;
            Object.entries(analysis).forEach(([desc, data]) => {
                if((data.dates.size >= 2 || data.count >= 2) && !appData.recurrentes.some(r => r.desc.toLowerCase() === desc.toLowerCase())) {
                    if(!changesMade) { pushHistory(); changesMade = true; }
                    appData.recurrentes.push({ desc: desc, amount: data.lastAmt, cat: data.cat, type: 'exp' });
                    added++;
                }
            });
            if(added === 0) alert("No se encontraron nuevos patrones."); else alert(`Agregadas ${added} sugerencias.`);
            renderRecurrentesAdmin(); saveData();
        }
        function nav(v, el){ document.querySelectorAll('.view-container').forEach(e=>e.classList.add('hidden-view')); document.getElementById(`view-${v}`).classList.remove('hidden-view'); document.querySelectorAll('#main-nav button').forEach(e=>{ e.classList.remove('active-nav'); e.classList.add('text-slate-500'); }); if(el) { el.classList.add('active-nav'); el.classList.remove('text-slate-500'); } }
        function filterExpList() {
            const term = document.getElementById('searchExpInput').value.toLowerCase();
            const container = document.getElementById('list-exp');
            const rows = container.getElementsByClassName('compact-row');
            Array.from(rows).forEach(row => {
                const text = row.innerText.toLowerCase();
                if(text.includes(term)) { row.classList.remove('hidden'); row.classList.add('flex'); } else { row.classList.add('hidden'); row.classList.remove('flex'); }
            });
        }
    </script>
</body>
</html>
