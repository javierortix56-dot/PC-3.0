<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FinanceFlow PRO | Javi</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#0e757c", "primary-dark": "#085055", "success": "#558055", "danger": "#b91c1c", "warning": "#D4A373" },
                    fontFamily: { "display": ["Manrope", "sans-serif"], "body": ["Inter", "sans-serif"] }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Manrope', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .hidden-view { display: none !important; }
        .active-nav { background-color: rgba(14, 117, 124, 0.1); color: #0e757c; border-right: 3px solid #0e757c; }
        .d-picker { position: absolute; inset:0; opacity:0; cursor: pointer; width: 100%; }
        .compact-row { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        /* Chips Styles */
        .chip { transition: all 0.2s; border: 1px solid #e2e8f0; background: white; color: #64748b; }
        .chip:hover { border-color: #0e757c; color: #0e757c; }
        .chip.active { background: #0e757c; color: white; border-color: #0e757c; font-weight: 600; box-shadow: 0 2px 4px rgba(14, 117, 124, 0.2); }
        .chip-concept { font-size: 10px; padding: 2px 8px; background: #f1f5f9; border-radius: 4px; cursor: pointer; }
        .chip-concept.active { background: #0e757c; color: white; }
    </style>
</head>

<body class="bg-[#f0f2f2] text-slate-900 h-screen flex overflow-hidden selection:bg-primary/20">

    <aside class="w-16 hover:w-60 transition-all duration-300 group fixed h-screen z-40 flex flex-col justify-between py-4 bg-white shadow-xl border-r border-slate-200">
        <div class="flex flex-col gap-6">
            <div class="flex items-center justify-center h-10 group-hover:justify-start group-hover:px-4 transition-all">
                <div class="bg-primary size-9 rounded-xl flex items-center justify-center text-white shrink-0 shadow-md">
                    <span class="material-symbols-outlined text-xl">account_balance_wallet</span>
                </div>
                <h1 class="font-bold text-lg text-primary ml-3 opacity-0 group-hover:opacity-100 transition-opacity overflow-hidden whitespace-nowrap">FinanceFlow</h1>
            </div>
            
            <nav class="flex flex-col gap-1 px-2" id="main-nav">
                <button onclick="nav('dashboard', this)" id="nav-dashboard" class="active-nav flex items-center h-11 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">dashboard</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Operaciones</span>
                </button>
                <button onclick="nav('analytics', this)" class="flex items-center h-11 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">pie_chart</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Análisis</span>
                </button>
                <button onclick="nav('strategy', this)" class="flex items-center h-11 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">monitoring</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Estrategia</span>
                </button>
                <button onclick="nav('admin', this)" class="flex items-center h-11 rounded-lg px-2 text-slate-500 hover:bg-slate-100 transition-colors w-full overflow-hidden">
                    <span class="material-symbols-outlined text-xl shrink-0">settings</span>
                    <span class="ml-3 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Ajustes</span>
                </button>
            </nav>
        </div>
        
        <div class="px-2">
            <button onclick="openModal()" class="flex items-center justify-center w-full h-11 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-lg transition-all group-hover:justify-start group-hover:px-3 mb-4 overflow-hidden">
                <span class="material-symbols-outlined text-xl">add</span>
                <span class="ml-3 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Nuevo</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 ml-16 p-5 lg:p-8 h-screen overflow-hidden flex flex-col relative">
        
        <header class="flex justify-between items-center mb-6 shrink-0">
            <div class="flex flex-col">
                <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight" id="pageTitle">Panel de Control</h2>
                <div class="flex items-center gap-2 text-slate-500 relative cursor-pointer hover:text-primary transition-colors mt-1">
                    <button onclick="changeMonth(-1)" class="hover:bg-slate-200 rounded p-1"><span class="material-symbols-outlined text-base">chevron_left</span></button>
                    <div class="relative">
                        <span class="text-sm font-bold uppercase tracking-wide flex items-center gap-1">
                            <span class="material-symbols-outlined text-base">calendar_today</span>
                            <span id="monthTxt">...</span>
                        </span>
                        <input type="month" id="datePicker" class="d-picker" onchange="manualDate()">
                    </div>
                    <button onclick="changeMonth(1)" class="hover:bg-slate-200 rounded p-1"><span class="material-symbols-outlined text-base">chevron_right</span></button>
                </div>
            </div>

            <div class="flex items-center bg-white border border-slate-200 rounded-lg shadow-sm h-11 overflow-hidden">
                <div class="flex items-center gap-2 px-4 bg-slate-50 h-full border-r border-slate-100 text-slate-500">
                    <span class="material-symbols-outlined text-lg">currency_exchange</span>
                    <span class="text-xs font-bold uppercase">USD TC</span>
                </div>
                <div class="flex items-center px-3 h-full gap-1">
                    <span class="text-lg font-bold text-slate-800">$</span>
                    <input type="number" id="headerRateDisplay" value="1200" onchange="updateHeaderRate()" class="w-16 bg-transparent text-lg font-bold text-primary focus:outline-none border-none p-0">
                </div>
            </div>
        </header>

        <section class="grid grid-cols-4 gap-4 mb-6 shrink-0">
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center h-24">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Balance (ARS)</p>
                <h3 class="text-2xl font-extrabold text-slate-800" id="k-bal">$0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center h-24">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Estimado USD</p>
                <h3 class="text-2xl font-extrabold text-primary" id="k-usd">$0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center h-24">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Ingresos</p>
                <h3 class="text-2xl font-extrabold text-success" id="k-inc">$0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-center h-24">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Gastos</p>
                <h3 class="text-2xl font-extrabold text-danger" id="k-exp">$0</h3>
            </div>
        </section>

        <div id="view-dashboard" class="view-container grid grid-cols-1 xl:grid-cols-3 gap-6 flex-1 min-h-0">
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-4 py-3 border-b bg-slate-50/50 flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-2"><span class="material-symbols-outlined text-base text-success">arrow_circle_up</span>Ingresos</span>
                    <span class="bg-success/10 text-success text-[10px] font-bold px-2 py-0.5 rounded-full" id="c-inc">0</span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2" id="list-inc"></div>
            </section>
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-4 py-3 border-b bg-slate-50/50 flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-2"><span class="material-symbols-outlined text-base text-danger">arrow_circle_down</span>Gastos</span>
                    <span class="bg-danger/10 text-danger text-[10px] font-bold px-2 py-0.5 rounded-full" id="c-exp">0</span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2" id="list-exp"></div>
            </section>
            <section class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                <div class="px-4 py-3 border-b bg-slate-50/50 flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-2"><span class="material-symbols-outlined text-base text-primary">pie_chart</span>Asignación</span>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3" id="list-alloc"></div>
            </section>
        </div>

        <div id="view-analytics" class="view-container hidden-view grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-600 uppercase">Gastos por Categoría</h3>
                    <button onclick="resetCharts()" class="text-[10px] text-primary font-bold hover:underline" id="resetBtn" style="display:none">VOLVER ATRÁS</button>
                </div>
                <div class="flex items-center gap-6 flex-1 overflow-hidden">
                    <div class="relative h-[220px] w-[220px] shrink-0"><canvas id="chartExp"></canvas></div>
                    <div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-2" id="legExp"></div>
                </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm flex flex-col h-full">
                <div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-slate-600 uppercase">Ingresos por Concepto</h3></div>
                <div class="flex items-center gap-6 flex-1 overflow-hidden">
                    <div class="relative h-[220px] w-[220px] shrink-0"><canvas id="chartInc"></canvas></div>
                    <div class="flex-1 h-full overflow-y-auto custom-scrollbar pr-2" id="legInc"></div>
                </div>
            </div>
        </div>

        <div id="view-strategy" class="view-container hidden-view grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm flex flex-col">
                <h3 class="text-sm font-bold text-slate-600 uppercase mb-4">Financial Twin</h3>
                <div class="flex-1 relative flex justify-center items-center"><canvas id="chartRadar" style="max-height: 300px;"></canvas></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-bold text-slate-600 uppercase">Portafolio</h3>
                    <span class="bg-primary/10 text-primary text-xs font-bold px-3 py-1 rounded-full">Total: $0 USD</span>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                    <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">hub</span>
                    <p class="text-xs text-slate-400">Conectividad API próximamente</p>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-container hidden-view grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 min-h-0">
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-6 flex flex-col h-full overflow-hidden">
                <h3 class="text-sm font-bold text-slate-800 uppercase mb-4">Tasas del Mes (Base 1 USD)</h3>
                <div class="space-y-4 overflow-y-auto custom-scrollbar pr-2 flex-1">
                    <div class="flex justify-between items-center p-2 hover:bg-slate-50 rounded">
                        <span class="text-sm font-bold text-slate-600">ARS (Peso)</span>
                        <input type="number" id="rate_ARS" onchange="saveMonthlyRates()" class="w-24 text-right text-sm border-slate-300 rounded focus:ring-primary">
                    </div>
                    <div class="flex justify-between items-center p-2 hover:bg-slate-50 rounded">
                        <span class="text-sm font-bold text-slate-600">COP (Col)</span>
                        <input type="number" id="rate_COP" step="0.01" onchange="saveMonthlyRates()" class="w-24 text-right text-sm border-slate-300 rounded focus:ring-primary">
                    </div>
                </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-6 flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-800 uppercase">Plantillas Recurrentes</h3>
                    <button onclick="addRecurrenteRow()" class="text-primary text-xs font-bold hover:underline">+ Agregar</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar space-y-2" id="recurrente-table-body"></div>
                <div class="mt-4 pt-4 border-t border-slate-100 flex gap-2">
                    <button onclick="saveRecurrentesConfig()" class="flex-1 bg-slate-100 py-2 rounded text-xs font-bold">Guardar</button>
                    <button onclick="executeRecurrentes()" class="flex-1 bg-slate-800 text-white py-2 rounded text-xs font-bold">Ejecutar</button>
                </div>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative z-10 w-full max-w-[450px] bg-white rounded-2xl shadow-2xl flex flex-col animate-fade-in mx-4 overflow-hidden max-h-[95vh]">
            <div class="px-6 pt-5 pb-3 flex justify-between items-center border-b border-slate-100 bg-slate-50">
                <h1 class="text-lg font-bold text-slate-800" id="mTitle">Editar</h1>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><span class="material-symbols-outlined">close</span></button>
            </div>
            
            <form id="txForm" class="p-6 flex flex-col gap-4 overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-2 p-1 bg-slate-100 rounded-lg">
                    <button type="button" id="btnExp" onclick="setType('exp')" class="py-2 text-xs font-bold rounded-md transition-all">Gasto</button>
                    <button type="button" id="btnInc" onclick="setType('inc')" class="py-2 text-xs font-bold rounded-md transition-all">Ingreso</button>
                </div>
                <input type="hidden" id="fType" value="exp">

                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Monto</label>
                        <input type="number" id="fAmt" step="0.01" class="w-full pl-3 pr-2 py-2 bg-white border border-slate-300 rounded-lg text-lg font-bold text-right" placeholder="0" required oninput="calcConversion()">
                    </div>
                    <div class="w-24">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Divisa</label>
                        <select id="fCurr" onchange="calcConversion()" class="w-full py-2.5 bg-white border border-slate-300 rounded-lg text-xs font-bold">
                            <option value="ARS">ARS</option>
                            <option value="USD">USD</option>
                            <option value="COP">COP</option>
                        </select>
                    </div>
                </div>
                <div id="convPreview" class="hidden text-right text-[10px] text-slate-500 font-bold -mt-2">
                    Equivale a: <span id="convResult" class="text-slate-800">$0 ARS</span>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Fecha</label>
                    <input type="date" id="fDate" class="w-full py-2 bg-white border border-slate-300 rounded-lg text-xs" required>
                </div>

                <div id="catRow">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Categoría</label>
                    <div class="flex flex-wrap gap-2" id="catChipsContainer"></div>
                    <input type="hidden" id="fCat">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Concepto / Subcategoría</label>
                    <input type="text" id="fDesc" class="w-full py-2 bg-white border border-slate-300 rounded-lg text-sm mb-2" placeholder="Escribe..." required>
                    <div class="flex flex-wrap gap-1.5" id="conceptChipsContainer"></div>
                </div>
                
                <div id="linkRow">
                    <label class="block text-[10px] font-bold text-primary uppercase mb-1">Pagar con (Fuente)</label>
                    <select id="fLink" class="w-full py-2 bg-white border border-slate-300 rounded-lg text-xs"></select>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="fExec" class="text-primary rounded border-slate-300">
                    <label for="fExec" class="text-xs font-bold text-slate-700">Marcar como ejecutado</label>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="submit" class="flex-1 py-3 bg-slate-900 text-white rounded-lg text-sm font-bold hover:bg-slate-800">GUARDAR</button>
                    <button type="button" id="btnDel" onclick="delTx()" class="hidden px-4 py-3 bg-red-50 text-red-600 rounded-lg text-sm font-bold">BORRAR</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
        const MONTHS = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const PALETTE = ['#0e757c','#558055','#D4A373','#996A5C','#334155','#64748b'];
        
        let appData = { 
            txs: [], 
            cats: { exp:['Esenciales','Deudas','Personal','Ahorro','Inversiones','Imprevistos'], inc:['Sueldo','Venta','Otros'] }, 
            concepts: {
                'Esenciales': ['Luz','Gas','Internet','Alquiler','Expensas','Supermercado'],
                'Deudas': ['Visa','Master','Prestamo'],
                'Personal': ['Gimnasio','Salidas','Ropa','Uber'],
                'Ahorro': ['Dolar MEP','FCI'],
                'Ingresos': ['Sueldo Famiq','Ventas']
            },
            recurrentes: [], 
            monthlyRates: {} 
        };
        
        let currentDate = new Date(); currentDate.setDate(1);
        let editId=null, cExp=null, cInc=null, cRadar=null, drillCat=null;
        const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        window.onload = () => { updateDateUI(); forceSync(); Chart.defaults.font.family = "'Inter', sans-serif"; };

        async function forceSync() {
            try { 
                const r = await fetch(API_URL); 
                const data = await r.json();
                appData.txs = data.txs || [];
                appData.recurrentes = data.recurrentes || [];
                appData.monthlyRates = data.monthlyRates || {};
                loadMonthData(); 
            } catch(e){ console.error(e); }
        }
        
        async function saveData() {
            try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(appData) }); loadMonthData(); } catch(e){ alert('Error guardando'); }
        }

        function loadMonthData() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth() + 1;
            const key = `${y}-${m.toString().padStart(2,'0')}`;
            
            let rates = appData.monthlyRates[key] || { ARS: 1200, COP: 4200, USD: 1 };
            document.getElementById('headerRateDisplay').value = rates.ARS;
            document.getElementById('rate_ARS').value = rates.ARS;
            document.getElementById('rate_COP').value = rates.COP;

            const txs = appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
            txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
            
            renderLists(txs); 
            renderCharts(txs); 
            updateKPIs(txs);
            renderRecurrentesAdmin();
        }

        function renderLists(txs) {
            const lI=document.getElementById('list-inc'), lE=document.getElementById('list-exp'), lA=document.getElementById('list-alloc');
            lI.innerHTML=''; lE.innerHTML=''; lA.innerHTML=''; let rb=0;

            txs.forEach(t => {
                if(t.type=='inc') rb+=t.amount; else rb-=t.amount;
                let currBadge = (t.origCurr && t.origCurr !== 'ARS') ? `<span class="bg-blue-50 text-blue-600 text-[9px] px-1 rounded ml-1 font-bold">${t.origAmt} ${t.origCurr}</span>` : '';
                
                const el = document.createElement('div');
                el.className = `compact-row flex items-center justify-between px-2 hover:bg-slate-50 cursor-pointer border-b border-dashed border-slate-100 last:border-0 ${t.exec ? "opacity-50 grayscale" : ""}`;
                el.onclick = () => editTx(t.id);
                
                el.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="size-6 rounded bg-slate-50 flex items-center justify-center shrink-0 border border-slate-100">
                            <span class="material-symbols-outlined text-xs ${t.type=='inc'?'text-success':'text-danger'}">circle</span>
                        </div>
                        <div class="min-w-0">
                            <div class="flex items-center"><p class="text-xs font-bold text-slate-700 truncate ${t.exec ? "line-through" : ""}">${t.desc}</p>${currBadge}</div>
                            <div class="flex items-center gap-2 mt-0.5"><span class="text-[9px] text-slate-400 bg-slate-50 px-1 rounded border">${t.cat}</span><span class="text-[9px] text-slate-400">${t.date.split('-')[2]}</span></div>
                        </div>
                    </div>
                    <div class="text-right shrink-0 ml-2"><p class="text-xs font-bold ${t.type=='inc'?'text-success':'text-danger'} ${t.exec ? "line-through" : ""}">$${fmt(t.amount)}</p></div>`;
                (t.type=='inc'?lI:lE).appendChild(el);
            });
            document.getElementById('c-inc').innerText = txs.filter(t=>t.type=='inc').length;
            document.getElementById('c-exp').innerText = txs.filter(t=>t.type=='exp').length;

            const incs = txs.filter(t=>t.type=='inc');
            if(!incs.length) lA.innerHTML = '<div class="text-center text-slate-400 text-xs py-4">Sin ingresos</div>';
            incs.forEach(inc => {
                const subs = txs.filter(t=>t.type=='exp' && t.linkId==inc.id);
                const spent = subs.reduce((a,b)=>a+b.amount,0);
                const pct = Math.min(100, (spent/inc.amount)*100);
                let rows = ''; subs.forEach(s => rows += `<div class="flex justify-between py-1 text-[10px] text-slate-500 border-b border-dashed border-slate-100"><span>${s.desc}</span><span>$${fmt(s.amount)}</span></div>`);
                const card = document.createElement('div');
                card.innerHTML = `<div class="rounded-lg border border-slate-100 bg-white mb-2 overflow-hidden"><div class="p-2 bg-slate-50/50 flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.nextElementSibling.classList.toggle('hidden')"><div><p class="text-xs font-bold text-slate-700">${inc.desc}</p><p class="text-[9px] text-slate-500">$${fmt(spent)} / $${fmt(inc.amount)}</p></div><span class="text-[9px] font-bold text-slate-600">${Math.round(pct)}%</span></div><div class="w-full h-1 bg-slate-100"><div class="h-full bg-primary" style="width: ${pct}%;"></div></div><div class="hidden bg-white p-2 border-t">${rows || '<span class="text-[9px] italic">Sin gastos</span>'}</div></div>`;
                lA.appendChild(card);
            });
        }

        // --- CHARTS WITH DRILL DOWN ---
        function renderCharts(txs) {
            renderDoughnut(document.getElementById('chartExp'), document.getElementById('legExp'), txs.filter(t=>t.type=='exp'), 'cat', cExp, i=>cExp=i, true);
            renderDoughnut(document.getElementById('chartInc'), document.getElementById('legInc'), txs.filter(t=>t.type=='inc'), 'desc', cInc, i=>cInc=i, false);
            
            if(cRadar) cRadar.destroy();
            const totalInc = txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0) || 1;
            const savings = txs.filter(t=>t.cat=='Ahorro').reduce((a,b)=>a+b.amount,0);
            const fixed = txs.filter(t=>t.cat=='Esenciales').reduce((a,b)=>a+b.amount,0);
            cRadar = new Chart(document.getElementById('chartRadar'), {
                type: 'radar',
                data: { labels: ['Ahorro', 'Fijos', 'Ocio', 'Inversión', 'Ejecución'], datasets: [{ label: 'Real', data: [Math.min(100, (savings/totalInc)*100), Math.min(100, (fixed/totalInc)*100), 30, 20, 85], fill: true, backgroundColor: 'rgba(14, 117, 124, 0.2)', borderColor: '#0e757c' }] },
                options: { scales: { r: { min: 0, max: 100, ticks: { display: false } } }, plugins: { legend: { display:false } } }
            });
        }

        function renderDoughnut(cvs, leg, data, key, inst, setInst, isDrill) {
            if(inst) inst.destroy();
            let map={}; 
            // DRILL DOWN LOGIC
            if (isDrill && drillCat) {
                document.getElementById('resetBtn').style.display = 'block';
                data.filter(t => t.cat == drillCat).forEach(t => { map[t.desc] = (map[t.desc] || 0) + t.amount; });
            } else {
                if(isDrill) document.getElementById('resetBtn').style.display = 'none';
                data.forEach(t=>{const k=t[key]||'Gral'; map[k]=(map[k]||0)+t.amount;});
            }

            const ent=Object.entries(map).sort((a,b)=>b[1]-a[1]);
            
            setInst(new Chart(cvs, {
                type:'doughnut', 
                data:{labels:ent.map(e=>e[0]), datasets:[{data:ent.map(e=>e[1]), backgroundColor:PALETTE, borderWidth:0, hoverOffset:4}]},
                options:{
                    responsive:true, maintainAspectRatio:false, cutout:'70%', 
                    plugins:{legend:{display:false}},
                    onClick: (e, elements) => {
                        if (isDrill && !drillCat && elements.length > 0) {
                            const i = elements[0].index;
                            drillCat = ent[i][0];
                            loadMonthData();
                        }
                    }
                }
            }));
            leg.innerHTML='';
            ent.forEach((e,i)=>{
                leg.innerHTML+=`<div class="flex justify-between py-1.5 border-b border-dashed border-slate-100 text-[10px] cursor-pointer hover:bg-slate-50" onclick="${isDrill && !drillCat ? `drillCat='${e[0]}';loadMonthData()` : ''}"><div class="flex items-center gap-2"><span class="size-2 rounded-full" style="background:${PALETTE[i%PALETTE.length]}"></span><span class="font-medium text-slate-600">${e[0]}</span></div><span class="font-bold text-slate-800">$${fmt(e[1])}</span></div>`;
            });
        }
        
        function resetCharts() { drillCat = null; loadMonthData(); }

        // --- CHIPS RENDER ---
        function renderChips(type) {
            const container = document.getElementById('catChipsContainer');
            container.innerHTML = '';
            
            const cats = type === 'inc' ? appData.cats.inc : appData.cats.exp;
            
            cats.forEach(c => {
                const chip = document.createElement('div');
                chip.className = `chip text-[10px] px-3 py-1.5 rounded-full font-bold cursor-pointer select-none ${document.getElementById('fCat').value === c ? 'active' : ''}`;
                chip.innerText = c;
                chip.onclick = () => {
                    document.getElementById('fCat').value = c;
                    document.querySelectorAll('#catChipsContainer .chip').forEach(x => x.classList.remove('active'));
                    chip.classList.add('active');
                    renderConceptChips(c);
                };
                container.appendChild(chip);
            });

            // Boton +
            const addBtn = document.createElement('div');
            addBtn.className = "chip text-[10px] px-3 py-1.5 rounded-full font-bold cursor-pointer select-none text-slate-400";
            addBtn.innerText = "+";
            addBtn.onclick = () => {
                const n = prompt("Nueva Categoría:");
                if(n) { 
                    if(type==='exp') appData.cats.exp.push(n); else appData.cats.inc.push(n); 
                    saveData(); renderChips(type); 
                }
            };
            container.appendChild(addBtn);
        }

        function renderConceptChips(cat) {
            const container = document.getElementById('conceptChipsContainer');
            container.innerHTML = '';
            const concepts = appData.concepts[cat] || [];
            
            concepts.forEach(con => {
                const chip = document.createElement('div');
                chip.className = "chip-concept text-slate-500 hover:text-primary";
                chip.innerText = con;
                chip.onclick = () => {
                    document.getElementById('fDesc').value = con;
                };
                container.appendChild(chip);
            });
        }

        // --- MODAL & FORM ---
        function openModal(){ resetForm(); setType('exp'); document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex'); }
        function closeModal(){ document.getElementById('modalOverlay').classList.add('hidden'); document.getElementById('modalOverlay').classList.remove('flex'); }
        
        function setType(t){
            document.getElementById('fType').value=t;
            const e=document.getElementById('btnExp'), i=document.getElementById('btnInc');
            if(t=='exp'){
                e.className="flex-1 py-2 text-xs font-bold rounded-md bg-white text-danger shadow-sm border border-slate-200 transition-all";
                i.className="flex-1 py-2 text-xs font-bold rounded-md text-slate-400 hover:bg-slate-50 transition-all";
                document.getElementById('catRow').classList.remove('hidden'); document.getElementById('linkRow').classList.remove('hidden');
                fillLinkOpts();
            } else {
                i.className="flex-1 py-2 text-xs font-bold rounded-md bg-white text-success shadow-sm border border-slate-200 transition-all";
                e.className="flex-1 py-2 text-xs font-bold rounded-md text-slate-400 hover:bg-slate-50 transition-all";
                document.getElementById('catRow').classList.add('hidden'); document.getElementById('linkRow').classList.add('hidden');
            }
            renderChips(t);
        }

        function editTx(id) {
            const t = appData.txs.find(x => x.id == id); if(!t) return;
            editId = id;
            document.getElementById('mTitle').innerText = 'Editar';
            document.getElementById('btnDel').classList.remove('hidden');
            document.getElementById('fDate').value = t.date;
            document.getElementById('fDesc').value = t.desc;
            document.getElementById('fExec').checked = t.exec;
            document.getElementById('fAmt').value = t.origAmt || t.amount;
            document.getElementById('fCurr').value = t.origCurr || 'ARS';
            setType(t.type);
            
            setTimeout(() => {
                document.getElementById('fCat').value = t.cat;
                const chips = document.querySelectorAll('#catChipsContainer .chip');
                chips.forEach(c => { if(c.innerText == t.cat) c.classList.add('active'); });
                if(t.type === 'exp') { document.getElementById('fLink').value = t.linkId || ""; renderConceptChips(t.cat); }
            }, 50);

            calcConversion();
            document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex');
        }

        function calcConversion() {
            const amt = parseFloat(document.getElementById('fAmt').value) || 0;
            const curr = document.getElementById('fCurr').value;
            const rateARS = parseFloat(document.getElementById('headerRateDisplay').value) || 1200;
            let final = amt;
            
            if (curr === 'USD') final = amt * rateARS;
            if (curr === 'COP') final = (amt / parseFloat(document.getElementById('rate_COP').value)) * rateARS;
            
            document.getElementById('convResult').innerText = `$${fmt(final)} ARS`;
            document.getElementById('convPreview').classList.toggle('hidden', curr === 'ARS');
            return final;
        }

        document.getElementById('txForm').onsubmit=e=>{
            e.preventDefault();
            const type = document.getElementById('fType').value;
            const cat = document.getElementById('fCat').value;
            if(type === 'exp' && !cat) return alert("Selecciona categoría");
            
            const desc = document.getElementById('fDesc').value;
            // Guardar nuevo concepto si no existe
            if(cat) {
                if(!appData.concepts[cat]) appData.concepts[cat] = [];
                if(!appData.concepts[cat].includes(desc)) appData.concepts[cat].push(desc);
            }

            const tx={
                id: editId || Date.now(), 
                date: document.getElementById('fDate').value,
                amount: calcConversion(), origAmt: parseFloat(document.getElementById('fAmt').value), origCurr: document.getElementById('fCurr').value,
                type, cat: type=='exp'?cat:null, desc, 
                exec: document.getElementById('fExec').checked,
                linkId: type=='exp'?document.getElementById('fLink').value:null, deletedAt: null
            };
            if(editId) { const idx = appData.txs.findIndex(x => x.id == editId); if(idx > -1) appData.txs[idx] = tx; } else appData.txs.push(tx);
            saveData(); closeModal();
        }

        // --- UTILS & RATES ---
        function updateHeaderRate() {
            const val = document.getElementById('headerRateDisplay').value;
            document.getElementById('rate_ARS').value = val;
            saveMonthlyRates();
        }
        function saveMonthlyRates() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            appData.monthlyRates[`${y}-${m.toString().padStart(2,'0')}`] = {
                ARS: parseFloat(document.getElementById('rate_ARS').value),
                COP: parseFloat(document.getElementById('rate_COP').value),
                USD: 1
            };
            saveData();
            updateKPIs(appData.txs); // Refresh calculations
        }
        function fillLinkOpts(){
            const s=document.getElementById('fLink'); s.innerHTML='<option value="">-- Sin Asignar --</option>';
            const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
            appData.txs.filter(t=>t.type=='inc' && parseInt(t.date.split('-')[1])==m).forEach(i=>{
                const sp=appData.txs.filter(x=>x.linkId==i.id && x.id != editId).reduce((a,b)=>a+b.amount,0);
                s.add(new Option(`${i.desc} ($${fmt(i.amount-sp)})`, i.id));
            });
        }
        function updateKPIs(txs){
            const i=txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
            const e=txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
            document.getElementById('k-inc').innerText='$'+fmt(i); document.getElementById('k-exp').innerText='$'+fmt(e);
            document.getElementById('k-bal').innerText='$'+fmt(i-e); 
            document.getElementById('k-usd').innerText='USD '+fmt((i-e)/parseFloat(document.getElementById('rate_ARS').value));
        }
        function renderRecurrentesAdmin() {
            const tbody = document.getElementById('recurrente-table-body'); tbody.innerHTML = '';
            appData.recurrentes.forEach((r, i) => {
                const d=document.createElement('div'); d.className='flex gap-2 items-center text-xs border-b border-slate-100 py-2';
                d.innerHTML=`<input value="${r.desc}" onchange="appData.recurrentes[${i}].desc=this.value" class="w-1/3 border-slate-200 rounded p-1"><input type="number" value="${r.amount}" onchange="appData.recurrentes[${i}].amount=parseFloat(this.value)" class="w-1/4 border-slate-200 rounded p-1 text-right"><span class="text-slate-400 text-[10px] w-1/4">${r.cat}</span><button onclick="appData.recurrentes.splice(${i},1);renderRecurrentesAdmin()" class="text-red-500">x</button>`;
                tbody.appendChild(d);
            });
        }
        function addRecurrenteRow() { appData.recurrentes.push({desc:'Nuevo', amount:0, cat:'Esenciales', type:'exp'}); renderRecurrentesAdmin(); }
        function saveRecurrentesConfig() { saveData(); alert('Guardado'); }
        function executeRecurrentes() { loadRecurrentes(); } 
        function loadRecurrentes() {
            const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
            let c=0; appData.recurrentes.forEach(r=>{
                if(!appData.txs.some(t=>!t.deletedAt && t.desc==r.desc && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m)){
                    appData.txs.push({...r, id:Date.now()+Math.random(), date:`${y}-${m.toString().padStart(2,'0')}-01`, exec:false, linkId:null, deletedAt:null, origAmt:r.amount, origCurr:'ARS'}); c++;
                }
            });
            if(c>0){saveData(); alert('Generados: '+c);} else alert('Ya estaban cargados');
        }
        function nav(v, el){ document.querySelectorAll('.view-container').forEach(e=>e.classList.add('hidden-view')); document.getElementById(`view-${v}`).classList.remove('hidden-view'); document.querySelectorAll('#main-nav button').forEach(e=>{ e.classList.remove('active-nav'); e.classList.add('text-slate-500'); }); if(el) { el.classList.add('active-nav'); el.classList.remove('text-slate-500'); } }
        function resetForm(){ document.getElementById('txForm').reset(); document.getElementById('mTitle').innerText='Nuevo'; document.getElementById('btnDel').classList.add('hidden'); document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; document.getElementById('convPreview').classList.add('hidden'); editId=null; }
        function delTx(){ if(confirm('¿Eliminar?')){ appData.txs.find(x=>x.id==editId).deletedAt=Date.now(); saveData(); closeModal(); } }
        function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); updateDateUI(); loadMonthData(); }
        function manualDate(){ const[y,m]=document.getElementById('datePicker').value.split('-'); currentDate.setFullYear(y); currentDate.setMonth(m-1); updateDateUI(); loadMonthData(); }
        function updateDateUI(){ document.getElementById('monthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }
    </script>
</body>
</html>
